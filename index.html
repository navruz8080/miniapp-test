<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop Ecosystem</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        /* --- НАСТРОЙКИ ТЕМЫ (iOS Style) --- */
        :root {
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-main: #000000;
            --text-sec: #8E8E93;
            --accent: #1ae2c7; /* Tiffany */
            --accent-dark: #00b39d;
            --border: rgba(0,0,0,0.08);
            --shadow: 0 4px 12px rgba(0,0,0,0.06);
            --font-main: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        [data-theme="dark"] {
            --bg-body: #000000;
            --bg-card: #1C1C1E;
            --text-main: #FFFFFF;
            --text-sec: #98989F;
            --border: rgba(255,255,255,0.12);
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-body); color: var(--text-main);
            margin: 0; padding: 0 0 110px 0;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.3s, color 0.3s;
        }

        .container { padding: 0 16px; max-width: 600px; margin: 0 auto; }
        
        /* HEADER */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
        h1 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .theme-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); cursor: pointer; border: 1px solid var(--border); }

        /* CARDS */
        .card { background: var(--bg-card); border-radius: 20px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; overflow: hidden; }

        /* UI ELEMENTS */
        .btn-main { background: var(--accent); color: #000; width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }

        input, select { background: var(--bg-body); border: 1px solid transparent; color: var(--text-main); padding: 16px; border-radius: 14px; width: 100%; box-sizing: border-box; font-size: 15px; outline: none; margin-bottom: 10px; font-family: var(--font-main); }
        input:focus { background: var(--bg-card); border-color: var(--accent); }

        /* TOGGLE */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* PROFILE ADDRESS BLOCKS */
        .address-box {
            background: var(--bg-body);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            font-family: var(--font-code);
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-main);
            position: relative;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .address-box:active { transform: scale(0.99); border-color: var(--accent); background: rgba(26, 226, 199, 0.05); }
        .copy-icon { position: absolute; top: 12px; right: 12px; color: var(--accent-dark); opacity: 0.6; }
        .addr-label { font-size: 10px; color: var(--text-sec); text-transform: uppercase; font-family: var(--font-main); margin-bottom: 6px; font-weight: 700; margin-left: 4px; }

        /* TRUCKING TABS */
        .tabs { display: flex; background: var(--bg-body); padding: 4px; border-radius: 14px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; text-align: center; border-radius: 10px; font-size: 13px; font-weight: 600; color: var(--text-sec); cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: var(--bg-card); color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* DOCK */
        .dock-container { position: fixed; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; z-index: 1000; }
        .dock { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 32px; padding: 12px 25px; display: flex; gap: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid var(--border); }
        .dock-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); cursor: pointer; transition: 0.3s; width: 48px; }
        .dock-icon { font-size: 22px; margin-bottom: 4px; }
        .dock-label { font-size: 10px; font-weight: 600; opacity: 0; transform: translateY(5px); transition: 0.3s; }
        .dock-item.active { color: var(--accent-dark); transform: translateY(-3px); }
        .dock-item.active .dock-label { opacity: 1; transform: translateY(0); }
        [data-theme="dark"] .dock { background: rgba(28,28,30,0.95); border-color: rgba(255,255,255,0.1); }
        [data-theme="dark"] .dock-item.active { color: var(--accent); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: flex-end; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; animation: slideUp 0.3s; }
        .modal-box { background: var(--bg-card); width: 100%; border-radius: 24px 24px 0 0; padding: 30px 20px 50px 20px; border-top: 1px solid var(--border); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; font-size: 24px; box-shadow: 0 4px 15px rgba(26, 226, 199, 0.4); cursor: pointer; z-index: 900; }
    </style>
</head>
<body data-theme="light">

    <div class="container">
        <div class="app-header">
            <h1>Drop Eco</h1>
            <div class="theme-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon" id="theme-icon"></i></div>
        </div>
    </div>

    <div id="fab-add" class="fab" style="display: none;" onclick="openModal('add-modal')">
        <i class="fa-solid fa-plus"></i>
    </div>

    <div id="add-modal" class="modal-overlay">
        <div class="modal-box"><h2>Новая посылка</h2><input id="n-track" placeholder="Трек-номер"><input id="n-desc" placeholder="Описание"><button class="btn-main" onclick="submitTrack()">Добавить</button><div style="text-align:center;margin-top:15px;color:var(--text-sec)" onclick="closeModal('add-modal')">Отмена</div></div>
    </div>
    
    <div id="driver-modal" class="modal-overlay">
        <div class="modal-box"><h2>Регистрация водителя</h2><input id="d-car" placeholder="Машина (напр. Porter)"><input id="d-num" placeholder="Гос. номер"><input id="d-w" type="number" placeholder="Грузоподъемность (кг)"><button class="btn-main" onclick="regDriver()">Зарегистрироваться</button><div style="text-align:center;margin-top:15px;color:var(--text-sec)" onclick="closeModal('driver-modal')">Отмена</div></div>
    </div>

    <div id="trip-modal" class="modal-overlay">
        <div class="modal-box"><h2>Новый рейс</h2><input id="t-from" placeholder="Откуда"><input id="t-to" placeholder="Куда"><input id="t-price" type="number" placeholder="Цена за кг (сомони)"><input id="t-desc" placeholder="Комментарий"><button class="btn-main" onclick="createTrip()">Опубликовать</button><div style="text-align:center;margin-top:15px;color:var(--text-sec)" onclick="closeModal('trip-modal')">Отмена</div></div>
    </div>

    <div id="cargo-modal" class="modal-overlay">
        <div class="modal-box">
            <h2>Отправить груз</h2>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input id="c-from" placeholder="Откуда">
                <input id="c-to" placeholder="Куда">
            </div>
            <input id="c-desc" placeholder="Что везем? (напр. Мебель)">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input id="c-weight" type="number" placeholder="Вес (кг)">
                <input id="c-offer" type="number" placeholder="Цена (сом)">
            </div>
            <button class="btn-main" onclick="createCargo()">Разместить заявку</button>
            <div style="text-align:center;margin-top:15px;color:var(--text-sec)" onclick="closeModal('cargo-modal')">Отмена</div>
        </div>
    </div>

    <div id="screen-profile" class="screen active">
        <div class="container">
            <div class="card" style="text-align: center;">
                <img id="u-ava" style="width:70px;height:70px;border-radius:50%;margin-bottom:10px;background:#eee;object-fit:cover;" src="">
                <h2 id="u-name" style="margin:0;">User</h2>
                <div id="u-id" style="color:var(--text-sec);font-size:12px;">ID: ...</div>
                
                <div style="margin-top:15px; padding:10px; background:var(--bg-body); border-radius:12px;">
                    <div style="font-size:11px;color:var(--text-sec);">Ваш ПВЗ (согласно БД)</div>
                    <div id="u-pvz" style="font-weight:700; margin-top:4px;">...</div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <b class="toggle-label">Режим ОПТ</b>
                    <label class="switch">
                        <input type="checkbox" id="mode-toggle" onchange="toggleMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="mode-desc" style="font-size:12px;color:var(--text-sec);">Включить адрес для оптовых грузов</div>
                
                <select id="city-select" onchange="renderAddress()" style="display:none; margin-top:10px;"><option value="yiwu">Иу</option><option value="urumqi">Урумчи</option></select>
            </div>

            <div class="card">
                <div style="margin-bottom:15px; font-weight:700;">Адрес для заказов</div>
                
                <div class="addr-label">ШАГ 1. АДРЕС СКЛАДА</div>
                <div class="address-box" onclick="copyText('addr-text')">
                    <i class="fa-regular fa-copy copy-icon"></i>
                    <div id="addr-text">Загрузка...</div>
                </div>

                <div class="addr-label">ШАГ 2. ВАШ КОД</div>
                <div class="address-box" onclick="copyText('code-text')">
                    <i class="fa-regular fa-copy copy-icon"></i>
                    <div id="code-text">C-87/...</div>
                </div>
            </div>
            
            <div class="card" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                <div>
                    <div style="font-size: 20px; font-weight: 700;" id="stat-bonus">0.0</div>
                    <div style="font-size: 10px; color: var(--text-sec); text-transform: uppercase;">Бонусы (кг)</div>
                </div>
                <div>
                    <div style="font-size: 20px; font-weight: 700;" id="stat-count">0</div>
                    <div style="font-size: 10px; color: var(--text-sec); text-transform: uppercase;">Заказов</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-pkgs" class="screen">
        <div class="container">
            <h2 style="margin-bottom: 15px;">Мои посылки</h2>
            <div id="pkg-list">
                <div style="text-align: center; padding: 40px; color: var(--text-sec);">Загрузка...</div>
            </div>
        </div>
    </div>

    <div id="screen-trucks" class="screen">
        <div class="container">
            <div class="card">
                <h2 style="margin-top:0;">Биржа</h2>
                <div class="tabs">
                    <div id="tab-trips" class="tab-btn active" onclick="switchTruckTab('trips')">Ищу машину</div>
                    <div id="tab-cargo" class="tab-btn" onclick="switchTruckTab('cargo')">Ищу груз</div>
                </div>
                
                <button id="btn-create-cargo" class="btn-main" onclick="openModal('cargo-modal')">➕ Добавить груз</button>
                <button id="btn-create-trip" class="btn-main" onclick="handleDriverAction()" style="display:none; background:transparent; border:1px solid var(--accent); color:var(--text-main);">Я водитель</button>
            </div>

            <div id="exchange-list">
                </div>
        </div>
    </div>

    <div id="screen-calc" class="screen">
        <div class="container">
            <div class="card">
                <h2>Калькулятор</h2>
                <div id="calc-route-box" style="display:none;">
                    <select id="calc-route"><option>Маршрут...</option></select>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><input id="c-l" placeholder="Дл"><input id="c-w" placeholder="Шир"><input id="c-h" placeholder="Выс"></div>
                </div>
                <input id="c-wg" placeholder="Вес (кг)"><input id="c-qt" placeholder="Кол-во" value="1">
                <div id="c-res" style="text-align:center;font-size:20px;font-weight:800;margin:15px 0;color:var(--accent-dark);"></div>
                <button class="btn-main" onclick="doCalc()">Считать</button>
            </div>
        </div>
    </div>

    <div class="dock-container">
        <div class="dock">
            <div class="dock-item active" onclick="nav('profile', this)">
                <i class="dock-icon fa-regular fa-id-card"></i>
                <div class="dock-label">Профиль</div>
            </div>
            <div class="dock-item" onclick="nav('pkgs', this)">
                <i class="dock-icon fa-solid fa-box"></i>
                <div class="dock-label">Посылки</div>
            </div>
            <div class="dock-item" onclick="nav('trucks', this)">
                <i class="dock-icon fa-solid fa-truck-fast"></i>
                <div class="dock-label">Биржа</div>
            </div>
            <div class="dock-item" onclick="nav('calc', this)">
                <i class="dock-icon fa-solid fa-calculator"></i>
                <div class="dock-label">Расчет</div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        
        // ⚠️⚠️⚠️ СЮДА ВАШУ ССЫЛКУ NGROK ⚠️⚠️⚠️
        const API = "https://unforeshortened-interartistic-judith.ngrok-free.dev"; 
        
        const uid = tg.initDataUnsafe?.user?.id || 317295540;
        
        let config = {}, user = {}, isOpt = false, exchangeTab = 'trips', isDriver = false;

        async function init() {
            document.getElementById('u-ava').src = tg.initDataUnsafe?.user?.photo_url || "";
            // Load dashboard
            try {
                let res = await fetch(`${API}/api/dashboard/${uid}`, {headers:{'ngrok-skip-browser-warning':'true'}});
                let data = await res.json();
                config = data.app_config; user = data.user_info; 
                
                // Set UI Profile
                document.getElementById('u-name').innerText = user.name || (tg.initDataUnsafe?.user?.first_name) || "Client";
                document.getElementById('u-id').innerText = `ID: ${uid}`;
                document.getElementById('u-pvz').innerText = user.pvz; 
                document.getElementById('code-text').innerText = user.marking_code;
                document.getElementById('stat-bonus').innerText = user.bonus_balance;
                document.getElementById('stat-count').innerText = data.packages.length;
                
                // Packages List
                let pl = document.getElementById('pkg-list'); pl.innerHTML = '';
                if(data.packages.length === 0) pl.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-sec)">Список пуст</div>';
                data.packages.forEach(p => pl.innerHTML += `<div class="card" style="padding:15px; margin-bottom:10px;"><div style="font-weight:700">${p.description||'Посылка'}</div><div style="font-size:12px;color:var(--text-sec)">${p.track_number} • ${p.status_text}</div></div>`);

                // Routes
                let rRes = await fetch(`${API}/api/get_routes`); let rData = await rRes.json();
                let sel = document.getElementById('calc-route');
                rData.routes?.forEach(r => { let o = document.createElement('option'); o.value=r; o.innerText=r; sel.appendChild(o); });

                // Init State
                isOpt = (user.category === 'more_100');
                document.getElementById('mode-toggle').checked = isOpt;
                toggleMode(); // Update UI based on state

                checkDriver();
                loadExchange();
            } catch(e) { console.error(e); }
        }

        // --- PROFILE LOGIC ---
        function toggleMode() {
            isOpt = document.getElementById('mode-toggle').checked;
            document.getElementById('city-select').style.display = isOpt ? 'block' : 'none';
            document.getElementById('calc-opt-fields').style.display = isOpt ? 'block' : 'none';
            document.getElementById('mode-desc').innerText = isOpt ? "Включен режим ОПТ (>100кг)" : "Включен режим РОЗНИЦА";
            
            // Save settings
            fetch(`${API}/api/update_settings`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ user_id: uid, category: isOpt?'more_100':'less_100' }) });
            
            renderAddress();
        }

        function renderAddress() {
            let txt = document.getElementById('addr-text');
            if(!isOpt) {
                // Retail
                txt.innerText = config.warehouses?.retail?.address || "Загрузка...";
            } else {
                // Wholesale
                let city = document.getElementById('city-select').value;
                txt.innerText = config.warehouses?.wholesale?.[city]?.address || "Адрес не найден";
            }
        }

        function copyText(id) {
            navigator.clipboard.writeText(document.getElementById(id).innerText);
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert("Скопировано!");
        }

        // --- EXCHANGE LOGIC ---
        function switchTruckTab(tab) {
            exchangeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab === 'trips' ? 'tab-trips' : 'tab-cargo').classList.add('active');
            
            // Toggle Buttons
            document.getElementById('btn-create-cargo').style.display = (tab === 'trips') ? 'none' : 'block';
            document.getElementById('btn-create-trip').style.display = (tab === 'trips') ? 'block' : 'none';
            
            loadExchange();
        }

        async function loadExchange() {
            let cont = document.getElementById('exchange-list'); cont.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-sec)">Загрузка...</div>';
            try {
                let res = await fetch(`${API}/api/trucking/list?type=${exchangeTab}`);
                let data = await res.json();
                cont.innerHTML = '';
                if(!data.items?.length) { cont.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-sec)">Пока ничего нет</div>'; return; }
                
                data.items.forEach(i => {
                    let borderCol = i.type === 'trip' ? '#1ae2c7' : '#00b39d';
                    cont.innerHTML += `
                    <div class="card" style="border-left:4px solid ${borderCol}; padding:15px; margin-bottom:10px;">
                        <div style="font-weight:700;font-size:16px;">${i.title}</div>
                        <div style="font-size:13px;color:var(--text-sec);margin-top:4px;">${i.subtitle}</div>
                        <div style="display:flex;justify-content:space-between;margin-top:10px;font-weight:700;">
                            <span style="color:${borderCol}">${i.details}</span>
                            <span style="font-size:11px;background:var(--bg-body);padding:4px 8px;border-radius:6px;">${i.extra}</span>
                        </div>
                    </div>`;
                });
            } catch(e) {}
        }

        async function checkDriver() {
            let res = await fetch(`${API}/api/trucking/status/${uid}`);
            let d = await res.json(); isDriver = d.is_driver;
            let btn = document.getElementById('btn-create-trip');
            btn.innerText = isDriver ? "➕ Создать рейс" : "Стать водителем";
        }

        function handleDriverAction() {
            if(isDriver) openModal('trip-modal'); else openModal('driver-modal');
        }

        async function regDriver() {
            let car=gid('d-car').value, num=gid('d-num').value, w=gid('d-w').value;
            let res = await fetch(`${API}/api/trucking/register`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:uid, car_model:car, car_number:num, max_weight_kg:parseFloat(w)})});
            let d = await res.json();
            if(d.status==='ok') { closeModal('driver-modal'); checkDriver(); tg.showAlert("Вы водитель!"); } else tg.showAlert(d.message);
        }

        async function createTrip() {
            let f=gid('t-from').value, t=gid('t-to').value, p=gid('t-price').value;
            let res = await fetch(`${API}/api/trucking/create_trip`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:uid, city_from:f, city_to:t, date:"Скоро", price_per_kg:parseFloat(p), description:"..."})});
            if((await res.json()).status==='ok') { closeModal('trip-modal'); loadExchange(); tg.showAlert("Рейс создан!"); }
        }

        async function createCargo() {
            let f=gid('c-from'), t=gid('c-to'), d=gid('c-desc'), w=gid('c-weight'), p=gid('c-offer');
            let res = await fetch(`${API}/api/trucking/create_cargo`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:uid, city_from:f.value, city_to:t.value, description:d.value, weight:parseFloat(w.value), price_offer:parseFloat(p.value)})});
            if((await res.json()).status==='ok') { closeModal('cargo-modal'); loadExchange(); tg.showAlert("Груз добавлен!"); }
        }

        // --- UTILS ---
        function gid(id){return document.getElementById(id)}
        function nav(s,e){ 
            document.querySelectorAll('.dock-item').forEach(i=>i.classList.remove('active')); e.classList.add('active');
            document.querySelectorAll('.screen').forEach(sc=>sc.classList.remove('active')); document.getElementById('screen-'+s).classList.add('active');
            // FAB logic
            if(s==='pkgs') gid('fab-add').style.display='flex'; else gid('fab-add').style.display='none';
        }
        function toggleTheme(){ document.body.dataset.theme = document.body.dataset.theme==='light'?'dark':'light'; }
        function openModal(id){ gid(id).classList.add('active'); tg.HapticFeedback.impactOccurred('medium'); }
        function closeModal(id){ gid(id).classList.remove('active'); }
        
        async function doCalc() {
            let route = gid('calc-route').value;
            let w = parseFloat(gid('c-wg').value)||0;
            let q = parseInt(gid('c-qt').value)||1;
            
            let payload = {user_id:uid, category: isOpt?'more_100':'less_100', weight_per_item:w, quantity:q};
            if(isOpt) {
                let parts = route.split(' - ');
                if(parts.length<2) return tg.showAlert("Выберите маршрут!");
                payload.route_from = parts[0]; payload.route_to = parts[1];
                payload.length = parseFloat(gid('c-l').value)||0;
                payload.width = parseFloat(gid('c-w').value)||0;
                payload.height = parseFloat(gid('c-h').value)||0;
            }
            try {
                let res = await fetch(`${API}/api/calculate`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
                let d = await res.json();
                gid('c-res').innerText = d.status==='ok' ? `${d.price.toFixed(2)} ${d.currency}` : d.message;
            } catch(e){ tg.showAlert("Ошибка"); }
        }
        
        async function submitTrack() {
            let t = gid('n-track').value, d = gid('n-desc').value;
            if(!t) return tg.showAlert("Трек?");
            let res = await fetch(`${API}/api/add_track`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:uid, track_number:t, description:d})});
            if((await res.json()).status==='ok') { closeModal('add-modal'); init(); tg.showAlert("Добавлено!"); }
        }

        init();
    </script>
</body>
</html>
