<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Drop SuperApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body{margin:0;font-family:Inter,Arial;background:#f2f3f5}
.screen{display:none}
.screen.active{display:block}
.card{background:#fff;margin:12px;padding:14px;border-radius:14px}
.btn{padding:12px;border-radius:12px;border:none;background:#007AFF;color:#fff;width:100%}
</style>
</head>
<body>

<div id="screen-home" class="screen active">
    <div class="card"><b>Мои посылки</b></div>
    <div id="home-pkg-list"></div>
</div>

<div id="screen-package" class="screen">
    <div class="card"><button onclick="nav('home')">← Назад</button></div>
    <div class="card">
        <b id="pkg-title"></b>
        <div id="pkg-status" style="color:#888"></div>
    </div>
    <div id="pkg-history"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API = "http://localhost:8000";
const uid = tg.initDataUnsafe?.user?.id || 1;

function gid(id){return document.getElementById(id)}

function nav(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    gid('screen-'+id).classList.add('active');
}

async function init(){
    let r = await fetch(`${API}/api/dashboard/${uid}`);
    let d = await r.json();
    let h = '';
    d.packages.forEach(p=>{
        h += `<div class="card" onclick="openPkg('${p.track_number}')">
                <b>${p.description||'Без описания'}</b><br>
                <small>${p.track_number} • ${p.status_text}</small>
              </div>`;
    });
    gid('home-pkg-list').innerHTML = h || '<div class="card">Нет посылок</div>';
}

async function openPkg(track){
    let r = await fetch(`${API}/api/package/${track}`);
    let d = await r.json();
    gid('pkg-title').innerText = d.package.track_number;
    gid('pkg-status').innerText = d.package.status;
    let h='';
    if(d.history.length===0) h='<div class="card">Истории нет</div>';
    d.history.forEach(s=>{
        h+=`<div class="card"><b>${s.status}</b><br><small>${new Date(s.timestamp).toLocaleString()}</small></div>`;
    });
    gid('pkg-history').innerHTML=h;
    nav('package');
}

init();
</script>
</body>
</html>
