<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop Logistics</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-dark: #0b0f19; 
            --card-glass: rgba(30, 36, 50, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
            --neon: #23F7DD; /* xPortal Cyan */
            --neon-glow: rgba(35, 247, 221, 0.3);
            --text-main: #ffffff; 
            --text-gray: #8a93a0;
            --danger: #ff4b55;
            --gold: #F7B500;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark); 
            background-image: radial-gradient(circle at 50% 0%, rgba(35, 247, 221, 0.15) 0%, transparent 50%);
            color: var(--text-main); 
            margin: 0; padding: 0 0 110px 0; 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden; 
            min-height: 100vh;
        }
        
        /* SCROLLBAR HIDE */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* --- LOADER --- */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s ease; }
        .logo-circle {
            width: 80px; height: 80px; border-radius: 50%;
            border: 2px solid var(--neon);
            box-shadow: 0 0 30px var(--neon-glow);
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; color: var(--neon);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--neon-glow); } 70% { box-shadow: 0 0 30px 10px rgba(35, 247, 221, 0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

        /* --- LAYOUT --- */
        .container { padding: 0 20px; }
        .screen { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .screen.active { display: block; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- CARDS (GLASSMORPHISM) --- */
        .card { 
            background: var(--card-glass); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px; 
            padding: 20px; 
            margin-bottom: 16px; 
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        /* Neon Border Accent */
        .card-accent { border: 1px solid var(--neon); box-shadow: 0 0 15px rgba(35, 247, 221, 0.15); }

        /* --- TYPOGRAPHY --- */
        h1 { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
        h2 { font-size: 20px; font-weight: 700; margin: 0; }
        .text-neon { color: var(--neon); }
        .text-dim { color: var(--text-gray); font-size: 13px; font-weight: 500; }

        /* --- HEADER --- */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 30px 0; }
        .refresh-btn { width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; color: var(--neon); cursor: pointer; border: 1px solid var(--card-border); }

        /* --- INPUTS & FORMS --- */
        input, select { 
            background: rgba(0,0,0,0.3); 
            border: 1px solid var(--card-border); 
            color: white; 
            padding: 16px; 
            border-radius: 16px; 
            width: 100%; 
            box-sizing: border-box; 
            outline: none; 
            font-size: 15px; 
            font-family: 'Inter', sans-serif;
            transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--neon); box-shadow: 0 0 10px var(--neon-glow); }

        /* --- BUTTONS --- */
        .btn-main {
            background: var(--neon);
            color: #000;
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: none;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px var(--neon-glow);
            transition: transform 0.2s;
        }
        .btn-main:active { transform: scale(0.97); }

        /* --- SWITCHER --- */
        .switcher { display: flex; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 18px; margin-bottom: 20px; }
        .sw-btn { flex: 1; padding: 12px; border: none; border-radius: 14px; background: transparent; color: var(--text-gray); font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.3s; }
        .sw-btn.active { background: rgba(35, 247, 221, 0.15); color: var(--neon); border: 1px solid rgba(35, 247, 221, 0.2); }

        /* --- BOTTOM NAV (FLOATING) --- */
        .nav-bar { 
            position: fixed; bottom: 20px; left: 20px; right: 20px; 
            background: rgba(20, 25, 35, 0.85); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px; 
            display: flex; padding: 15px 0; 
            z-index: 1000; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .nav-item { flex: 1; text-align: center; color: var(--text-gray); text-decoration: none; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--neon); transform: translateY(-2px); text-shadow: 0 0 10px var(--neon-glow); }

        /* --- PROFILE SPECIFIC --- */
        .profile-hero { text-align: center; margin-bottom: 30px; }
        .avatar-box { 
            width: 100px; height: 100px; margin: 0 auto 15px; position: relative; 
            border-radius: 50%; padding: 4px;
            background: linear-gradient(135deg, var(--card-border), var(--neon));
        }
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--bg-dark); object-fit: cover; }
        .rank-badge { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); background: #000; border: 1px solid var(--neon); color: var(--neon); font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        
        .balance-hero { font-size: 42px; font-weight: 800; color: white; margin-bottom: 5px; letter-spacing: -1px; }
        .balance-label { color: var(--text-gray); font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.03); border-radius: 18px; padding: 15px; text-align: center; }

        /* --- PARCELS --- */
        .parcel-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .parcel-item:last-child { border-bottom: none; }
        .parcel-icon { width: 40px; height: 40px; border-radius: 12px; background: rgba(35, 247, 221, 0.1); color: var(--neon); display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 15px; }
        .status-pill { padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .st-active { background: rgba(35, 247, 221, 0.15); color: var(--neon); }
        .st-wait { background: rgba(255, 255, 255, 0.1); color: #aaa; }

        /* --- MODAL --- */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; background: var(--neon); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: black; font-size: 24px; box-shadow: 0 0 20px var(--neon-glow); cursor: pointer; z-index: 900; transition: transform 0.2s; transform: rotate(45deg); }
        .fab i { transform: rotate(-45deg); } /* Icon fix */
        .fab:active { transform: scale(0.95) rotate(45deg); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: flex-end; backdrop-filter: blur(10px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .modal-box { background: #151a25; width: 100%; border-radius: 30px 30px 0 0; padding: 30px 20px 50px 20px; border-top: 1px solid var(--neon); position: relative; animation: slideUpModal 0.3s; }
        @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* COPY ADDRESS STYLES */
        .addr-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            cursor: pointer;
            transition: 0.2s;
        }
        .addr-card:active { border-color: var(--neon); background: rgba(35, 247, 221, 0.05); }
        .addr-card .label { font-size: 10px; color: var(--neon); font-weight: 800; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
        .addr-card .text { font-family: monospace; font-size: 13px; line-height: 1.6; color: #ddd; }
        .addr-card .icon { position: absolute; right: 20px; top: 20px; color: var(--neon); opacity: 0.5; }

    </style>
</head>
<body>

    <div id="loader">
        <div class="logo-circle"><i class="fa-solid fa-box"></i></div>
        <div style="margin-top: 20px; color: white; font-weight: 600; font-size: 18px; letter-spacing: 2px;">DROP</div>
        <div id="error-log" style="color: #ff4b55; margin-top: 20px; font-size: 12px; text-align: center; opacity: 0.7;"></div>
    </div>

    <div id="add-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="margin-bottom: 20px; text-align: center;">–ù–æ–≤–∞—è –ø–æ—Å—ã–ª–∫–∞</h2>
            <input type="text" id="new-track" placeholder="–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä (–Ω–∞–ø—Ä. YT12345)" style="margin-bottom: 12px;">
            <input type="text" id="new-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ß–∞—Å—ã)" style="margin-bottom: 25px;">
            <button class="btn-main" onclick="submitTrack()">–î–û–ë–ê–í–ò–¢–¨ –¢–†–ï–ö</button>
            <div style="text-align: center; margin-top: 20px; color: var(--text-gray); font-size: 14px;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</div>
        </div>
    </div>

    <div id="fab-add" class="fab" style="display: none;" onclick="openModal()">
        <i class="fa-solid fa-plus"></i>
    </div>

    <div id="screen-home" class="screen">
        <div class="container">
            <div class="header-row">
                <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
                <div class="refresh-btn" onclick="location.reload()"><i class="fa-solid fa-arrows-rotate"></i></div>
            </div>

            <div class="switcher">
                <button id="cat-less" class="sw-btn active" onclick="setCat('less_100')">–†–æ–∑–Ω–∏—Ü–∞</button>
                <button id="cat-more" class="sw-btn" onclick="setCat('more_100')">–û–ø—Ç (>100–∫–≥)</button>
            </div>

            <div class="card card-accent">
                <div id="calc-route-box" style="margin-bottom: 15px; display: none;">
                    <div class="text-dim" style="margin-bottom: 5px;">–ú–∞—Ä—à—Ä—É—Ç –¥–æ—Å—Ç–∞–≤–∫–∏</div>
                    <select id="calc-route"><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="opt-only" style="display:none">
                        <input type="number" id="c-l" placeholder="–î–ª–∏–Ω–∞">
                    </div>
                    <div class="opt-only" style="display:none">
                        <input type="number" id="c-w" placeholder="–®–∏—Ä–∏–Ω–∞">
                    </div>
                    <div class="opt-only" style="display:none">
                        <input type="number" id="c-h" placeholder="–í—ã—Å–æ—Ç–∞">
                    </div>
                    
                    <div style="grid-column: span 2;">
                        <input type="number" id="c-weight" placeholder="–í–µ—Å 1 –º–µ—Å—Ç–∞ (–∫–≥)" style="border-color: var(--card-border);">
                    </div>
                    <div style="grid-column: span 2;">
                        <input type="number" id="c-qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç" value="1">
                    </div>
                </div>

                <div id="retail-info" style="margin-top: 15px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; font-size: 12px; color: var(--text-gray); line-height: 1.6;">
                    <div style="display:flex; justify-content:space-between;"><span>–¥–æ 0.5 –∫–≥</span> <span class="text-neon">13 TJS</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>0.5 - 1 –∫–≥</span> <span class="text-neon">23 TJS</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>1 - 50 –∫–≥</span> <span class="text-neon">23 TJS/–∫–≥</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>> 50 –∫–≥</span> <span class="text-neon">20 TJS/–∫–≥</span></div>
                </div>

                <div id="calc-result-box" style="display: none; margin-top: 20px; text-align: center;">
                    <div class="text-dim">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                    <div style="font-size: 32px; font-weight: 800; color: var(--neon); text-shadow: 0 0 20px var(--neon-glow);">
                        <span id="res-price">0.00</span> <span id="res-currency" style="font-size: 16px;">USD</span>
                    </div>
                </div>

                <button class="btn-main" style="margin-top: 20px;" onclick="calculateServer()">–†–ê–°–°–ß–ò–¢–ê–¢–¨</button>
            </div>
        </div>
    </div>

    <div id="screen-pkgs" class="screen">
        <div class="container">
            <div class="header-row">
                <h1>–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</h1>
                <div class="refresh-btn" onclick="init()"><i class="fa-solid fa-sync"></i></div>
            </div>

            <div id="orders-container" class="card" style="min-height: 200px;">
                <div style="text-align: center; color: var(--text-gray); padding-top: 60px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="container" style="padding-top: 20px;">
            
            <div class="profile-hero">
                <div class="avatar-box">
                    <img id="user-avatar" src="" class="avatar-img" alt="Avatar">
                    <div id="level-badge" class="rank-badge">START</div>
                </div>
                <div id="user-name" style="font-size: 18px; font-weight: 700; margin-bottom: 2px;">Name</div>
                <div id="user-id" class="text-dim">ID: ...</div>
            </div>

            <div class="stat-grid">
                <div class="stat-box">
                    <div class="text-dim">–ë–æ–Ω—É—Å—ã (–ö–ì)</div>
                    <div id="stat-weight" style="font-size: 24px; font-weight: 800; color: white;">0.0</div>
                </div>
                <div class="stat-box">
                    <div class="text-dim">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                    <div id="stat-orders" style="font-size: 24px; font-weight: 800; color: white;">0</div>
                </div>
            </div>

            <h2 style="margin-bottom: 15px; font-size: 16px; color: var(--text-gray); text-transform: uppercase; letter-spacing: 1px;">–ê–¥—Ä–µ—Å–∞ —Å–∫–ª–∞–¥–æ–≤</h2>

            <div id="retail-block">
                <div class="addr-card" onclick="copyRetailAddr()">
                    <div class="label">üá®üá≥ –ò–£ (–†–û–ó–ù–ò–¶–ê)</div>
                    <div class="text" id="yiwu-retail-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="icon"><i class="fa-regular fa-copy"></i></div>
                </div>
                <div style="height: 10px;"></div>
                <div class="addr-card" style="border-color: var(--neon);" onclick="copyMarking()">
                    <div class="label" style="color:white">üîñ –í–ê–® –ö–û–î (–ú–ê–†–ö–ò–†–û–í–ö–ê)</div>
                    <div class="text" id="marking-text" style="font-size: 16px; font-weight: bold; color: var(--neon);">C-87...</div>
                    <div class="icon"><i class="fa-regular fa-copy"></i></div>
                </div>
            </div>

            <div id="wholesale-block" style="display: none;">
                <div style="margin-bottom: 10px;">
                    <select id="origin-city-select" onchange="renderWholesaleAddress()">
                        <option value="yiwu">üá®üá≥ –ò—É (Yiwu)</option>
                        <option value="urumqi">üá®üá≥ –£—Ä—É–º—á–∏ (Urumqi)</option>
                        <option value="guangzhou">üá®üá≥ –ì—É–∞–Ω—á–∂–æ—É</option>
                    </select>
                </div>
                <div class="addr-card" onclick="copyWholesaleAddr()">
                    <div class="label">üöõ –ê–î–†–ï–° –î–õ–Ø –û–ü–¢–ê</div>
                    <div class="text" id="wholesale-addr-text">--</div>
                    <div class="icon"><i class="fa-regular fa-copy"></i></div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 15px; margin-bottom: 40px;">
                <span class="text-neon" style="font-size: 12px; font-weight: 600; cursor: pointer; border-bottom: 1px dashed var(--neon);" onclick="toggleAddressType()">
                    –ü–æ–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å –¥–ª—è <span id="addr-switch-text">–û–ø—Ç–∞</span>
                </span>
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="text-dim">–í–∞—à –ü–í–ó</div>
                <div id="profile-pvz" style="color: white; margin-top: 5px;">...</div>
            </div>

        </div>
    </div>

    <nav class="nav-bar">
        <a href="javascript:void(0)" class="nav-item active" id="nav-home" onclick="nav('home')">
            <i class="fa-solid fa-calculator"></i><span>–†–∞—Å—á–µ—Ç</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" id="nav-pkgs" onclick="nav('pkgs')">
            <i class="fa-solid fa-cube"></i><span>–ü–æ—Å—ã–ª–∫–∏</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" id="nav-profile" onclick="nav('profile')">
            <i class="fa-regular fa-id-card"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –í–ê–® NGROK –ó–î–ï–°–¨ ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        const API_BASE = "https://unforeshortened-interartistic-judith.ngrok-free.dev"; 
        
        const userId = tg.initDataUnsafe?.user?.id || 317295540; 
        const userPhoto = tg.initDataUnsafe?.user?.photo_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        
        let APP_CONFIG = { rates: {}, warehouses: { retail: {}, wholesale: {} } };
        let userData = { category: 'less_100', pvz: '...', bonus: 0, packages: [], marking: '...', name: 'User' };
        let showWholesaleAddr = false;

        async function init() {
            document.getElementById('user-avatar').src = userPhoto;
            loadRoutes();

            try {
                const response = await fetch(`${API_BASE}/api/dashboard/${userId}`, { method: 'GET', headers: { 'ngrok-skip-browser-warning': 'true' } });
                const data = await response.json();

                if (data.app_config) APP_CONFIG = data.app_config;
                if (data.user_info) {
                    userData = {
                        category: data.user_info.category,
                        pvz: data.user_info.pvz,
                        bonus: data.user_info.bonus_balance,
                        marking: data.user_info.marking_code,
                        packages: data.packages || [],
                        name: tg.initDataUnsafe?.user?.first_name || "–ö–ª–∏–µ–Ω—Ç"
                    };
                }
                render();
                setTimeout(() => { document.getElementById('loader').style.opacity = '0'; setTimeout(() => document.getElementById('loader').style.display = 'none', 300); document.getElementById('screen-home').classList.add('active'); }, 600);
            } catch (e) { document.getElementById('error-log').innerHTML = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏"; }
        }

        async function loadRoutes() {
            try {
                const res = await fetch(`${API_BASE}/api/get_routes`, {headers: { 'ngrok-skip-browser-warning': 'true' }});
                const data = await res.json();
                if(data.status === 'ok') {
                    const select = document.getElementById('calc-route');
                    select.innerHTML = '<option>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...</option>';
                    data.routes.forEach(r => {
                        const opt = document.createElement('option'); opt.value = r; opt.innerText = r; select.appendChild(opt);
                    });
                }
            } catch(e) {}
        }

        function render() {
            // PROFILE
            document.getElementById('user-name').innerText = userData.name;
            document.getElementById('user-id').innerText = `ID: ${userId}`;
            document.getElementById('marking-text').innerText = userData.marking;
            document.getElementById('profile-pvz').innerText = userData.pvz;
            
            document.getElementById('stat-orders').innerText = userData.packages.length;
            document.getElementById('stat-weight').innerText = userData.bonus;
            
            let rank = "IRON";
            if(userData.bonus > 10) rank = "BRONZE";
            if(userData.bonus > 100) rank = "GOLD";
            if(userData.bonus > 500) rank = "PLATINUM";
            document.getElementById('level-badge').innerText = rank;

            renderAddressBlock();

            // CALC
            const isOpt = userData.category === 'more_100';
            document.getElementById('cat-less').classList.toggle('active', !isOpt);
            document.getElementById('cat-more').classList.toggle('active', isOpt);
            document.getElementById('calc-route-box').style.display = isOpt ? 'block' : 'none';
            document.getElementById('retail-info').style.display = isOpt ? 'none' : 'block';
            document.querySelectorAll('.opt-only').forEach(el => el.style.display = isOpt ? 'block' : 'none');

            // PACKAGES
            const cont = document.getElementById('orders-container');
            cont.innerHTML = '';
            if(!userData.packages.length) {
                cont.innerHTML = '<div style="text-align:center;color:#555;padding-top:20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            } else {
                userData.packages.forEach(p => {
                    let stClass = 'st-wait';
                    if(p.status_text.includes('–ü—Ä–∏–±—ã–ª') || p.status_text.includes('–ì–æ—Ç–æ–≤')) stClass = 'st-active';
                    
                    cont.innerHTML += `
                        <div class="parcel-item">
                            <div style="display:flex; align-items:center;">
                                <div class="parcel-icon"><i class="fa-solid fa-box-open"></i></div>
                                <div>
                                    <div style="font-weight:700; color:white; font-size:15px;">${p.description || '–ü–æ—Å—ã–ª–∫–∞'}</div>
                                    <div class="text-dim" style="font-family:monospace; margin-top:2px;">${p.track_number}</div>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div class="status-pill ${stClass}">${p.status_text}</div>
                                <div class="text-dim" style="font-size:10px; margin-top:4px;">${p.date}</div>
                            </div>
                        </div>`;
                });
            }
        }

        function toggleAddressType() {
            showWholesaleAddr = !showWholesaleAddr;
            document.getElementById('addr-switch-text').innerText = showWholesaleAddr ? "–†–æ–∑–Ω–∏—Ü—ã" : "–û–ø—Ç–∞";
            renderAddressBlock();
        }

        function renderAddressBlock() {
            const retailDiv = document.getElementById('retail-block');
            const wholesaleDiv = document.getElementById('wholesale-block');
            if(showWholesaleAddr) {
                retailDiv.style.display = 'none'; wholesaleDiv.style.display = 'block'; renderWholesaleAddress();
            } else {
                retailDiv.style.display = 'block'; wholesaleDiv.style.display = 'none';
                document.getElementById('yiwu-retail-text').innerText = APP_CONFIG.warehouses.retail?.address || "...";
            }
        }

        function renderWholesaleAddress() {
            const city = document.getElementById('origin-city-select').value;
            const wh = APP_CONFIG.warehouses.wholesale?.[city];
            document.getElementById('wholesale-addr-text').innerText = wh ? wh.address : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
        }

        async function calculateServer() {
            const btn = document.querySelector('button[onclick="calculateServer()"]');
            const resBox = document.getElementById('calc-result-box');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true;

            const payload = {
                user_id: userId, category: userData.category,
                weight_per_item: parseFloat(document.getElementById('c-weight').value) || 0,
                quantity: parseInt(document.getElementById('c-qty').value) || 1
            };

            if (userData.category === 'more_100') {
                const routeFull = document.getElementById('calc-route').value;
                const parts = routeFull.split(" - ");
                if (parts.length < 2) { tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç!"); btn.innerText = "–†–ê–°–°–ß–ò–¢–ê–¢–¨"; btn.disabled = false; return; }
                payload.route_from = parts[0]; payload.route_to = parts[1];
                payload.length = parseFloat(document.getElementById('c-l').value) || 0;
                payload.width = parseFloat(document.getElementById('c-w').value) || 0;
                payload.height = parseFloat(document.getElementById('c-h').value) || 0;
            }

            try {
                const response = await fetch(`${API_BASE}/api/calculate`, { method: 'POST', headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'}, body: JSON.stringify(payload) });
                const result = await response.json();
                if(result.status === 'ok') {
                    document.getElementById('res-price').innerText = result.price.toFixed(2);
                    document.getElementById('res-currency').innerText = result.currency;
                    resBox.style.display = 'block';
                    tg.HapticFeedback.notificationOccurred('success');
                } else { tg.showAlert(result.message); resBox.style.display = 'none'; }
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); } 
            finally { btn.innerText = "–†–ê–°–°–ß–ò–¢–ê–¢–¨"; btn.disabled = false; }
        }

        async function setCat(cat) {
            tg.HapticFeedback.selectionChanged();
            userData.category = cat; render();
            fetch(`${API_BASE}/api/update_settings`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: userId, category: cat }) });
        }

        function nav(scr) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + scr).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-' + scr).classList.add('active');
            tg.HapticFeedback.impactOccurred('light');
            document.getElementById('fab-add').style.display = (scr === 'pkgs') ? 'flex' : 'none';
        }

        function openModal() { document.getElementById('add-modal').classList.add('active'); tg.HapticFeedback.impactOccurred('medium'); }
        function closeModal() { document.getElementById('add-modal').classList.remove('active'); }
        
        async function submitTrack() {
            const track = document.getElementById('new-track').value;
            const desc = document.getElementById('new-desc').value;
            if(!track) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫!");
            try {
                const res = await fetch(`${API_BASE}/api/add_track`, { method: 'POST', headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'}, body: JSON.stringify({ user_id: userId, track_number: track, description: desc }) });
                const r = await res.json();
                if(r.status === 'ok') { tg.showAlert("–£—Å–ø–µ—à–Ω–æ!"); closeModal(); init(); } else tg.showAlert(r.message);
            } catch(e) {}
        }

        function copyMarking() { copyValue(document.getElementById('marking-text').innerText); }
        function copyRetailAddr() { copyValue(document.getElementById('yiwu-retail-text').innerText); }
        function copyWholesaleAddr() { copyValue(document.getElementById('wholesale-addr-text').innerText); }
        function copyValue(text) { navigator.clipboard.writeText(text).then(() => tg.HapticFeedback.notificationOccurred('success')).catch(() => tg.showAlert("–û—à–∏–±–∫–∞")); }

        init();
    </script>
</body>
</html>
