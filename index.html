<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop Logistics</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #000; --card: #111; --tiffany: #1ae2c7; --text: #fff; --gray: #888; --danger: #ff4d4d; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0 15px 120px; -webkit-tap-highlight-color: transparent; }
        
        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .drop-anim { font-size: 60px; color: var(--tiffany); animation: dropBounce 2s ease-in-out infinite; }
        @keyframes dropBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }

        /* Screens */
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Components */
        .card { background: var(--card); border-radius: 20px; padding: 18px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .btn-main { background: var(--tiffany); color: #000; border: none; border-radius: 12px; padding: 15px; width: 100%; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }
        
        input, select { width: 100%; background: #1c1c1e; border: 1px solid #333; border-radius: 12px; padding: 14px; color: #fff; box-sizing: border-box; font-size: 15px; margin-top: 8px; }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,10,10,0.9); display: flex; padding: 12px 0 30px; border-top: 1px solid #222; backdrop-filter: blur(15px); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: var(--gray); text-decoration: none; font-size: 11px; transition: 0.2s; }
        .nav-item.active { color: var(--tiffany); }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 5px; }

        .status-badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-AWAITING_IU { background: rgba(136, 136, 136, 0.2); color: var(--gray); }
        .status-IN_TRANSIT { background: rgba(26, 226, 199, 0.2); color: var(--tiffany); }

        .addr-box { background: #000; padding: 15px; border-radius: 12px; border: 1px dashed #444; margin-top: 10px; position: relative; }
        .copy-hint { position: absolute; top: -10px; right: 10px; background: var(--tiffany); color: #000; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        .switcher { display: flex; background: #1c1c1e; padding: 4px; border-radius: 14px; margin-top: 10px; }
        .sw-btn { flex: 1; padding: 10px; border: none; border-radius: 11px; background: transparent; color: var(--gray); font-size: 13px; font-weight: 500; }
        .sw-btn.active { background: var(--tiffany); color: #000; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader">
    <div class="drop-anim"><i class="fa-solid fa-parachute-box"></i></div>
    <div style="margin-top:20px; color:var(--tiffany); font-weight:bold; letter-spacing:3px;">DROP LOGISTICS</div>
</div>

<div id="screen-home" class="screen">
    <div style="padding: 20px 0;">
        <h1 style="margin:0; font-size: 32px;">Drop</h1>
        <div id="h-sub" style="color:var(--tiffany); font-size: 14px; font-weight: 500;"></div>
    </div>
    
    <div class="card" onclick="nav('pkgs')">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="color:var(--gray); font-size:11px; letter-spacing:1px;">–ë–û–ù–£–°–ù–´–ô –ë–ê–õ–ê–ù–°</div>
                <div id="h-bon-val" style="font-size:36px; font-weight:bold; margin-top:5px;">0 –∫–≥</div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color:#333;"></i>
        </div>
    </div>

    <div id="opt-calc" class="card" style="display:none;">
        <h3 style="margin:0 0 15px; font-size:16px;"><i class="fa-solid fa-calculator" style="margin-right:8px;"></i> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –û–ü–¢</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="number" id="w" placeholder="–í–µ—Å (–∫–≥)" oninput="calc()">
            <input type="number" id="l" placeholder="–î–ª–∏–Ω–∞ (—Å–º)" oninput="calc()">
            <input type="number" id="wi" placeholder="–®–∏—Ä–∏–Ω–∞ (—Å–º)" oninput="calc()">
            <input type="number" id="h" placeholder="–í—ã—Å–æ—Ç–∞ (—Å–º)" oninput="calc()">
        </div>
        <div style="margin-top:20px; text-align:center; color:var(--tiffany); font-size:24px; font-weight:bold;"><span id="res">0.00</span> $</div>
    </div>
</div>

<div id="screen-pkgs" class="screen">
    <div style="display:flex; justify-content:space-between; align-items:center; margin: 25px 0;">
        <h2 style="margin:0;">–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</h2>
        <button onclick="showAddPopup()" style="background:none; border:none; color:var(--tiffany); font-size:24px;"><i class="fa-solid fa-circle-plus"></i></button>
    </div>
    <div id="orders-container"></div>
</div>

<div id="screen-profile" class="screen">
    <h2 style="margin: 25px 0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    
    <div class="card">
        <div style="font-size:12px; color:var(--gray);">–ö–ê–¢–ï–ì–û–†–ò–Ø</div>
        <div class="switcher">
            <button id="cat-less" class="sw-btn" onclick="setCat('less_100')">–î–æ 100 –∫–≥</button>
            <button id="cat-more" class="sw-btn" onclick="setCat('more_100')">–û—Ç 100 –∫–≥</button>
        </div>
    </div>

    <div id="pr-pvz-card" class="card">
        <div style="font-size:12px; color:var(--gray);">–ü–£–ù–ö–¢ –í–´–î–ê–ß–ò</div>
        <select id="pvz-select" onchange="updatePvz()"></select>
    </div>

    <div class="card">
        <div style="font-size:12px; color:var(--gray);">–Ø–ó–´–ö / –ó–ê–ë–û–ù</div>
        <div class="switcher">
            <button id="lang-ru" class="sw-btn" onclick="setLang('ru')">–†—É—Å—Å–∫–∏–π</button>
            <button id="lang-tj" class="sw-btn" onclick="setLang('tj')">–¢–æ“∑–∏–∫”£</button>
        </div>
    </div>

    <div class="card" id="address-block"></div>

    <div class="card" onclick="tg.openLink('https://t.me/your_support_bot')" style="text-align:center; color:var(--tiffany); font-weight:bold;">
        <i class="fa-solid fa-headset"></i> –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
    </div>
</div>

<nav class="nav-bar">
    <a href="javascript:void(0)" class="nav-item active" id="nav-home" onclick="nav('home')"><i class="fa-solid fa-house"></i><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
    <a href="javascript:void(0)" class="nav-item" id="nav-pkgs" onclick="nav('pkgs')"><i class="fa-solid fa-box"></i><span>–ü–æ—Å—ã–ª–∫–∏</span></a>
    <a href="javascript:void(0)" class="nav-item" id="nav-profile" onclick="nav('profile')"><i class="fa-solid fa-user-gear"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
</nav>

<script>
    const tg = window.Telegram.WebApp;
    const API_BASE = "https://unforeshortened-interartistic-judith.ngrok-free.dev";
    const userId = tg.initDataUnsafe?.user?.id || 317295540;
    const PVZ_LIST = [{name:"üáπüáØ –•—É–¥–∂–∞–Ω–¥", code:"KH"}, {name:"üáπüáØ –î—É—à–∞–Ω–±–µ", code:"DB"}, {name:"üáπüáØ –ò—Å—Ç–∞—Ä–∞–≤—à–∞–Ω", code:"IS"}];
    
    let userData = { category: 'less_100', pvz: PVZ_LIST[0].name, bonus: 0, packages: [], lang: 'ru' };

    async function init() {
        tg.expand();
        try {
            const h = { "ngrok-skip-browser-warning": "1" };
            const [r1, r2] = await Promise.all([
                fetch(`${API_BASE}/api/dashboard/${userId}`, { headers: h }),
                fetch(`${API_BASE}/api/packages/${userId}`, { headers: h })
            ]);
            const d1 = await r1.json();
            const d2 = await r2.json();
            if(d1.status === 'ok') {
                userData.category = d1.user_info.category;
                userData.pvz = d1.user_info.pvz;
                userData.bonus = d1.user_info.bonus_balance;
                userData.lang = d1.user_info.language;
            }
            if(d2.status === 'ok') userData.packages = d2.packages;
        } catch(e) { console.error(e); }
        
        document.getElementById('loader').style.display = 'none';
        document.getElementById('screen-home').classList.add('active');
        render();
    }

    function showAddPopup() {
        tg.showPopup({
            title: '–ù–æ–≤–∞—è –ø–æ—Å—ã–ª–∫–∞',
            message: '–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞',
            buttons: [{id: 'add', type: 'default', text: '–î–æ–±–∞–≤–∏—Ç—å'}, {type: 'cancel'}]
        }, (id) => {
            if(id === 'add') {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –ª—É—á—à–µ –≤—ã–∑–≤–∞—Ç—å prompt –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–ø—É—Ç –≤ —Å–∞–º–æ–º UI
                // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º prompt
                const track = prompt("–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä:");
                if(track) sendTrack(track);
            }
        });
    }

    async function sendTrack(track) {
        tg.MainButton.setText("–°–û–•–†–ê–ù–ï–ù–ò–ï...").show();
        try {
            const res = await fetch(`${API_BASE}/api/add_track`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, track_number: track })
            });
            if(res.ok) {
                tg.HapticFeedback.notificationOccurred('success');
                init();
            } else {
                const err = await res.json();
                tg.showAlert(err.detail || "–û—à–∏–±–∫–∞");
            }
        } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏"); }
        tg.MainButton.hide();
    }

    function render() {
        const isOpt = userData.category === 'more_100';
        document.getElementById('opt-calc').style.display = isOpt ? 'block' : 'none';
        document.getElementById('h-sub').innerText = isOpt ? "–û–ü–¢–û–í–´–ô –ö–õ–ò–ï–ù–¢" : "–†–û–ó–ù–ò–ß–ù–´–ô –ö–õ–ò–ï–ù–¢";
        document.getElementById('h-bon-val').innerText = userData.bonus + " –∫–≥";
        document.getElementById('cat-less').classList.toggle('active', !isOpt);
        document.getElementById('cat-more').classList.toggle('active', isOpt);
        document.getElementById('lang-ru').classList.toggle('active', userData.lang === 'ru');
        document.getElementById('lang-tj').classList.toggle('active', userData.lang === 'tj');

        const sel = document.getElementById('pvz-select');
        sel.innerHTML = PVZ_LIST.map(p => `<option value="${p.name}" ${p.name===userData.pvz?'selected':''}>${p.name}</option>`).join('');

        const addr = document.getElementById('address-block');
        const code = PVZ_LIST.find(p => p.name === userData.pvz)?.code || 'KH';
        const marking = isOpt ? `ID: ${userId} / OPT` : `C-87 / ${code} / ${userId}`;
        
        addr.innerHTML = `
            <div style="font-size:11px;color:var(--gray);margin-bottom:10px;">–î–ê–ù–ù–´–ï –î–õ–Ø –ó–ê–ö–ê–ó–ê</div>
            <div class="addr-box" onclick="copy('${marking}')">
                <span class="copy-hint">–ú–ê–†–ö–ò–†–û–í–ö–ê</span>
                <b style="color:var(--tiffany); font-size:16px;">${marking}</b>
            </div>
            <div class="addr-box" onclick="copy('ÊµôÊ±üÁúÅÈáëÂçéÂ∏Ç‰πâ‰πåÂ∏ÇÁ¶èÁî∞Ë°óÈÅìÈïøÊò•‰∏ÉË°ó52Âè∑1Ê•º')">
                <span class="copy-hint">–ê–î–†–ï–° –°–ö–õ–ê–î–ê</span>
                <span style="font-size:13px;">ÊµôÊ±üÁúÅÈáëÂçéÂ∏Ç‰πâ‰πåÂ∏ÇÁ¶èÁî∞Ë°óÈÅì...</span>
            </div>
        `;

        const cont = document.getElementById('orders-container');
        cont.innerHTML = userData.packages.length ? userData.packages.map(p => `
            <div class="card" onclick="tg.showAlert('–û–ø–∏—Å–∞–Ω–∏–µ: ${p.description}\\n–í–µ—Å: ${p.weight}–∫–≥')">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <div style="font-weight:bold; font-size:16px; margin-bottom:4px;">${p.track}</div>
                        <div class="status-badge status-${p.status_code}">${p.status_text}</div>
                    </div>
                    <div style="text-align:right; font-size:12px; color:var(--gray);">${p.date}</div>
                </div>
            </div>`).join('') : '<div style="text-align:center; padding:50px; color:var(--gray);">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å—ã–ª–æ–∫</div>';
    }

    async function setCat(c) { userData.category = c; render(); updateApi({category: c}); tg.HapticFeedback.selectionChanged(); }
    async function setLang(l) { userData.lang = l; render(); updateApi({language: l}); tg.HapticFeedback.selectionChanged(); }
    async function updatePvz() { userData.pvz = document.getElementById('pvz-select').value; render(); updateApi({pvz: userData.pvz}); }
    async function updateApi(params) { await fetch(`${API_BASE}/api/update_settings`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:userId, ...params}) }); }
    
    function calc() {
        const w = parseFloat(document.getElementById('w').value)||0, l = parseFloat(document.getElementById('l').value)||0, wi = parseFloat(document.getElementById('wi').value)||0, h = parseFloat(document.getElementById('h').value)||0;
        document.getElementById('res').innerText = Math.max(w*4.5, (l*wi*h/1000000)*180).toFixed(2);
    }

    function nav(s) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById('screen-'+s).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-'+s).classList.add('active');
        tg.HapticFeedback.impactOccurred('light');
    }

    function copy(t) {
        navigator.clipboard.writeText(t);
        tg.HapticFeedback.notificationOccurred('success');
        tg.showScanQrPopup({text: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä"});
        setTimeout(() => tg.closeScanQrPopup(), 600);
    }

    init();
</script>
</body>
</html>
