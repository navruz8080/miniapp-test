<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://telegram.org https://cdnjs.cloudflare.com https://fonts.googleapis.com https://fonts.gstatic.com https://ui-avatars.com https://via.placeholder.com https://*.ngrok-free.dev; script-src 'self' 'unsafe-inline' https://telegram.org; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:; img-src 'self' data: https: blob: http:; connect-src 'self' https://*.ngrok-free.dev https://telegram.org;">
    <title>Drop SuperApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Preload Font Awesome –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          onerror="console.error('Font Awesome failed to load from CDN'); this.onerror=null; this.href='https://use.fontawesome.com/releases/v6.4.0/css/all.css';"
          crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #F5F5F7; 
            --card: #FFFFFF; 
            --text: #1D1D1F; 
            --sec: #8E8E93; 
            --blue: #007AFF; 
            --blue-dark: #0051D5;
            --green: #34C759; 
            --purple: #5856D6;
            --orange: #FF9500;
            --red: #FF3B30;
            --radius: 20px;
            --radius-sm: 16px;
            --radius-lg: 24px;
            --shadow-sm: 0 2px 12px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
        }
        
        * { -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
        }
        
        .container { 
            padding: 20px; 
            max-width: 480px; 
            margin: 0 auto; 
            padding-bottom: 100px;
        }
        
        .screen { 
            display: none; 
            width: 100%; 
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .screen.active { display: block !important; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            margin-top: 0;
            padding: 20px 24px;
            background: var(--card);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
            position: relative;
            z-index: 1;
        }
        
        .user-row { 
            display: flex; 
            align-items: center; 
            gap: 14px;
            transition: opacity 0.2s;
        }
        .user-row:active { opacity: 0.7; }
        
        .ava { 
            width: 52px; 
            height: 52px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: var(--shadow-sm);
        }
        
        .lvl-badge { 
            background: linear-gradient(135deg, #FFD60A 0%, #FFC107 100%); 
            color: #000; 
            font-size: 10px; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-weight: 800; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(255,214,10,0.3);
        }
        
        .bonus-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border-radius: var(--radius-lg); 
            padding: 28px 24px; 
            color: white; 
            margin-bottom: 28px; 
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
        }
        .bonus-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            animation: shimmer 4s infinite;
        }
        .bonus-card:active { transform: scale(0.98); }
        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }
        
        .b-val { font-size: 40px; font-weight: 800; margin: 8px 0; letter-spacing: -1px; }
        .b-btn { 
            background: rgba(255,255,255,0.25); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff; 
            padding: 10px 18px; 
            border-radius: 14px; 
            font-size: 13px; 
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }
        .b-btn:active { transform: scale(0.96); background: rgba(255,255,255,0.35); }
        
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 28px; }
        .grid-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 10px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .grid-item:active { transform: scale(0.92); }
        
        .icon-box { 
            width: 64px; 
            height: 64px; 
            background: var(--card); 
            border-radius: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 26px; 
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.04);
        }
        .grid-item:active .icon-box {
            transform: scale(0.95);
            box-shadow: var(--shadow-md);
        }
        
        .grid-lbl { 
            font-size: 12px; 
            font-weight: 600; 
            color: var(--text); 
            text-align: center; 
            line-height: 1.3;
            letter-spacing: -0.2px;
        }
        
        .card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: var(--radius-sm); 
            margin-bottom: 16px; 
            box-shadow: var(--shadow-sm);
            box-sizing: border-box;
            border: 1px solid rgba(0,0,0,0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover { box-shadow: var(--shadow-md); }
        
        .pkg-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 16px 0; 
            border-bottom: 1px solid rgba(0,0,0,0.06); 
            gap: 12px;
            transition: background 0.2s;
        }
        .pkg-item:last-child { border-bottom: none; }
        .pkg-item:active { background: var(--bg); }
        
        .pkg-info { flex: 1; min-width: 0; }
        .pkg-name { font-weight: 700; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: -0.3px; }
        .pkg-sub { font-size: 13px; color: var(--sec); margin-top: 4px; }
        .pkg-status { 
            font-size: 10px; 
            font-weight: 800; 
            padding: 6px 12px; 
            border-radius: 12px; 
            background: rgba(0,0,0,0.06); 
            color: #666; 
            text-transform: uppercase; 
            text-align: center; 
            min-width: 90px;
            letter-spacing: 0.5px;
        }
        .status-ready { background: rgba(52,199,89,0.15); color: #2E7D32; }
        
        .nav-head { 
            background: var(--card); 
            position: sticky; 
            top: 0; 
            z-index: 99; 
            padding: 18px 20px; 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            border-bottom: 1px solid rgba(0,0,0,0.06);
            box-shadow: var(--shadow-sm);
        }
        .nav-head i {
            font-size: 22px;
            color: var(--blue);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .nav-head i:active {
            transform: scale(0.9);
            background: var(--bg);
        }
        
        .pg-title { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
        
        .btn { 
            width: 100%; 
            padding: 18px; 
            border-radius: var(--radius-sm); 
            border: none; 
            background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
            color: #fff; 
            font-weight: 700; 
            font-size: 16px; 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(0,122,255,0.3);
            letter-spacing: 0.2px;
        }
        .btn:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(0,122,255,0.3); }
        .btn-blue { background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%); }
        
        input, select { 
            width: 100%; 
            padding: 16px; 
            background: var(--bg); 
            border: 1.5px solid rgba(0,0,0,0.08);
            border-radius: var(--radius-sm); 
            margin-bottom: 16px; 
            font-size: 16px; 
            box-sizing: border-box; 
            font-family: inherit;
            transition: all 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--blue);
            background: var(--card);
            box-shadow: 0 0 0 4px rgba(0,122,255,0.1);
        }
        
        .copy-box { 
            background: var(--bg); 
            padding: 16px; 
            border-radius: var(--radius-sm); 
            border: 2px dashed rgba(0,0,0,0.1); 
            position: relative; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .copy-box:active { background: rgba(0,122,255,0.05); }
        
        .switch-row { display: flex; justify-content: space-between; align-items: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: rgba(0,0,0,0.2); 
            border-radius: 34px; 
            transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 22px; 
            width: 22px; 
            left: 3px; 
            bottom: 3px; 
            background-color: white; 
            border-radius: 50%; 
            transition: .3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%); }
        input:checked + .slider:before { transform: translateX(22px); }

        .tabs { 
            background: var(--bg); 
            padding: 6px; 
            border-radius: var(--radius-sm); 
            display: flex; 
            margin-bottom: 20px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.04);
        }
        .tab { 
            flex: 1; 
            padding: 12px 16px; 
            text-align: center; 
            font-size: 14px; 
            font-weight: 600; 
            border-radius: 12px; 
            cursor: pointer; 
            color: var(--sec);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab.active { 
            background: var(--card); 
            color: var(--blue); 
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .modal-wrap { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000; 
            display: none; 
            align-items: flex-end;
            animation: fadeIn 0.3s;
        }
        .modal { 
            background: var(--card); 
            width: 100%; 
            border-radius: var(--radius-lg) var(--radius-lg) 0 0; 
            padding: 32px 24px; 
            box-sizing: border-box;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .info-list { list-style: none; padding: 0; margin: 0; }
        .info-list li { 
            padding: 16px 0; 
            border-bottom: 1px solid rgba(0,0,0,0.06); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 15px;
        }
        .info-list li:last-child { border-bottom: none; }
        .rate-row { display: flex; justify-content: space-between; padding: 12px 0; font-size: 15px; }
        
        .smart-copy-btn { 
            background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%); 
            border: none; 
            color: white; 
            padding: 16px 24px; 
            border-radius: var(--radius-sm); 
            font-weight: 700; 
            font-size: 15px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(0,122,255,0.3);
            letter-spacing: 0.2px;
        }
        .smart-copy-btn:active { transform: scale(0.97); }
    </style>
</head>
<body>

    <div id="screen-admin" class="screen">
        <div class="nav-head">
            <div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
        </div>
        <div class="container">
            <div class="card">
                <h3 style="margin:0 0 15px 0;">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—ã–ª–∫–∞–º–∏</h3>
                <button class="btn btn-blue" onclick="openAdminScanner()" style="width:100%; margin-bottom:10px;">
                    <i class="fa-solid fa-qrcode"></i> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥
                </button>
                <input type="text" id="admin-track-input" name="admin-track-input" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä" style="width:100%; padding:12px; margin-bottom:10px; border-radius:var(--radius-md); border:1px solid var(--border);">
                <button class="btn" onclick="searchPackageByTrack()" style="width:100%;">–ù–∞–π—Ç–∏ –ø–æ—Å—ã–ª–∫—É</button>
            </div>
            <div class="card">
                <h3 style="margin:0 0 15px 0;">–°–ø–∏—Å–æ–∫ –ø–æ—Å—ã–ª–æ–∫</h3>
                <div id="admin-packages-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <div id="screen-home" class="screen active">
        <div class="container">
            <div class="header">
                <div class="user-row" onclick="nav('profile')" style="cursor:pointer;">
                    <img id="u-ava" class="ava" src="">
                    <div>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <b id="u-name">...</b>
                            <span id="u-lvl" class="lvl-badge">...</span>
                        </div>
                        <div style="font-size:12px; color:var(--sec);">–ü—Ä–æ—Ñ–∏–ª—å <i class="fa-solid fa-chevron-right" style="font-size:8px;"></i></div>
                    </div>
                </div>
                <div onclick="nav('settings')" style="padding:10px;"><i class="fa-solid fa-gear"></i></div>
            </div>

            <div class="bonus-card" onclick="nav('wallet')" style="cursor:pointer;">
                <div style="opacity:0.9; font-size:13px; font-weight:600; letter-spacing:0.5px; margin-bottom:4px;">–ö–æ—à–µ–ª–µ–∫</div>
                <div class="b-val" style="position:relative; z-index:1;">
                    <span id="u-bonus">0</span> <span style="font-size:20px; opacity:0.9;">–∫–≥</span>
                </div>
                <div style="font-size:13px; opacity:0.9; margin-top:8px; font-weight:500; position:relative; z-index:1;">
                    <span id="u-balance-tjs">0.00</span> TJS ¬∑ <span id="u-balance-usd">0.00</span> USD
                </div>
                <button class="b-btn" onclick="event.stopPropagation(); nav('rewards')" style="position:relative; z-index:1;">
                    <i class="fa-solid fa-star"></i> –ó–∞–¥–∞–Ω–∏—è
                </button>
            </div>

            <div class="grid">
                <div class="grid-item" onclick="nav('china')"><div class="icon-box" style="color: #FF2D55;"><i class="fa-solid fa-warehouse"></i></div><span class="grid-lbl">–ú–æ–π –ö–∏—Ç–∞–π</span></div>
                <div class="grid-item" onclick="nav('trucks')"><div class="icon-box" style="color: #5856D6;"><i class="fa-solid fa-truck-fast"></i></div><span class="grid-lbl">–ë–∏—Ä–∂–∞</span></div>
                <div class="grid-item" onclick="nav('market')"><div class="icon-box" style="color: #FF9500;"><i class="fa-solid fa-bag-shopping"></i></div><span class="grid-lbl">–ú–∞—Ä–∫–µ—Ç</span></div>
                <div class="grid-item" onclick="nav('calc')"><div class="icon-box" style="color: #007AFF;"><i class="fa-solid fa-calculator"></i></div><span class="grid-lbl">–†–∞—Å—á–µ—Ç</span></div>
                <div class="grid-item" onclick="nav('orders')"><div class="icon-box" style="color: #34C759;"><i class="fa-solid fa-box"></i></div><span class="grid-lbl">–ó–∞–∫–∞–∑—ã</span></div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, rgba(0,122,255,0.08) 0%, rgba(88,86,214,0.08) 100%); border: 1px solid rgba(0,122,255,0.15); display:flex; align-items:center; gap:16px; padding:20px; cursor:pointer;" onclick="nav('rewards')">
                <div style="width:48px; height:48px; background:linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%); border-radius:14px; display:flex; align-items:center; justify-content:center; color:white; font-size:22px; box-shadow:0 4px 12px rgba(0,122,255,0.25);">
                    <i class="fa-solid fa-gift"></i>
                </div>
                <div style="flex:1;"><b style="font-size:16px; letter-spacing:-0.3px;">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b><div style="font-size:13px; color:var(--sec); margin-top:4px; font-weight:500;">–î–∞—Ä–∏–º –±–æ–Ω—É—Å—ã –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞</div></div>
                <i class="fa-solid fa-chevron-right" style="color:var(--sec); font-size:14px;"></i>
            </div>
        </div>
    </div>

    <div id="screen-china" class="screen">
        <div class="nav-head"><div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ú–æ–π –ö–∏—Ç–∞–π</div></div>
        <div class="container">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div class="grid-item" onclick="nav('packages')"><div class="icon-box" style="color: #FF2D55;"><i class="fa-solid fa-box-open"></i></div><span class="grid-lbl">–ü–æ—Å—ã–ª–∫–∏</span></div>
                <div class="grid-item" onclick="nav('addresses')"><div class="icon-box" style="color: #34C759;"><i class="fa-solid fa-map-location-dot"></i></div><span class="grid-lbl">–ê–¥—Ä–µ—Å–∞</span></div>
                <div class="grid-item" onclick="nav('rewards')"><div class="icon-box" style="color: #FF9500;"><i class="fa-solid fa-users"></i></div><span class="grid-lbl">–†–µ—Ñ–µ—Ä–∞–ª—ã</span></div>
                
                <div class="grid-item" onclick="nav('prohibited')"><div class="icon-box" style="color: #FF3B30;"><i class="fa-solid fa-hand"></i></div><span class="grid-lbl">–ó–∞–ø—Ä–µ—â–µ–Ω–æ</span></div>
                <div class="grid-item" onclick="nav('rates')"><div class="icon-box" style="color: #007AFF;"><i class="fa-solid fa-tags"></i></div><span class="grid-lbl">–¢–∞—Ä–∏—Ñ—ã</span></div>
                <div class="grid-item" onclick="tg.openLink('https://t.me/your_support')"><div class="icon-box" style="color: #5856D6;"><i class="fa-solid fa-comment-dots"></i></div><span class="grid-lbl">–ü–æ–º–æ—â—å</span></div>
                
                <div class="grid-item" onclick="nav('about')"><div class="icon-box"><i class="fa-solid fa-building"></i></div><span class="grid-lbl">–û –Ω–∞—Å</span></div>
                <div class="grid-item" onclick="tg.showAlert('–ß–∏—Ç–∞–π—Ç–µ –æ—Ç–∑—ã–≤—ã –≤ –Ω–∞—à–µ–º –∫–∞–Ω–∞–ª–µ!')"><div class="icon-box" style="color: #FFD60A;"><i class="fa-solid fa-star-half-stroke"></i></div><span class="grid-lbl">–û—Ç–∑—ã–≤—ã</span></div>
            </div>
        </div>
    </div>

<div id="screen-prohibited" class="screen">
        <div class="nav-head"><div onclick="nav('china')"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ó–∞–ø—Ä–µ—â–µ–Ω–æ –∫ –≤–≤–æ–∑—É</div></div>
        <div class="container">
            <div class="card" style="border-left: 4px solid #FF3B30; background: #FFF5F5;">
                <b style="color:#FF3B30; font-size: 16px;">‚ö†Ô∏è –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b><br>
                <small>–î–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å—Ç—Ä–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –∫ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π –ø–µ—Ä–µ–≤–æ–∑–∫–µ:</small>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 10px 0; color: #E64646;"><i class="fa-solid fa-fire"></i> –û–ø–∞—Å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞</h4>
                <p style="font-size: 13px; color: #666; margin: 0;">–ü–æ—Ä–æ—Ö, —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∏, –ø–∞—Ç—Ä–æ–Ω—ã, –ª–µ–≥–∫–æ–≤–æ—Å–ø–ª–∞–º–µ–Ω—è—é—â–∏–µ—Å—è –º–µ—Ç–∞–ª–ª—ã (–º–∞–≥–Ω–∏–π, –Ω–∞—Ç—Ä–∏–π), —Ä–µ–∞–∫—Ç–∏–≤—ã.</p>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 10px 0; color: #3A7DFF;"><i class="fa-solid fa-droplet"></i> –ñ–∏–¥–∫–æ—Å—Ç–∏ –∏ –≥–∞–∑—ã</h4>
                <p style="font-size: 13px; color: #666; margin: 0;">–ë–µ–Ω–∑–∏–Ω, —Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª–∏, –ª–∞–∫–∏, –∫—Ä–∞—Å–∫–∏, –±–∞–ª–ª–æ–Ω—á–∏–∫–∏ –ø–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º (—Å–ø—Ä–µ–∏), –≥–∞–∑–æ–≤—ã–µ –±–∞–ª–ª–æ–Ω—ã.</p>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 10px 0; color: #1F1F1F;"><i class="fa-solid fa-gun"></i> –û—Ä—É–∂–∏–µ</h4>
                <p style="font-size: 13px; color: #666; margin: 0;">–û–≥–Ω–µ—Å—Ç—Ä–µ–ª—å–Ω–æ–µ, –ø–Ω–µ–≤–º–∞—Ç–∏—á–µ—Å–∫–æ–µ, —Ç—Ä–∞–≤–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ä—É–∂–∏–µ, —ç–ª–µ–∫—Ç—Ä–æ—à–æ–∫–µ—Ä—ã, –¥—É–±–∏–Ω–∫–∏ –∏ –∑–∞–ø—á–∞—Å—Ç–∏ –∫ –Ω–∏–º.</p>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 10px 0; color: #8E5AF7;"><i class="fa-solid fa-pills"></i> –ù–∞—Ä–∫–æ—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ—â–µ—Å—Ç–≤–∞</h4>
                <p style="font-size: 13px; color: #666; margin: 0;">–ù–∞—Ä–∫–æ—Ç–∏–∫–∏, –ø—Ä–µ–∫—É—Ä—Å–æ—Ä—ã, —Å–∏–ª—å–Ω–æ–¥–µ–π—Å—Ç–≤—É—é—â–∏–µ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã –±–µ–∑ —Ä–µ—Ü–µ–ø—Ç–∞, —Å—Ç–µ—Ä–æ–∏–¥—ã.</p>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 10px 0; color: #FF9500;"><i class="fa-solid fa-battery-half"></i> –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã</h4>
                <p style="font-size: 13px; color: #666; margin: 0;">–õ–∏—Ç–∏–π-–∏–æ–Ω–Ω—ã–µ –±–∞—Ç–∞—Ä–µ–∏ –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤, Power Station. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω/–Ω–æ—É—Ç–±—É–∫ ‚Äî <b>—Ä–∞–∑—Ä–µ—à–µ–Ω—ã</b>.</p>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 10px 0; color: #4CD964;"><i class="fa-solid fa-apple-whole"></i> –ü—Ä–æ—á–µ–µ</h4>
                <p style="font-size: 13px; color: #666; margin: 0;">–°–∫–æ—Ä–æ–ø–æ—Ä—Ç—è—â–∏–µ—Å—è –ø—Ä–æ–¥—É–∫—Ç—ã (–º—è—Å–æ, –æ–≤–æ—â–∏), –∂–∏–≤–æ—Ç–Ω—ã–µ, —Ä–∞—Å—Ç–µ–Ω–∏—è, —Å–µ–º–µ–Ω–∞, —à–ø–∏–æ–Ω—Å–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞.</p>
            </div>
        </div>
    </div>

    <div id="screen-rates" class="screen">
        <div class="nav-head"><div onclick="nav('china')"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ù–∞—à–∏ —Ç–∞—Ä–∏—Ñ—ã</div></div>
        <div class="container">
            <div class="card">
                <h3 style="margin:0 0 15px 0; color:var(--blue);">üì¶ –†–æ–∑–Ω–∏—á–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã</h3>
                <div class="rate-row" style="border-bottom: 1px solid #f2f2f2; padding: 10px 0;"><span>–î–æ 0.5 –∫–≥</span><b style="color:var(--text);">13 TJS <small>(—Ñ–∏–∫—Å)</small></b></div>
                <div class="rate-row" style="border-bottom: 1px solid #f2f2f2; padding: 10px 0;"><span>–æ—Ç 0.5 –¥–æ 1 –∫–≥</span><b style="color:var(--text);">23 TJS <small>(—Ñ–∏–∫—Å)</small></b></div>
                <div class="rate-row" style="border-bottom: 1px solid #f2f2f2; padding: 10px 0;"><span>–æ—Ç 1 –¥–æ 50 –∫–≥</span><b style="color:var(--text);">23 TJS / –∫–≥</b></div>
                <div class="rate-row" style="padding: 10px 0;"><span>–æ—Ç 50 –¥–æ 99 –∫–≥</span><b style="color:var(--green);">20 TJS / –∫–≥</b></div>
                <p style="font-size:12px; color:var(--sec); margin-top:10px; line-height: 1.4;">* –°—Ä–æ–∫ –∞–≤–∏–∞-–¥–æ—Å—Ç–∞–≤–∫–∏: 10-15 –¥–Ω–µ–π.<br>* –í–µ—Å –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º –∞–≤–∏–∞–ø–µ—Ä–µ–≤–æ–∑–æ–∫.</p>
            </div>
            <div class="card" style="background: #F8F9FB;">
                <h3 style="margin:0 0 12px 0;">üè¢ –û–ø—Ç–æ–≤—ã–µ —Ç–∞—Ä–∏—Ñ—ã</h3>
                <p style="font-size: 14px; margin-bottom: 15px;">–î–ª—è –≥—Ä—É–∑–æ–≤ –≤–µ—Å–æ–º <b>–æ—Ç 100 –∫–≥</b> –¥–µ–π—Å—Ç–≤—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:</p>
                <div class="rate-row"><span>–•–æ–∑—Ç–æ–≤–∞—Ä—ã</span> <b>–æ—Ç $0.55 / –∫–≥</b></div>
                <div class="rate-row"><span>–û–¥–µ–∂–¥–∞ / –û–±—É–≤—å</span> <b>–æ—Ç $0.75 / –∫–≥</b></div>
                <button class="btn btn-blue" style="margin-top: 15px;" onclick="nav('calc')">–¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ</button>
            </div>
        </div>
    </div>
    <div id="screen-about" class="screen">
        <div class="nav-head"><div onclick="nav('china')"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–û –Ω–∞—Å</div></div>
        <div class="container">
            <div class="card" style="text-align:center;">
                <div style="font-size:40px;margin-bottom:10px;">üöÄ</div>
                <h2 style="margin:0;">Drop Logistics</h2>
                <p style="color:var(--sec);font-size:14px;">–í–∞—à–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –∏–∑ –ö–∏—Ç–∞—è</p>
            </div>
            <div class="card">
                <p style="margin-top:0;">–ú—ã ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π –Ω–∞–¥–µ–∂–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É –≥—Ä—É–∑–æ–≤ –∏–∑ –ö–∏—Ç–∞—è –≤ –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω.</p>
                <p>‚úÖ <b>–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∫–ª–∞–¥—ã</b> –≤ –ò—É –∏ –£—Ä—É–º—á–∏.</p>
                <p>‚úÖ <b>–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã</b> –∏ —á–µ—Å—Ç–Ω—ã–π –≤–µ—Å.</p>
                <p>‚úÖ <b>–ë—ã—Å—Ç—Ä–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</b> –≤ Telegram.</p>
            </div>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="nav-head">
            <div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title" data-i18n="profile">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div>
            <div onclick="toggleLanguage()" style="padding:8px; cursor:pointer; font-size:14px; font-weight:600; color:var(--blue);">
                <span id="lang-indicator">RU</span>
            </div>
        </div>
        <div class="container">
            <div class="card" style="text-align: center; padding: 30px 20px;">
                <div style="position: relative; display: inline-block;">
                    <img id="p-ava" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; transition: opacity 0.2s;" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ">
                    <div id="p-lvl-tag" class="lvl-badge" style="position: absolute; bottom: 0; right: 0; padding: 4px 10px; font-size: 12px; border: 2px solid #fff;">...</div>
                    <div style="position: absolute; bottom: 0; left: 0; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; cursor: pointer;" onclick="editAvatar()">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                </div>
                <h2 id="p-name" style="margin: 15px 0 5px 0;">...</h2>
                <div style="font-size:12px; color:var(--sec);">ID: <span id="p-id">...</span></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <div class="card" style="margin-bottom: 0; text-align: center;">
                    <div style="font-size: 12px; color: var(--sec);">–ë–æ–Ω—É—Å—ã</div>
                    <div style="font-size: 20px; font-weight: 800; color: var(--green);"><span id="p-bonus">0</span> –∫–≥</div>
                </div>
                <div class="card" style="margin-bottom: 0; text-align: center;">
                    <div style="font-size: 12px; color: var(--sec);">–°—Ç–∞—Ç—É—Å</div>
                    <div style="font-size: 14px; font-weight: 700;" id="p-status-name">...</div>
                </div>
            </div>
            <div class="card" style="padding: 0;">
                <div class="pkg-item" style="padding: 16px;" onclick="nav('settings')">
                    <div style="display:flex; align-items:center; gap:12px;"><i class="fa-solid fa-user-pen" style="color:var(--blue);"></i><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∞–Ω–Ω—ã—Ö</b></div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-wallet" class="screen">
        <div class="nav-head">
            <div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ö–æ—à–µ–ª–µ–∫</div>
        </div>
        <div class="container">
            <div class="card" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; text-align:center;">
                <div>
                    <div style="font-size:11px; color:var(--sec);">–ë–∞–ª–∞–Ω—Å TJS</div>
                    <div style="font-size:18px; font-weight:800;"><span id="w-b-tjs">0.00</span></div>
                </div>
                <div>
                    <div style="font-size:11px; color:var(--sec);">–ë–∞–ª–∞–Ω—Å USD</div>
                    <div style="font-size:18px; font-weight:800;"><span id="w-b-usd">0.00</span></div>
                </div>
                <div>
                    <div style="font-size:11px; color:var(--sec);">Bonus KG</div>
                    <div style="font-size:18px; font-weight:800; color:var(--green);"><span id="w-b-bonus">0.00</span> –∫–≥</div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <b>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</b>
                </div>
                <div id="wallet-tx-list" style="font-size:13px; color:var(--sec);">
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
        </div>
    </div>

    <div id="screen-packages" class="screen">
        <div class="nav-head"><div onclick="nav('china')"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</div></div>
        <div class="container">
            <button class="btn btn-blue" onclick="openM('m-add')" style="margin-bottom:15px;"><i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫</button>
            <div class="card" id="full-pkg-list"></div>
        </div>
    </div>

    <div id="screen-addresses" class="screen">
        <div class="nav-head"><div onclick="nav('china')"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ù–∞—à–∏ –∞–¥—Ä–µ—Å–∞</div></div>
        <div class="container">
            <div class="card">
                <div class="switch-row"><b>–û–ø—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (>100 –∫–≥)</b><label class="switch"><input type="checkbox" id="tg-opt" name="tg-opt" onchange="toggleMode()"><span class="slider"></span></label></div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <b>–ê–¥—Ä–µ—Å –≤ –ö–∏—Ç–∞–µ</b>
                    <select id="sel-city" name="sel-city" onchange="renderAddr()" style="width: auto; height: 30px; font-size: 12px; display:none; padding: 0 5px; margin: 0;">
                        <option value="yiwu">–ò—É (Yiwu)</option><option value="urumqi">–£—Ä—É–º—á–∏</option>
                    </select>
                </div>
                <div class="copy-box" onclick="copy('txt-addr')">
                    <div id="txt-addr" class="copy-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <i class="fa-regular fa-copy" style="position:absolute; right:12px; top:15px; color:var(--blue);"></i>
                </div>
                <button class="smart-copy-btn" onclick="smartCopyAddress()" style="margin-top:12px; width:100%;">
                    <i class="fa-solid fa-bolt"></i> Smart Copy –¥–ª—è Taobao/Pinduoduo
                </button>
            </div>
            <div class="card" id="box-code">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                    <i class="fa-solid fa-qrcode" style="color:#F57F17;"></i>
                    <b>Marking ID (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)</b>
                </div>
                <div style="font-size:12px; color:var(--sec); margin-bottom:10px;">
                    –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–∞—à–∏—Ö –ø–æ—Å—ã–ª–æ–∫. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –µ–≥–æ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ!
                </div>
                <div class="copy-box" onclick="copy('txt-code')" style="background: #FFF9C4; margin-top:10px; border-color: #FBC02D; cursor:pointer;">
                    <div id="txt-code" class="copy-text" style="font-weight:900; color:#F57F17; font-family:monospace; font-size:14px;">...</div>
                    <i class="fa-regular fa-copy" style="position:absolute; right:12px; top:15px; color:#F57F17;"></i>
                </div>
                <div style="margin-top:8px; font-size:11px; color:#8E8E93; display:flex; align-items:center; gap:5px;">
                    <i class="fa-solid fa-info-circle"></i>
                    <span>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–µ–Ω—é –†–∞—Å—á–µ—Ç–æ–≤ -->
    <div id="screen-calc" class="screen">
        <div class="nav-head"><div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–†–∞—Å—á–µ—Ç</div></div>
        <div class="container">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div class="grid-item" onclick="nav('calc-calculator')"><div class="icon-box" style="color: #007AFF;"><i class="fa-solid fa-calculator"></i></div><span class="grid-lbl">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span></div>
                <div class="grid-item" onclick="nav('calc-history')"><div class="icon-box" style="color: #8E8E93;"><i class="fa-solid fa-clock-rotate-left"></i></div><span class="grid-lbl">–ò—Å—Ç–æ—Ä–∏—è</span></div>
                <div class="grid-item" onclick="nav('calc-rates')"><div class="icon-box" style="color: #FFD60A;"><i class="fa-solid fa-tags"></i></div><span class="grid-lbl">–¢–∞—Ä–∏—Ñ—ã</span></div>
                
                <div class="grid-item" onclick="nav('calc-compare')"><div class="icon-box" style="color: #34C759;"><i class="fa-solid fa-chart-line"></i></div><span class="grid-lbl">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</span></div>
                <div class="grid-item" onclick="nav('calc-help')"><div class="icon-box" style="color: #5856D6;"><i class="fa-solid fa-question-circle"></i></div><span class="grid-lbl">–ü–æ–º–æ—â—å</span></div>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
    <div id="screen-calc-calculator" class="screen">
        <div class="nav-head"><div onclick="nav('calc')"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏</div></div>
        <div class="container">
            <div class="card">
                <div class="switch-row" style="margin-bottom:15px;"><b>–û–ø—Ç–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ</b><label class="switch"><input type="checkbox" id="tg-calc" name="tg-calc" onchange="toggleMode()"><span class="slider"></span></label></div>
                <div id="box-calc-opt" style="display:none; border-top:1px solid #eee; padding-top:10px;">
                    <select id="sel-route" name="sel-route"></select>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                        <input id="c-len" name="c-len" type="number" placeholder="–î–ª–∏–Ω–∞">
                        <input id="c-wid" name="c-wid" type="number" placeholder="–®–∏—Ä–∏–Ω–∞">
                        <input id="c-hei" name="c-hei" type="number" placeholder="–í—ã—Å–æ—Ç–∞">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <input id="c-wg" name="c-wg" type="number" placeholder="–í–µ—Å (–∫–≥)">
                    <input id="c-qty" name="c-qty" type="number" value="1" placeholder="–ö–æ–ª-–≤–æ">
                </div>
                <div id="c-res-wrap" style="background:#f8f9fa; border-radius:14px; padding:20px; margin:20px 0; text-align:center;">
                    <div id="c-res" style="font-size:36px; font-weight:800; color:var(--blue);">0.00</div>
                    <div id="c-cur" style="font-size:14px; color:var(--sec);">–ö –æ–ø–ª–∞—Ç–µ</div>
                </div>
                <button class="btn btn-blue" onclick="doCalc()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                <button id="btn-order-confirm" class="btn" onclick="submitOrder()" style="display:none; background:#34C759; margin-top:10px;">–û—Ñ–æ—Ä–º–∏—Ç—å –≥—Ä—É–∑</button>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—á–µ—Ç–æ–≤ -->
    <div id="screen-calc-history" class="screen">
        <div class="nav-head">
            <div onclick="nav('calc')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤</div>
        </div>
        <div class="container">
            <div id="list-calc-history"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Ç–∞—Ä–∏—Ñ–æ–≤ —Ä–∞—Å—á–µ—Ç–æ–≤ -->
    <div id="screen-calc-rates" class="screen">
        <div class="nav-head">
            <div onclick="nav('calc')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–¢–∞—Ä–∏—Ñ—ã –¥–æ—Å—Ç–∞–≤–∫–∏</div>
        </div>
        <div class="container">
            <div class="card">
                <h3 style="margin-bottom:16px;">–†–æ–∑–Ω–∏—á–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã</h3>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">–î–æ 1 –∫–≥</div>
                    <div style="color:var(--sec);font-size:14px;">15 TJS –∑–∞ –∫–≥</div>
                </div>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">1-5 –∫–≥</div>
                    <div style="color:var(--sec);font-size:14px;">12 TJS –∑–∞ –∫–≥</div>
                </div>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">–û—Ç 5 –∫–≥</div>
                    <div style="color:var(--sec);font-size:14px;">10 TJS –∑–∞ –∫–≥</div>
                </div>
            </div>
            <div class="card" style="margin-top:16px;">
                <h3 style="margin-bottom:16px;">–û–ø—Ç–æ–≤—ã–µ —Ç–∞—Ä–∏—Ñ—ã</h3>
                <p style="color:var(--sec);font-size:14px;">–ó–∞–≤–∏—Å—è—Ç –æ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –æ–±—ä–µ–º–∞. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ.</p>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤ -->
    <div id="screen-calc-compare" class="screen">
        <div class="nav-head">
            <div onclick="nav('calc')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤</div>
        </div>
        <div class="container">
            <div class="card">
                <h3 style="margin-bottom:16px;">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div style="padding:12px;background:#f8f9fa;border-radius:8px;">
                        <div style="font-weight:600;margin-bottom:4px;">–†–æ–∑–Ω–∏—Ü–∞</div>
                        <div style="color:var(--sec);font-size:12px;margin-bottom:8px;">–î–ª—è –º–∞–ª—ã—Ö –ø–∞—Ä—Ç–∏–π</div>
                        <div style="color:var(--blue);font-weight:700;">–û—Ç 10 TJS/–∫–≥</div>
                    </div>
                    <div style="padding:12px;background:#f8f9fa;border-radius:8px;">
                        <div style="font-weight:600;margin-bottom:4px;">–û–ø—Ç</div>
                        <div style="color:var(--sec);font-size:12px;margin-bottom:8px;">–î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤</div>
                        <div style="color:var(--green);font-weight:700;">–û—Ç 5 TJS/–∫–≥</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –ø–æ–º–æ—â–∏ —Ä–∞—Å—á–µ—Ç–æ–≤ -->
    <div id="screen-calc-help" class="screen">
        <div class="nav-head">
            <div onclick="nav('calc')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ü–æ–º–æ—â—å –ø–æ —Ä–∞—Å—á–µ—Ç–∞–º</div>
        </div>
        <div class="container">
            <div class="card">
                <h3 style="margin-bottom:16px;">–ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å?</h3>
                <p style="color:var(--sec);line-height:1.6;margin-bottom:16px;">
                    –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä—É–∑–∞ –∏ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏.
                </p>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px;">
                    <div style="font-weight:600;margin-bottom:4px;">1. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</div>
                    <div style="color:var(--sec);font-size:14px;">–†–æ–∑–Ω–∏—Ü–∞ –∏–ª–∏ –æ–ø—Ç</div>
                </div>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px;">
                    <div style="font-weight:600;margin-bottom:4px;">2. –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
                    <div style="color:var(--sec);font-size:14px;">–í–µ—Å, –≥–∞–±–∞—Ä–∏—Ç—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                </div>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">3. –ü–æ–ª—É—á–∏—Ç–µ —Ä–∞—Å—á–µ—Ç</div>
                    <div style="color:var(--sec);font-size:14px;">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-settings" class="screen"><div class="nav-head"><div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div></div><div class="container"><div class="card"><input id="s-name" name="s-name" placeholder="–í–∞—à–µ –∏–º—è"><input id="s-phone" name="s-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω"><select id="s-pvz" name="s-pvz"></select><button class="btn btn-blue" onclick="saveSet()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div></div>
    <!-- –ú–µ–Ω—é –ë–∏—Ä–∂–∏ -->
    <div id="screen-trucks" class="screen">
        <div class="nav-head"><div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ë–∏—Ä–∂–∞</div></div>
        <div class="container">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div class="grid-item" onclick="nav('trucks-orders')"><div class="icon-box" style="color: #FF9500;"><i class="fa-solid fa-handshake"></i></div><span class="grid-lbl">–°–¥–µ–ª–∫–∏</span></div>
                <div class="grid-item" onclick="nav('trucks-trips')"><div class="icon-box" style="color: #5856D6;"><i class="fa-solid fa-truck-fast"></i></div><span class="grid-lbl">–ú–∞—à–∏–Ω—ã</span></div>
                <div class="grid-item" onclick="nav('trucks-cargo')"><div class="icon-box" style="color: #34C759;"><i class="fa-solid fa-boxes-stacked"></i></div><span class="grid-lbl">–ì—Ä—É–∑—ã</span></div>
                
                <div class="grid-item" onclick="nav('trucks-create')"><div class="icon-box" style="color: #007AFF;"><i class="fa-solid fa-plus-circle"></i></div><span class="grid-lbl">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</span></div>
                <div class="grid-item" onclick="nav('trucks-history')"><div class="icon-box" style="color: #8E8E93;"><i class="fa-solid fa-clock-rotate-left"></i></div><span class="grid-lbl">–ò—Å—Ç–æ—Ä–∏—è</span></div>
                <div class="grid-item" onclick="nav('trucks-rates')"><div class="icon-box" style="color: #FFD60A;"><i class="fa-solid fa-dollar-sign"></i></div><span class="grid-lbl">–¢–∞—Ä–∏—Ñ—ã</span></div>
                
                <div class="grid-item" onclick="nav('trucks-help')"><div class="icon-box" style="color: #5856D6;"><i class="fa-solid fa-question-circle"></i></div><span class="grid-lbl">–ü–æ–º–æ—â—å</span></div>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Å–¥–µ–ª–æ–∫ –±–∏—Ä–∂–∏ -->
    <div id="screen-trucks-orders" class="screen">
        <div class="nav-head">
            <div onclick="nav('trucks')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–°–¥–µ–ª–∫–∏</div>
        </div>
        <div class="container">
            <div class="tabs">
                <div class="tab active" onclick="swTr('orders', this)">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                <div class="tab" onclick="swTr('history', this)">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</div>
            </div>
            <button class="btn btn-blue" onclick="openM('m-create-order')" style="margin-bottom:15px;">
                <i class="fa-solid fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
            </button>
            <div id="list-trucks"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –º–∞—à–∏–Ω –±–∏—Ä–∂–∏ -->
    <div id="screen-trucks-trips" class="screen">
        <div class="nav-head">
            <div onclick="nav('trucks')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ú–∞—à–∏–Ω—ã</div>
        </div>
        <div class="container">
            <div id="list-trucks-trips"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –≥—Ä—É–∑–æ–≤ –±–∏—Ä–∂–∏ -->
    <div id="screen-trucks-cargo" class="screen">
        <div class="nav-head">
            <div onclick="nav('trucks')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ì—Ä—É–∑—ã</div>
        </div>
        <div class="container">
            <div id="list-trucks-cargo"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –±–∏—Ä–∂–∏ -->
    <div id="screen-trucks-create" class="screen">
        <div class="nav-head">
            <div onclick="nav('trucks')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</div>
        </div>
        <div class="container">
            <div class="card">
                <input id="eo-route" name="eo-route" placeholder="–ú–∞—Ä—à—Ä—É—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò—É ‚Üí –•—É–¥–∂–∞–Ω–¥)">
                <input id="eo-weight" name="eo-weight" type="number" placeholder="–í–µ—Å (–∫–≥)" step="0.01">
                <input id="eo-price" name="eo-price" type="number" placeholder="–¶–µ–Ω–∞ –∑–∞ –∫–≥" step="0.01">
                <select id="eo-currency" name="eo-currency">
                    <option value="USD">USD</option>
                    <option value="TJS">TJS</option>
                </select>
                <input id="eo-desc" name="eo-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <button class="btn btn-blue" onclick="createExchangeOrder()">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –∏—Å—Ç–æ—Ä–∏–∏ –±–∏—Ä–∂–∏ -->
    <div id="screen-trucks-history" class="screen">
        <div class="nav-head">
            <div onclick="nav('trucks')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</div>
        </div>
        <div class="container">
            <div id="list-trucks-history"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Ç–∞—Ä–∏—Ñ–æ–≤ –±–∏—Ä–∂–∏ -->
    <div id="screen-trucks-rates" class="screen">
        <div class="nav-head">
            <div onclick="nav('trucks')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–¢–∞—Ä–∏—Ñ—ã –±–∏—Ä–∂–∏</div>
        </div>
        <div class="container">
            <div class="card">
                <h3 style="margin-bottom:16px;">–¢–∞—Ä–∏—Ñ—ã –¥–ª—è P2P-–ª–æ–≥–∏—Å—Ç–∏–∫–∏</h3>
                <p style="color:var(--sec);margin-bottom:12px;">–¶–µ–Ω—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ —Å–¥–µ–ª–∫–∏</p>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è</div>
                    <div style="color:var(--sec);font-size:14px;">5% –æ—Ç —Å—É–º–º—ã —Å–¥–µ–ª–∫–∏</div>
                </div>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">Escrow –∑–∞—â–∏—Ç–∞</div>
                    <div style="color:var(--sec);font-size:14px;">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–¥–µ–ª–æ–∫</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –ø–æ–º–æ—â–∏ –±–∏—Ä–∂–∏ -->
    <div id="screen-trucks-help" class="screen">
        <div class="nav-head">
            <div onclick="nav('trucks')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ü–æ–º–æ—â—å –ø–æ –±–∏—Ä–∂–µ</div>
        </div>
        <div class="container">
            <div class="card">
                <h3 style="margin-bottom:16px;">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–∏—Ä–∂–∞?</h3>
                <p style="color:var(--sec);line-height:1.6;margin-bottom:16px;">
                    –ë–∏—Ä–∂–∞ - —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ–∫. –ö–ª–∏–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç –∑–∞–∫–∞–∑—ã, –≤–æ–¥–∏—Ç–µ–ª–∏ –æ—Ç–∫–ª–∏–∫–∞—é—Ç—Å—è –Ω–∞ –Ω–∏—Ö.
                </p>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px;">
                    <div style="font-weight:600;margin-bottom:4px;">1. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑</div>
                    <div style="color:var(--sec);font-size:14px;">–£–∫–∞–∂–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç, –≤–µ—Å –∏ —Ü–µ–Ω—É</div>
                </div>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px;">
                    <div style="font-weight:600;margin-bottom:4px;">2. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–∫–ª–∏–∫–∞</div>
                    <div style="color:var(--sec);font-size:14px;">–í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–º–µ—Ç –≤–∞—à –∑–∞–∫–∞–∑</div>
                </div>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">3. –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Escrow</div>
                    <div style="color:var(--sec);font-size:14px;">–î–µ–Ω—å–≥–∏ –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—é—Ç—Å—è –¥–æ –¥–æ—Å—Ç–∞–≤–∫–∏</div>
                </div>
            </div>
        </div>
    </div>

    <div id="m-create-order" class="modal-wrap">
        <div class="modal">
            <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ –±–∏—Ä–∂–µ</h3>
            <input id="eo-route" name="eo-route" placeholder="–ú–∞—Ä—à—Ä—É—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò—É ‚Üí –•—É–¥–∂–∞–Ω–¥)">
            <input id="eo-weight" name="eo-weight" type="number" placeholder="–í–µ—Å (–∫–≥)" step="0.01">
            <input id="eo-price" name="eo-price" type="number" placeholder="–¶–µ–Ω–∞ –∑–∞ –∫–≥" step="0.01">
            <select id="eo-currency" name="eo-currency">
                <option value="USD">USD</option>
                <option value="TJS">TJS</option>
            </select>
            <input id="eo-desc" name="eo-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <button class="btn btn-blue" onclick="createExchangeOrder()">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
            <div style="text-align:center;padding:15px;color:var(--sec);cursor:pointer;" onclick="closeM('m-create-order')">–û—Ç–º–µ–Ω–∞</div>
        </div>
    </div>
    <div id="screen-cart" class="screen">
        <div class="nav-head">
            <div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
        </div>
        <div class="container" style="padding-bottom:120px;">
            <div id="cart-content"></div>
            <div id="cart-footer" style="position:fixed;bottom:0;left:0;right:0;background:var(--bg);padding:16px;border-top:1px solid var(--border);box-shadow:0 -2px 10px rgba(0,0,0,0.1);z-index:10;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <div>
                        <div style="font-size:12px;color:var(--sec);">–ò—Ç–æ–≥–æ</div>
                        <div id="cart-total" style="font-size:24px;font-weight:800;color:var(--blue);">0 TJS</div>
                    </div>
                    <button class="btn btn-blue" id="cart-checkout-btn" onclick="checkoutCart()" style="flex:1;max-width:200px;">
                        –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="screen-orders" class="screen">
        <div class="nav-head">
            <div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
        </div>
        <div class="container">
            <div id="orders-content"></div>
        </div>
    </div>
    
    <!-- –ú–µ–Ω—é –ú–∞—Ä–∫–µ—Ç–∞ -->
    <div id="screen-market" class="screen">
        <div class="nav-head"><div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ú–∞—Ä–∫–µ—Ç</div></div>
        <div class="container">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div class="grid-item" onclick="nav('market-products')"><div class="icon-box" style="color: #FF9500;"><i class="fa-solid fa-bag-shopping"></i></div><span class="grid-lbl">–¢–æ–≤–∞—Ä—ã</span></div>
                <div class="grid-item" onclick="nav('market-pools')"><div class="icon-box" style="color: #34C759;"><i class="fa-solid fa-users"></i></div><span class="grid-lbl">–°–±–æ—Ä—ã</span></div>
                <div class="grid-item" onclick="nav('cart')"><div class="icon-box" style="color: #007AFF;"><i class="fa-solid fa-cart-shopping"></i></div><span class="grid-lbl">–ö–æ—Ä–∑–∏–Ω–∞</span></div>
                
                <div class="grid-item" onclick="nav('orders')"><div class="icon-box" style="color: #5856D6;"><i class="fa-solid fa-box"></i></div><span class="grid-lbl">–ó–∞–∫–∞–∑—ã</span></div>
                <div class="grid-item" onclick="nav('market-wishlist')"><div class="icon-box" style="color: #FF2D55;"><i class="fa-solid fa-heart"></i></div><span class="grid-lbl">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span></div>
                <div class="grid-item" onclick="nav('market-categories')"><div class="icon-box" style="color: #FFD60A;"><i class="fa-solid fa-tags"></i></div><span class="grid-lbl">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span></div>
                
                <div class="grid-item" onclick="nav('market-sellers')"><div class="icon-box" style="color: #8E8E93;"><i class="fa-solid fa-store"></i></div><span class="grid-lbl">–ü—Ä–æ–¥–∞–≤—Ü—ã</span></div>
                <div class="grid-item" onclick="nav('market-help')"><div class="icon-box" style="color: #5856D6;"><i class="fa-solid fa-question-circle"></i></div><span class="grid-lbl">–ü–æ–º–æ—â—å</span></div>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Ç–æ–≤–∞—Ä–æ–≤ –º–∞—Ä–∫–µ—Ç–∞ -->
    <div id="screen-market-products" class="screen">
        <div class="nav-head">
            <div onclick="nav('market')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–¢–æ–≤–∞—Ä—ã</div>
            <div style="position:relative;cursor:pointer;" onclick="nav('cart')">
                <i class="fa-solid fa-shopping-cart" style="font-size:20px;"></i>
                <span id="cart-badge" style="position:absolute;top:-8px;right:-8px;background:#FF3B30;color:#fff;border-radius:50%;width:20px;height:20px;display:none;align-items:center;justify-content:center;font-size:11px;font-weight:700;">0</span>
            </div>
        </div>
        <div class="container">
            <div id="market-search-wrap" style="margin:12px 0;">
                <input type="text" id="market-search" name="market-search" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." 
                       style="width:100%;padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--bg);font-size:15px;"
                       oninput="filterMarketProducts()">
            </div>
            <div id="list-market"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Å–±–æ—Ä–æ–≤ –º–∞—Ä–∫–µ—Ç–∞ -->
    <div id="screen-market-pools" class="screen">
        <div class="nav-head">
            <div onclick="nav('market')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ì—Ä—É–ø–ø–æ–≤—ã–µ —Å–±–æ—Ä—ã</div>
        </div>
        <div class="container">
            <div id="list-market-pools"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ç–∞ -->
    <div id="screen-market-wishlist" class="screen">
        <div class="nav-head">
            <div onclick="nav('market')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
        </div>
        <div class="container">
            <div id="list-market-wishlist"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–π –º–∞—Ä–∫–µ—Ç–∞ -->
    <div id="screen-market-categories" class="screen">
        <div class="nav-head">
            <div onclick="nav('market')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
        </div>
        <div class="container">
            <div id="list-market-categories"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ –º–∞—Ä–∫–µ—Ç–∞ -->
    <div id="screen-market-sellers" class="screen">
        <div class="nav-head">
            <div onclick="nav('market')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ü—Ä–æ–¥–∞–≤—Ü—ã</div>
        </div>
        <div class="container">
            <div id="list-market-sellers"></div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –ø–æ–º–æ—â–∏ –º–∞—Ä–∫–µ—Ç–∞ -->
    <div id="screen-market-help" class="screen">
        <div class="nav-head">
            <div onclick="nav('market')"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="pg-title">–ü–æ–º–æ—â—å –ø–æ –º–∞—Ä–∫–µ—Ç—É</div>
        </div>
        <div class="container">
            <div class="card">
                <h3 style="margin-bottom:16px;">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞—Ä–∫–µ—Ç?</h3>
                <p style="color:var(--sec);line-height:1.6;margin-bottom:16px;">
                    –ú–∞—Ä–∫–µ—Ç - —ç—Ç–æ –ø–ª–æ—â–∞–¥–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ö–∏—Ç–∞—è —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –≤ –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω.
                </p>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px;">
                    <div style="font-weight:600;margin-bottom:4px;">1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</div>
                    <div style="color:var(--sec);font-size:14px;">–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É</div>
                </div>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px;">
                    <div style="font-weight:600;margin-bottom:4px;">2. –ì—Ä—É–ø–ø–æ–≤—ã–µ —Å–±–æ—Ä—ã</div>
                    <div style="color:var(--sec);font-size:14px;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —Å–±–æ—Ä–∞–º –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏</div>
                </div>
                <div style="padding:12px;background:#f8f9fa;border-radius:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">3. –û–ø–ª–∞—Ç–∞ –∏ –¥–æ—Å—Ç–∞–≤–∫–∞</div>
                    <div style="color:var(--sec);font-size:14px;">–û–ø–ª–∞—Ç–∏—Ç–µ –∑–∞–∫–∞–∑ –∏ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–≤–∞—Ä</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞ -->
    <div id="m-product-details" class="modal-wrap">
        <div class="modal" style="max-width:500px;">
            <div class="modal-content" id="product-details-content">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div style="text-align:center;padding:15px;color:var(--sec);cursor:pointer;" onclick="closeM('m-product-details')">–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
    </div>
    <div id="screen-rewards" class="screen">
        <div class="nav-head"><div onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ó–∞–¥–∞–Ω–∏—è</div></div>
        <div class="container">
            <div class="tabs" style="margin-bottom:15px;">
                <div class="tab active" onclick="swRew('tasks', this)">–ó–∞–¥–∞–Ω–∏—è</div>
                <div class="tab" onclick="swRew('referrals', this)">–†–µ—Ñ–µ—Ä–∞–ª—ã</div>
            </div>
            <div id="list-rewards"></div>
            <div id="list-referrals" style="display:none;"></div>
        </div>
    </div>

    <div id="m-add" class="modal-wrap"><div class="modal"><h3>–ù–æ–≤—ã–π —Ç—Ä–µ–∫</h3><input id="n-t" name="n-t" placeholder="–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä"><input id="n-d" name="n-d" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"><button class="btn btn-blue" onclick="subTrack()">–î–æ–±–∞–≤–∏—Ç—å</button><div style="text-align:center;padding:15px;color:var(--sec);" onclick="closeM('m-add')">–û—Ç–º–µ–Ω–∞</div></div></div>
    
    <div id="m-package-history" class="modal-wrap">
        <div class="modal" style="max-height:80vh; overflow-y:auto;">
            <div class="modal-content"></div>
            <div style="text-align:center;padding:15px;color:var(--sec);" onclick="closeM('m-package-history')">–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
    </div>
    
    <div id="m-admin-package" class="modal-wrap">
        <div class="modal" style="max-height:90vh; overflow-y:auto;">
            <h3 id="admin-pkg-title">–ü–æ—Å—ã–ª–∫–∞</h3>
            <div id="admin-pkg-info" class="card" style="margin-bottom:15px;"></div>
            <div class="card">
                <h4 style="margin:0 0 10px 0;">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h4>
                <select id="admin-status-select" name="admin-status-select" style="width:100%; padding:12px; margin-bottom:10px; border-radius:var(--radius-md);">
                    <option value="AWAITING_IU">–û–∂–∏–¥–∞–µ—Ç –≤ –ò—É</option>
                    <option value="IN_TRANSIT">–í –ø—É—Ç–∏</option>
                    <option value="ARRIVED">–ü—Ä–∏–±—ã–ª</option>
                    <option value="READY">–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ</option>
                    <option value="DELIVERED">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
                    <option value="CANCELLED">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                </select>
                <input type="text" id="admin-status-desc" name="admin-status-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width:100%; padding:12px; margin-bottom:10px; border-radius:var(--radius-md); border:1px solid var(--border);">
                <button class="btn btn-blue" onclick="updatePackageStatus()" style="width:100%;">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            </div>
            <div style="text-align:center;padding:15px;color:var(--sec);cursor:pointer;" onclick="closeM('m-admin-package')">–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
    </div>
    
    <div id="m-pool-details" class="modal-wrap">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ showPoolDetails() -->
    </div>
    
    <div id="m-avatar" class="modal-wrap">
        <div class="modal">
            <h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</h3>
            <div style="text-align:center;padding:20px;">
                <img id="avatar-preview" src="" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #007AFF; margin-bottom: 20px;">
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <button class="btn btn-blue" onclick="useTelegramPhoto()">
                        <i class="fa-brands fa-telegram"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ –∏–∑ Telegram
                    </button>
                    <button class="btn" style="background:#f2f2f2;color:#000;" onclick="document.getElementById('avatar-upload').click()">
                        <i class="fa-solid fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                    </button>
                    <input type="file" id="avatar-upload" accept="image/*" style="display:none;" onchange="handleAvatarUpload(event)">
                </div>
            </div>
            <div style="text-align:center;padding:15px;color:var(--sec);" onclick="closeM('m-avatar')">–û—Ç–º–µ–Ω–∞</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç—Å—Ç—É–ø–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –æ—Ç–∫—Ä—ã—Ç–∏—è Mini App
        function adjustViewportPadding() {
            let headerHeight = 0;
            let displayMode = 'unknown';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤—ã—Å–æ—Ç—É —à–∞–ø–∫–∏
            // –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É window.innerHeight –∏ tg.viewportHeight —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤—ã—Å–æ—Ç—É —à–∞–ø–∫–∏
            const viewportDiff = tg.viewportHeight ? (window.innerHeight - tg.viewportHeight) : 0;
            const isExpanded = tg.isExpanded === true;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if (isExpanded && viewportDiff > 60) {
                // Fullscreen —Ä–µ–∂–∏–º - –±–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ viewport, –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å" –∏ "–°–≤–µ—Ä–Ω—É—Ç—å"
                displayMode = 'fullscreen';
                headerHeight = Math.max(80, viewportDiff + 10); // 80px –∏–ª–∏ –±–æ–ª—å—à–µ –¥–ª—è –ø–æ–ª–Ω–æ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫
            } else if (isExpanded && viewportDiff > 20) {
                // Fullsize —Ä–µ–∂–∏–º - —Å—Ä–µ–¥–Ω—è—è —Ä–∞–∑–Ω–∏—Ü–∞ viewport
                displayMode = 'fullsize';
                headerHeight = Math.max(30, viewportDiff + 5); // 30px –∏–ª–∏ –±–æ–ª—å—à–µ
            } else if (viewportDiff > 0) {
                // Compact —Ä–µ–∂–∏–º - –Ω–µ–±–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ viewport
                displayMode = 'compact';
                headerHeight = Math.max(10, viewportDiff); // 10px –∏–ª–∏ –±–æ–ª—å—à–µ
            } else {
                // –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø
                displayMode = 'default';
                headerHeight = 0;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            if (headerHeight > 0) {
                document.body.style.paddingTop = `${headerHeight}px`;
                document.body.style.boxSizing = 'border-box';
                
                // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π –æ—Ç—Å—Ç—É–ø —É —ç–∫—Ä–∞–Ω–æ–≤, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —É–∂–µ –µ—Å—Ç—å –≤ body
                const screens = document.querySelectorAll('.screen');
                screens.forEach(screen => {
                    screen.style.paddingTop = '0';
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
                const containers = document.querySelectorAll('.container');
                containers.forEach(container => {
                    container.style.paddingTop = '20px';
                });
                
                // –£–±–∏—Ä–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø —É header
                const headers = document.querySelectorAll('.header');
                headers.forEach(header => {
                    header.style.marginTop = '0';
                });
                
                console.log(`Display mode: ${displayMode}, Header height: ${headerHeight}px, Viewport diff: ${viewportDiff}px`);
            } else {
                // –í —Ä–µ–∂–∏–º–µ –±–µ–∑ —à–∞–ø–∫–∏ —É–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø
                document.body.style.paddingTop = '0';
                console.log(`Display mode: ${displayMode}, No header padding`);
            }
        }
        
        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(adjustViewportPadding, 100);
            });
        } else {
            setTimeout(adjustViewportPadding, 100);
        }
        
        window.addEventListener('resize', adjustViewportPadding);
        
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è viewport –æ—Ç Telegram
        if (tg.onEvent) {
            try {
                tg.onEvent('viewportChanged', adjustViewportPadding);
            } catch(e) {
                console.log('viewportChanged event not available');
            }
        }
        
        // –¢–∞–∫–∂–µ —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
        if (tg.onEvent) {
            try {
                tg.onEvent('themeChanged', adjustViewportPadding);
            } catch(e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
            }
        }
        
        const API = "https://unforeshortened-interartistic-judith.ngrok-free.dev"; 
        const uid = tg.initDataUnsafe?.user?.id || 317295540;

        let config = {}, user = {}, isOpt = false, lastCalc = null, tabTr = 'trips', tabMk = 'item';
        let currentLang = 'ru'; // –¢–µ–∫—É—â–∏–π —è–∑—ã–∫ (ru –∏–ª–∏ tj)
        let translations = {}; // –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã
        
        /* ================= –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–• ================= */
        const cache = {
            dashboard: null,
            routes: null,
            wallet: null,
            packages: null,
            market: {},
            exchange: null,
            cacheTime: 30000, // 30 —Å–µ–∫—É–Ω–¥
            getTimestamp: () => Date.now(),
            isExpired: (timestamp) => (Date.now() - timestamp) > cache.cacheTime
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–±–µ–∑ –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–æ–∫)
        async function cachedFetch(url, cacheKey, options = {}, silent = true) {
            const now = cache.getTimestamp();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            if (cache[cacheKey] && !cache.isExpired(cache[cacheKey].timestamp)) {
                console.log(`[Cache HIT] ${cacheKey}`);
                return cache[cacheKey].data;
            }
            
            // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –±–µ–∑ –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–æ–∫ (silent mode)
            console.log(`[Cache MISS] ${cacheKey}, fetching...`);
            try {
                const response = await safeFetchSilent(url, options);
                cache[cacheKey] = {
                    data: response,
                    timestamp: now
                };
                return response;
            } catch (error) {
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (cache[cacheKey]) {
                    console.log(`[Cache FALLBACK] ${cacheKey}, using stale data`);
                    return cache[cacheKey].data;
                }
                throw error;
            }
        }
        
        // –¢–∏—Ö–∞—è –≤–µ—Ä—Å–∏—è safeFetch (–±–µ–∑ –ø–æ–∫–∞–∑–∞ popup –æ—à–∏–±–æ–∫)
        async function safeFetchSilent(url, options = {}, retries = 3) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true',
                    ...options.headers
                },
                ...options,
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                signal: AbortSignal.timeout(15000) // 15 —Å–µ–∫—É–Ω–¥
            };

            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(url, defaultOptions);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç HTML (ngrok warning page)
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('text/html') && !response.ok) {
                        console.warn(`[safeFetchSilent] Got HTML response instead of JSON, might be ngrok warning page`);
                        if (attempt < retries) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                            continue;
                        }
                        throw new Error('Server returned HTML instead of JSON');
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text().catch(() => 'Unknown error');
                        console.warn(`[safeFetchSilent] HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                        if (attempt < retries) {
                            await new Promise(resolve => setTimeout(resolve, 500 * attempt));
                            continue;
                        }
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const jsonData = await response.json().catch(e => {
                        console.error(`[safeFetchSilent] JSON parse error:`, e);
                        throw new Error('Invalid JSON response');
                    });
                    
                    return jsonData;
                } catch (error) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º AbortError (—Ç–∞–π–º–∞—É—Ç) –∏ –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
                    if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                        console.warn(`[safeFetchSilent] Request timeout (attempt ${attempt}/${retries})`);
                        if (attempt < retries) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                            continue;
                        }
                    }
                    
                    console.warn(`[safeFetchSilent] Error on attempt ${attempt}/${retries}:`, error.message);
                    if (attempt < retries) {
                        await new Promise(resolve => setTimeout(resolve, 500 * attempt));
                        continue;
                    }
                    throw error;
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞
        function invalidateCache(cacheKey) {
            if (cacheKey) {
                delete cache[cacheKey];
            } else {
                // –û—á–∏—â–∞–µ–º –≤–µ—Å—å –∫—ç—à
                Object.keys(cache).forEach(key => {
                    if (typeof cache[key] === 'object' && cache[key] !== null && 'timestamp' in cache[key]) {
                        delete cache[key];
                    }
                });
            }
        }
        
        /* ================= I18N ================= */
        async function loadTranslations() {
            try {
                const response = await fetch('data/i18n.json');
                translations = await response.json();
            } catch (e) {
                console.error('Error loading translations:', e);
                translations = { ru: {}, tj: {} };
            }
        }
        
        function t(key, defaultValue = '') {
            return translations[currentLang]?.[key] || translations['ru']?.[key] || defaultValue || key;
        }
        
        function changeLanguage(lang) {
            if (lang !== 'ru' && lang !== 'tj') return;
            currentLang = lang;
            updateLanguageIndicator();
            safeFetch(`${API}/api/update_settings`, {
                method: 'POST',
                body: JSON.stringify({ user_id: uid, language: lang })
            }).catch(e => console.error('Error saving language:', e));
        }
        
        function toggleLanguage() {
            const newLang = currentLang === 'ru' ? 'tj' : 'ru';
            changeLanguage(newLang);
            tg.showAlert(newLang === 'ru' ? '–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π' : '–ó–∞–±–æ–Ω –±–∞ —Ç–æ“∑–∏–∫”£ –∏–≤–∞–∑ –∫–∞—Ä–¥–∞ —à—É–¥');
        }
        
        function updateLanguageIndicator() {
            safe('lang-indicator', el => el.innerText = currentLang.toUpperCase());
        }

        /* ================= SAFE HELPERS ================= */
        function gid(id) { return document.getElementById(id); }

        function safe(id, cb) {
            const el = gid(id);
            if (el) cb(el);
        }

        /* ================= ERROR HANDLING ================= */
        async function showErrorPopup(message, retryCallback = null) {
            return new Promise((resolve) => {
                const buttons = retryCallback ? [
                    { id: 'retry', text: '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å', type: 'default' },
                    { id: 'cancel', text: '–û—Ç–º–µ–Ω–∞', type: 'cancel' }
                ] : [
                    { id: 'ok', text: '–û–ö', type: 'default' }
                ];
                
                tg.showPopup({
                    title: '–û—à–∏–±–∫–∞',
                    message: message,
                    buttons: buttons
                }, (buttonId) => {
                    if (buttonId === 'retry' && retryCallback) {
                        retryCallback();
                    }
                    resolve(buttonId);
                });
            });
        }

        async function safeFetch(url, options = {}, retries = 3) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true',
                    ...options.headers
                },
                ...options
            };

            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(url, defaultOptions);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status})`;
                        
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMessage = errorJson.detail || errorJson.message || errorMessage;
                        } catch (e) {
                            // –ï—Å–ª–∏ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
                            if (errorText) errorMessage = errorText.substring(0, 100);
                        }
                        
                        if (attempt < retries) {
                            // –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
                            await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                            continue;
                        }
                        
                        // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        await showErrorPopup(
                            errorMessage,
                            attempt < retries ? () => safeFetch(url, options, retries - attempt) : null
                        );
                        throw new Error(errorMessage);
                    }
                    
                    return await response.json();
                } catch (error) {
                    // –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        // –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é
                        if (attempt < retries) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                            continue;
                        }
                        
                        await showErrorPopup(
                            '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
                            attempt < retries ? () => safeFetch(url, options, retries - attempt) : null
                        );
                        throw error;
                    }
                    
                    // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
                    if (attempt === retries) {
                        await showErrorPopup(
                            error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',
                            null
                        );
                    }
                    throw error;
                }
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
        window.addEventListener('error', (event) => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            if (event.filename && (
                event.filename.includes('laikalabs') || 
                event.filename.includes('security') ||
                event.filename.includes('dapp-security')
            )) {
                console.warn('Ignored external security service error:', event.filename);
                return;
            }
            
            console.error('Global error:', event.error);
            if (event.error && !event.error.handled) {
                showErrorPopup('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            const reason = event.reason?.message || event.reason?.toString() || '';
            const url = event.reason?.url || event.reason?.config?.url || '';
            
            if (reason.includes('laikalabs') || reason.includes('security') || reason.includes('dapp-security') ||
                url.includes('laikalabs') || url.includes('dapp-security')) {
                console.warn('Ignored external security service rejection:', reason || url);
                event.preventDefault();
                return;
            }
            
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
            if (event.reason?.handled) {
                event.preventDefault();
                return;
            }
            
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∏–∑ updateCartBadge –∏ –¥—Ä—É–≥–∏—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
            if (reason.includes('cart') || reason.includes('wishlist') || reason.includes('marketplace')) {
                console.warn('Ignored marketplace background error:', reason);
                event.preventDefault();
                return;
            }
            
            console.error('Unhandled promise rejection:', event.reason);
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞
        });
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ fetch –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        // –≠—Ç–æ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Telegram, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ 500
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = typeof args[0] === 'string' ? args[0] : args[0]?.url || args[0]?.toString() || '';
            if (url.includes('laikalabs') || url.includes('dapp-security') || url.includes('security.laikalabs')) {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                console.warn('[BLOCKED] Security service request blocked:', url);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏
                return Promise.resolve(new Response(JSON.stringify({status: 'ok'}), {
                    status: 200,
                    headers: {'Content-Type': 'application/json'}
                }));
            }
            return originalFetch.apply(this, args);
        };
        
        // –¢–∞–∫–∂–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º XMLHttpRequest (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—Ä–æ—Å–æ–≤)
        const originalXHROpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
            if (typeof url === 'string' && (url.includes('laikalabs') || url.includes('dapp-security'))) {
                console.warn('[BLOCKED] XHR request to security service blocked:', url);
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
                this._blocked = true;
                return;
            }
            return originalXHROpen.apply(this, [method, url, ...rest]);
        };
        
        const originalXHRSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.send = function(...args) {
            if (this._blocked) {
                // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∏–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                setTimeout(() => {
                    Object.defineProperty(this, 'status', {value: 200, writable: false});
                    Object.defineProperty(this, 'responseText', {value: '{"status":"ok"}', writable: false});
                    Object.defineProperty(this, 'readyState', {value: 4, writable: false});
                    if (this.onload) this.onload();
                    if (this.onreadystatechange) this.onreadystatechange();
                }, 0);
                return;
            }
            return originalXHRSend.apply(this, args);
        };
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –¥–ª—è –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
        window.addEventListener('error', (event) => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
            if (event.filename && (
                event.filename.includes('laikalabs') || 
                event.filename.includes('dapp-security') ||
                event.filename.includes('security.laikalabs')
            )) {
                console.warn('Ignored network error from security service:', event.filename);
                event.preventDefault();
                return false;
            }
            
            if (event.target && event.target.tagName) {
                const src = event.target.src || event.target.href || '';
                if (src.includes('laikalabs') || src.includes('security') || src.includes('dapp-security')) {
                    console.warn('Ignored external security service resource error:', src);
                    event.preventDefault();
                    return false;
                }
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                if (event.target.tagName === 'IMG' && event.target.src) {
                    const img = event.target;
                    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ placeholder –∏ –Ω–µ base64, –ø—Ä–æ–±—É–µ–º –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ placeholder
                    if (!img.src.includes('ui-avatars.com') && !img.src.startsWith('data:')) {
                        const firstName = tg.initDataUnsafe?.user?.first_name || 'User';
                        const altText = img.alt || img.title || firstName;
                        const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(altText)}&size=200&background=007AFF&color=fff`;
                        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
                        if (img.src !== fallbackUrl) {
                            img.src = fallbackUrl;
                        } else {
                            // –ï—Å–ª–∏ –∏ fallback –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, —Å–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            img.style.display = 'none';
                            img.style.backgroundColor = '#f0f0f0';
                        }
                    }
                }
            }
        }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        window.setImageSafe = function(imgEl, src, fallback) {
            if (!imgEl || !imgEl.tagName || imgEl.tagName !== 'IMG') return;
            
            if (!fallback) {
                const firstName = tg.initDataUnsafe?.user?.first_name || 'User';
                fallback = `https://ui-avatars.com/api/?name=${encodeURIComponent(firstName)}&size=200&background=007AFF&color=fff`;
            }
            
            let errorCount = 0;
            imgEl.onerror = function() {
                errorCount++;
                if (errorCount === 1 && this.src !== fallback) {
                    this.src = fallback;
                } else {
                    this.style.display = 'none';
                    this.style.backgroundColor = '#f0f0f0';
                }
            };
            
            imgEl.onload = function() {
                this.style.display = '';
                errorCount = 0;
            };
            
            if (src && src.trim()) {
                imgEl.src = src;
            } else {
                imgEl.src = fallback;
            }
        };

        /* ================= FONT AWESOME CHECK ================= */
        function checkFontAwesome() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Font Awesome CSS
            const faStylesheet = Array.from(document.styleSheets).find(sheet => {
                try {
                    return sheet.href && (sheet.href.includes('font-awesome') || sheet.href.includes('fontawesome'));
                } catch(e) {
                    return false;
                }
            });
            
            if (!faStylesheet) {
                console.warn('Font Awesome stylesheet –Ω–µ –Ω–∞–π–¥–µ–Ω');
                applyFontAwesomeFallback();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ª–∏ Font Awesome —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É —à—Ä–∏—Ñ—Ç–∞
            const testIcon = document.createElement('i');
            testIcon.className = 'fa-solid fa-check';
            testIcon.style.position = 'absolute';
            testIcon.style.visibility = 'hidden';
            testIcon.style.fontSize = '16px';
            testIcon.style.left = '-9999px';
            document.body.appendChild(testIcon);
            
            setTimeout(() => {
                try {
                    const computedStyle = window.getComputedStyle(testIcon, ':before');
                    const fontFamily = computedStyle.getPropertyValue('font-family') || '';
                    const content = computedStyle.getPropertyValue('content') || '';
                    
                    document.body.removeChild(testIcon);
                    
                    // –ï—Å–ª–∏ Font Awesome –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (–Ω–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ font-family –∏–ª–∏ content)
                    if ((!fontFamily.includes('Font Awesome') && !fontFamily.includes('FontAwesome')) || content === 'none' || content === '' || content === '""') {
                        console.warn('Font Awesome —à—Ä–∏—Ñ—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –ø—Ä–∏–º–µ–Ω—è–µ–º fallback');
                        applyFontAwesomeFallback();
                    }
                } catch(e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ Font Awesome:', e);
                    document.body.removeChild(testIcon);
                    applyFontAwesomeFallback();
                }
            }, 1000);
        }
        
        function applyFontAwesomeFallback() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω –ª–∏ —É–∂–µ fallback
            if (document.getElementById('fa-fallback')) {
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º fallback —Å—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ —Å —ç–º–æ–¥–∑–∏
            const style = document.createElement('style');
            style.id = 'fa-fallback';
            style.textContent = `
                .fa-solid.fa-arrow-left:before { content: '‚Üê'; }
                .fa-solid.fa-warehouse:before { content: 'üè≠'; }
                .fa-solid.fa-box-open:before { content: 'üì¶'; }
                .fa-solid.fa-map-location-dot:before { content: 'üìç'; }
                .fa-solid.fa-users:before { content: 'üë•'; }
                .fa-solid.fa-hand:before { content: '‚úã'; }
                .fa-solid.fa-tags:before { content: 'üè∑Ô∏è'; }
                .fa-solid.fa-comment-dots:before { content: 'üí¨'; }
                .fa-solid.fa-building:before { content: 'üè¢'; }
                .fa-solid.fa-star-half-stroke:before { content: '‚≠ê'; }
                .fa-solid.fa-truck-fast:before { content: 'üöõ'; }
                .fa-solid.fa-bag-shopping:before { content: 'üõçÔ∏è'; }
                .fa-solid.fa-calculator:before { content: 'üßÆ'; }
                .fa-solid.fa-gift:before { content: 'üéÅ'; }
                .fa-solid.fa-chevron-right:before { content: '‚Ä∫'; }
                .fa-solid.fa-star:before { content: '‚≠ê'; }
                .fa-solid.fa-gear:before { content: '‚öôÔ∏è'; }
                .fa-solid.fa-qrcode:before { content: 'üì±'; }
                .fa-solid.fa-camera:before { content: 'üì∑'; }
                .fa-solid.fa-user-pen:before { content: '‚úèÔ∏è'; }
                .fa-solid.fa-plus:before { content: '‚ûï'; }
                .fa-solid.fa-fire:before { content: 'üî•'; }
                .fa-solid.fa-droplet:before { content: 'üíß'; }
                .fa-solid.fa-gun:before { content: 'üî´'; }
                .fa-solid.fa-pills:before { content: 'üíä'; }
                .fa-solid.fa-battery-half:before { content: 'üîã'; }
                .fa-solid.fa-apple-whole:before { content: 'üçé'; }
                .fa-solid.fa-shield-halved:before { content: 'üõ°Ô∏è'; }
                .fa-brands.fa-telegram:before { content: '‚úàÔ∏è'; }
                .fa-solid.fa-upload:before { content: 'üì§'; }
                .fa-regular.fa-copy:before { content: 'üìã'; }
                .fa-solid.fa-bolt:before { content: '‚ö°'; }
                .fa-solid.fa-info-circle:before { content: '‚ÑπÔ∏è'; }
                .icon-box i, .fa-solid, .fa-brands, .fa-regular {
                    font-family: Arial, sans-serif !important;
                    font-style: normal !important;
                    font-weight: normal !important;
                }
            `;
            document.head.appendChild(style);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Font Awesome –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(checkFontAwesome, 1000);
            });
        } else {
            setTimeout(checkFontAwesome, 1000);
        }

        /* ================= INIT ================= */
        let initRetryCount = 0;
        const MAX_INIT_RETRIES = 3;
        
        async function init(useCacheOnly = false) {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫—ç—à
                if (!useCacheOnly) {
                    showLoadingIndicator();
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –∏–∑ Telegram –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ
                const telegramPhoto = tg.initDataUnsafe?.user?.photo_url || "";
                const firstName = tg.initDataUnsafe?.user?.first_name || "Client";
                const defaultAva = `https://ui-avatars.com/api/?name=${firstName}`;
                
                // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                let dashboardData, walletData, routesData;
                let hasError = false;
                
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
                    [dashboardData, walletData, routesData] = await Promise.all([
                        cachedFetch(`${API}/api/dashboard/${uid}`, 'dashboard').catch(() => null),
                        cachedFetch(`${API}/api/wallet/${uid}`, 'wallet').catch(() => null),
                        cachedFetch(`${API}/api/get_routes`, 'routes').catch(() => null)
                    ]);
                } catch (error) {
                    console.error('Error loading initial data:', error);
                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
                }
                
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
                if (!dashboardData && cache.dashboard && cache.dashboard.data) {
                    console.log('[INIT] Using cached dashboard data');
                    dashboardData = cache.dashboard.data;
                }
                
                if (!walletData && cache.wallet && cache.wallet.data) {
                    walletData = cache.wallet.data;
                }
                
                if (!routesData && cache.routes && cache.routes.data) {
                    routesData = cache.routes.data;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ dashboard –∑–∞–≥—Ä—É–∑–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ
                if (!dashboardData || dashboardData.status !== 'ok') {
                    // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–∞–∂–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ)
                    if (cache.dashboard && cache.dashboard.data) {
                        console.log('[INIT] Using cached dashboard data (status check)');
                        dashboardData = cache.dashboard.data;
                    } else {
                        // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤–æ–æ–±—â–µ - —Å–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–±–æ—Ç—ã
                        console.warn('[INIT] No data available, creating minimal dataset');
                        dashboardData = {
                            status: 'ok',
                            user_info: {
                                name: firstName,
                                user_id: String(uid),
                                level: '–ù–æ–≤–∏—á–æ–∫',
                                bonus_kg: 0,
                                marking_code: '–ó–∞–≥—Ä—É–∑–∫–∞...',
                                category: 'less_100',
                                avatar_url: telegramPhoto || defaultAva
                            },
                            packages: [],
                            app_config: {
                                warehouses: [],
                                pvz_list: [],
                                routes: []
                            }
                        };
                    }
                }
                
                const data = dashboardData;
                config = data.app_config || {};
                user = data.user_info || {};
                
                // –ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏ –≤ dashboard, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                if (!config.routes && routesData && routesData.routes) {
                    config.routes = routesData.routes;
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞–≤–∞—Ç–∞—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ Telegram —Ñ–æ—Ç–æ, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ
                const ava = user.avatar_url || telegramPhoto || defaultAva;
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
                const setImageWithFallback = (imgEl, src, fallback) => {
                    if (!imgEl) return;
                    imgEl.onerror = () => {
                        if (imgEl.src !== fallback) {
                            imgEl.src = fallback;
                        } else {
                            // –ï—Å–ª–∏ –∏ fallback –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
                            imgEl.style.display = 'none';
                            imgEl.alt = 'Image not available';
                        }
                    };
                    imgEl.onload = () => {
                        imgEl.style.display = '';
                    };
                    if (src && src.trim()) {
                        imgEl.src = src;
                    } else {
                        imgEl.src = fallback;
                    }
                };
                
                safe('u-ava', el => setImageWithFallback(el, ava, defaultAva));
                safe('p-ava', el => {
                    setImageWithFallback(el, ava, defaultAva);
                    el.style.cursor = 'pointer';
                    el.onclick = () => editAvatar();
                });

                safe('u-name', el => el.innerText = user.name || firstName);
                safe('u-lvl', el => el.innerText = user.level || '–ù–æ–≤–∏—á–æ–∫');
                safe('u-bonus', el => el.innerText = user.bonus_kg || 0);
                safe('txt-code', el => {
                    const code = user.marking_code || '–ó–∞–≥—Ä—É–∑–∫–∞...';
                    el.innerText = code;
                    if (code === '–ó–∞–≥—Ä—É–∑–∫–∞...') {
                        el.style.color = '#8E8E93';
                    } else {
                        el.style.color = '#F57F17';
                    }
                });

                safe('p-name', el => el.innerText = user.name || firstName);
                safe('p-id', el => el.innerText = user.user_id);
                safe('p-bonus', el => el.innerText = user.bonus_kg || 0);
                safe('p-lvl-tag', el => el.innerText = user.level || '–ù–æ–≤–∏—á–æ–∫');
                safe('p-status-name', el => el.innerText = user.level || '–ù–æ–≤–∏—á–æ–∫');

                renderPvzOptions(config.pvz_list, user.pvz_id);
                renderPackageList(d.packages);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã
                if (config.routes && config.routes.length > 0) {
                    renderRoutes(config.routes);
                } else {
                    // –ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –ø—Ä–∏—à–ª–∏, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ
                    loadRoutes();
                }

                isOpt = user.category === 'more_100';
                updMode();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                renderAddr();

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∞ –∏–∑ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if (walletData && walletData.status === 'ok' && walletData.balances) {
                    const b = walletData.balances;
                    const tjs = Number(b.tjs || 0);
                    const usd = Number(b.usd || 0);
                    const bonus = Number(b.bonus_kg || 0);
                    safe('u-bonus', el => el.innerText = bonus.toFixed(2));
                    safe('u-balance-tjs', el => el.innerText = tjs.toFixed(2));
                    safe('u-balance-usd', el => el.innerText = usd.toFixed(2));
                } else {
                    loadWallet();
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                hideLoadingIndicator();
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ç–∏—Ö–æ, –±–µ–∑ –æ—à–∏–±–æ–∫)
                updateCartBadge().catch(() => {});
            } catch (e) {
                console.error('[INIT] Error during initialization:', e);
                hideLoadingIndicator();
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –∫–æ—Ä–∑–∏–Ω—ã –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ (—Ç–∏—Ö–æ)
                updateCartBadge().catch(() => {});
                
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (cache.dashboard && cache.dashboard.data) {
                    console.log('[INIT] Using cached data after error');
                    try {
                        const data = cache.dashboard.data;
                        config = data.app_config || {};
                        user = data.user_info || {
                            name: firstName,
                            user_id: String(uid),
                            level: '–ù–æ–≤–∏—á–æ–∫',
                            bonus_kg: 0,
                            marking_code: '–ó–∞–≥—Ä—É–∑–∫–∞...',
                            category: 'less_100',
                            avatar_url: telegramPhoto || defaultAva
                        };
                        
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                        const ava = user.avatar_url || telegramPhoto || defaultAva;
                        safe('u-ava', el => {
                            if (el) {
                                el.onerror = () => { if (el.src !== defaultAva) el.src = defaultAva; };
                                el.src = ava || defaultAva;
                            }
                        });
                        safe('u-name', el => el.innerText = user.name || firstName);
                        safe('u-lvl', el => el.innerText = user.level || '–ù–æ–≤–∏—á–æ–∫');
                        safe('u-bonus', el => el.innerText = user.bonus_kg || 0);
                    } catch (cacheError) {
                        console.error('[INIT] Error using cache:', cacheError);
                    }
                } else {
                    // –ù–µ—Ç –∫—ç—à–∞ - —Å–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
                    console.warn('[INIT] No cache available, using minimal data');
                    config = {
                        warehouses: [],
                        pvz_list: [],
                        routes: []
                    };
                    user = {
                        name: firstName,
                        user_id: String(uid),
                        level: '–ù–æ–≤–∏—á–æ–∫',
                        bonus_kg: 0,
                        marking_code: '–ó–∞–≥—Ä—É–∑–∫–∞...',
                        category: 'less_100',
                        avatar_url: telegramPhoto || defaultAva
                    };
                    
                    const ava = user.avatar_url || telegramPhoto || defaultAva;
                    safe('u-ava', el => {
                        if (el) {
                            el.onerror = () => { if (el.src !== defaultAva) el.src = defaultAva; };
                            el.src = ava || defaultAva;
                        }
                    });
                    safe('u-name', el => el.innerText = user.name || firstName);
                    safe('u-lvl', el => el.innerText = user.level || '–ù–æ–≤–∏—á–æ–∫');
                    safe('u-bonus', el => el.innerText = user.bonus_kg || 0);
                }
            }
        }
        
        /* ================= –ò–ù–î–ò–ö–ê–¢–û–†–´ –ó–ê–ì–†–£–ó–ö–ò ================= */
        function showLoadingIndicator() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω –∏–ª–∏ —Å–ø–∏–Ω–Ω–µ—Ä –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            safe('u-name', el => el.innerText = '...');
            safe('u-bonus', el => el.innerText = '...');
            safe('u-balance-tjs', el => el.innerText = '...');
            safe('u-balance-usd', el => el.innerText = '...');
        }
        
        function hideLoadingIndicator() {
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        }
        
        let updateWalletUI = (balances) => {
            const tjs = Number(balances.tjs || balances.balance_tjs || 0);
            const usd = Number(balances.usd || balances.balance_usd || 0);
            safe('u-balance-tjs', el => el.innerText = tjs.toFixed(2));
            safe('u-balance-usd', el => el.innerText = usd.toFixed(2));
        };

        /* ================= MODE ================= */
        function toggleMode() {
            const calcActive = gid('screen-calc')?.classList.contains('active');
            const src = calcActive ? gid('tg-calc') : gid('tg-opt');

            isOpt = src ? src.checked : isOpt;
            updMode();

            fetch(`${API}/api/update_settings`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    user_id: uid,
                    category: isOpt ? 'more_100' : 'less_100'
                })
            });
        }

        function updMode() {
            safe('tg-opt', el => el.checked = isOpt);
            safe('tg-calc', el => el.checked = isOpt);
            safe('sel-city', el => el.style.display = isOpt ? 'block' : 'none');
            safe('box-code', el => el.style.display = isOpt ? 'none' : 'block');
            safe('box-calc-opt', el => el.style.display = isOpt ? 'block' : 'none');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –æ–ø—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
            if (isOpt && config.routes) {
                renderRoutes(config.routes);
            } else if (isOpt && !config.routes) {
                // –ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
                loadRoutes();
            }

            if (gid('screen-addresses')?.classList.contains('active')) {
                renderAddr();
            }
        }
        
        async function loadRoutes() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
            try {
                const routesData = await cachedFetch(`${API}/api/get_routes`, 'routes');
                if (routesData && routesData.routes) {
                    config.routes = routesData.routes;
                    renderRoutes(routesData.routes);
                }
            } catch (e) {
                console.error('Load routes error:', e);
            }
        }

        /* ================= ADDRESSES ================= */
        function renderAddr() {
            safe('txt-addr', el => {
                if (!config || !config.warehouses) {
                    el.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
                    return;
                }

                if (isOpt) {
                    const city = gid('sel-city')?.value || 'yiwu';
                    const addr = config.warehouses?.wholesale?.[city]?.address;
                    el.innerText = addr || '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥';
                } else {
                    const addr = config.warehouses?.retail?.address;
                    if (addr) {
                        el.innerText = addr;
                    } else {
                        console.error('Retail address not found:', config.warehouses);
                        el.innerText = '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.';
                    }
                }
            });
        }

        /* ================= SMART COPY FOR MARKETPLACES ================= */
        function smartCopyAddress() {
            if (!config.warehouses || !user.marking_code) {
                tg.showAlert('–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                return;
            }

            let addressText = '';
            
            if (isOpt) {
                const city = gid('sel-city')?.value || 'yiwu';
                const warehouse = config.warehouses?.wholesale?.[city];
                if (!warehouse || !warehouse.address) {
                    tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ —Å–∫–ª–∞–¥–∞');
                    return;
                }
                // –î–ª—è –æ–ø—Ç–∞: –∞–¥—Ä–µ—Å + –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –≤ –∫–æ–Ω—Ü–µ (—Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∫–∏—Ç–∞–π—Å–∫–∏—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤)
                // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                const cleanAddr = warehouse.address.replace(/\n+/g, '\n').trim();
                addressText = `${cleanAddr}\n\n„ÄêÊ†áËÆ∞Á†Å Marking ID„Äë\n${user.marking_code}`;
            } else {
                // –î–ª—è —Ä–æ–∑–Ω–∏—Ü—ã: –∞–¥—Ä–µ—Å + –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞
                const retailAddr = config.warehouses?.retail?.address;
                if (!retailAddr) {
                    tg.showAlert('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å –¥–ª—è —Ä–æ–∑–Ω–∏—Ü—ã
                const cleanAddr = retailAddr.replace(/\n+/g, '\n').trim();
                addressText = `${cleanAddr}\n\n„ÄêÊ†áËÆ∞Á†Å Marking ID„Äë\n${user.marking_code}`;
            }

            // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            navigator.clipboard.writeText(addressText).then(() => {
                // Haptic feedback
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
                tg.showAlert('‚úÖ –ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!\n\n–í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø–æ–ª–µ –∞–¥—Ä–µ—Å–∞ –Ω–∞ Taobao/Pinduoduo\n\n‚ö†Ô∏è –ù–µ –∑–∞–±—É–¥—å—Ç–µ —É–∫–∞–∑–∞—Ç—å Marking ID!');
            }).catch(err => {
                console.error('Copy error:', err);
                tg.showAlert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.');
            });
        }

        /* ================= CALC ================= */
        async function doCalc() {
            const wg = parseFloat(gid('c-wg')?.value || 0);
            const qty = parseInt(gid('c-qty')?.value || 1);

            if (!wg) return tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å');

            let routeFrom = "üá®üá≥ –ö–∏—Ç–∞–π";
            let routeTo = "üáπüáØ –•—É–¥–∂–∞–Ω–¥";

            if (isOpt) {
                const route = gid('sel-route')?.value;
                if (route && route.includes(' - ')) {
                    [routeFrom, routeTo] = route.split(' - ');
                }
            }

            const p = {
                user_id: uid,
                weight: wg,
                quantity: qty,
                category: isOpt ? 'more_100' : 'less_100',
                length: parseFloat(gid('c-len')?.value || 0),
                width: parseFloat(gid('c-wid')?.value || 0),
                height: parseFloat(gid('c-hei')?.value || 0),
                route_from: routeFrom,
                route_to: routeTo
            };

            try {
                const j = await safeFetch(`${API}/api/calculate`, {
                    method: 'POST',
                    body: JSON.stringify(p)
                });

                if (j.status === 'ok') {
                    const price = typeof j.price === 'number' ? j.price : parseFloat(j.price) || 0;
                    safe('c-res', el => el.innerText = price.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                    safe('c-cur', el => el.innerText = j.currency || 'TJS');
                    safe('btn-order-confirm', el => el.style.display = 'block');
                    lastCalc = {...p, price: price, route: `${routeFrom} - ${routeTo}`};
                } else {
                    tg.showAlert(j.message || '–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞');
                }
            } catch (e) {
                console.error('Calc error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞');
            }
        }

        /* ================= HELPERS ================= */
        function renderPackageList(pkgs) {
            console.log('renderPackageList called with:', pkgs); // –û—Ç–ª–∞–¥–∫–∞
            let h = '';
            if (pkgs && Array.isArray(pkgs) && pkgs.length > 0) {
                pkgs.forEach(p => {
                    if (!p) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º null/undefined
                    let stClass = (p.status_text && (p.status_text.includes('–ü—Ä–∏–±—ã–ª') || p.status_text.includes('–û–º–∞–¥'))) ? 'status-ready' : '';
                    const pkgId = p.id || p.track_number || 'unknown';
                    const trackNum = p.track_number || '–ë–µ–∑ —Ç—Ä–µ–∫–∞';
                    const desc = p.description || t('packages', '–ü–æ—Å—ã–ª–∫–∞');
                    const statusText = p.status_text || p.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    h += `<div class="pkg-item" onclick="showPackageHistory('${pkgId}')" style="cursor:pointer;"><div class="pkg-info"><div class="pkg-name">${desc}</div><div class="pkg-sub">${trackNum}</div></div><div class="pkg-status ${stClass}">${statusText}</div><i class="fa-solid fa-chevron-right" style="color:var(--sec); font-size:12px;"></i></div>`;
                });
            } else { 
                h = `<div style="text-align:center;padding:20px;color:#8e8e93;">${t('no_packages', '–ü–æ—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç')}</div>`; 
            }
            safe('full-pkg-list', el => {
                if (el) {
                    el.innerHTML = h;
                } else {
                    console.error('Element full-pkg-list not found');
                }
            });
        }
        
        async function showPackageHistory(packageId) {
            try {
                const d = await safeFetch(`${API}/api/package/${packageId}/history`);
                if (d.status !== 'ok') {
                    tg.showAlert(t('error_unknown', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏'));
                    return;
                }
                
                const pkg = d.package;
                const history = d.history || [];
                
                const statusNames = {
                    'AWAITING_IU': t('status_awaiting_iu', '–û–∂–∏–¥–∞–µ—Ç –≤ –ò—É'),
                    'IN_TRANSIT': t('status_in_transit', '–í –ø—É—Ç–∏'),
                    'ARRIVED': t('status_arrived', '–ü—Ä–∏–±—ã–ª'),
                    'READY': t('status_ready', '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ'),
                    'DELIVERED': t('status_delivered', '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'),
                    'CANCELLED': t('status_cancelled', '–û—Ç–º–µ–Ω–µ–Ω–æ')
                };
                
                const statusEmojis = {
                    'AWAITING_IU': 'üì¶', 'IN_TRANSIT': 'üöõ', 'ARRIVED': 'üè¢',
                    'READY': '‚úÖ', 'DELIVERED': 'üéâ', 'CANCELLED': '‚ùå'
                };
                
                let historyHTML = `
                    <div class="card" style="margin-bottom:16px;">
                        <div style="font-weight:700; font-size:16px; margin-bottom:8px;">${pkg.description || t('packages', '–ü–æ—Å—ã–ª–∫–∞')}</div>
                        <div style="font-size:13px; color:var(--sec); margin-bottom:4px;">${t('packages', '–¢—Ä–µ–∫')}: <code>${pkg.track_number}</code></div>
                        <div style="font-size:13px; color:var(--sec);">${t('current_status', '–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å')}: <b>${statusNames[pkg.current_status] || pkg.current_status}</b></div>
                    </div>
                    <div class="card" style="padding:0;">
                        <div style="padding:16px; border-bottom:1px solid var(--border); font-weight:700;">${t('status_history', '–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤')}</div>
                `;
                
                if (history.length === 0) {
                    historyHTML += `<div style="padding:20px; text-align:center; color:var(--sec);">${t('no_history', '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞')}</div>`;
                } else {
                    history.forEach((item, index) => {
                        const isLast = index === 0;
                        const statusName = statusNames[item.status] || item.status;
                        const emoji = statusEmojis[item.status] || 'üì¶';
                        historyHTML += `
                            <div style="padding:16px; border-bottom:${index < history.length - 1 ? '1px solid var(--border)' : 'none'}; display:flex; gap:12px; align-items:start;">
                                <div style="width:32px; height:32px; background:${isLast ? 'linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%)' : 'var(--bg)'}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0;">${emoji}</div>
                                <div style="flex:1;">
                                    <div style="font-weight:${isLast ? '700' : '600'}; font-size:${isLast ? '15px' : '14px'}; margin-bottom:4px;">${statusName}</div>
                                    ${item.description ? `<div style="font-size:12px; color:var(--sec); margin-bottom:4px;">${item.description}</div>` : ''}
                                    <div style="font-size:11px; color:var(--sec);">${item.created_at}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                historyHTML += '</div>';
                
                safe('m-package-history', el => {
                    const existing = el.querySelector('.modal-content');
                    if (existing) existing.remove();
                    const content = document.createElement('div');
                    content.className = 'modal-content';
                    content.innerHTML = historyHTML;
                    el.querySelector('.modal').insertBefore(content, el.querySelector('.modal').lastElementChild);
                    openM('m-package-history');
                });
            } catch(e) {
                console.error('Package history error:', e);
            }
        }

        function renderPvzOptions(list, currentId) {
            safe('s-pvz', sel => {
                sel.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>';
                if (list) list.forEach(p => {
                    let opt = document.createElement('option'); opt.value = p.id; opt.innerText = p.name;
                    if (p.id == currentId) opt.selected = true;
                    sel.appendChild(opt);
                });
            });
        }

        function renderRoutes(routes) {
            console.log('renderRoutes called with:', routes); // –û—Ç–ª–∞–¥–∫–∞
            safe('sel-route', sel => {
                if (!sel) {
                    console.error('Element sel-route not found');
                    return;
                }
                sel.innerHTML = '';
                if (routes && Array.isArray(routes) && routes.length > 0) {
                routes.forEach(r => {
                        if (r) { // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null/undefined
                    let opt = document.createElement('option');
                            opt.value = r;
                            opt.innerText = r;
                    sel.appendChild(opt);
                        }
                    });
                    console.log(`Loaded ${routes.length} routes`); // –û—Ç–ª–∞–¥–∫–∞
                } else {
                    console.warn('No routes to render or routes is not an array');
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    let opt = document.createElement('option');
                    opt.value = '';
                    opt.innerText = '–ú–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';
                    sel.appendChild(opt);
                }
            });
        }

        let isAdmin = false;
        let currentAdminPackage = null;
        
        async function checkAdmin() {
            try {
                const d = await safeFetch(`${API}/api/admin/check?telegram_id=${uid}`);
                isAdmin = d.is_admin || false;
                if (isAdmin) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏ –≤ –º–µ–Ω—é
                    const adminBtn = document.createElement('div');
                    adminBtn.className = 'grid-item';
                    adminBtn.innerHTML = '<div class="icon-box" style="color: #FF2D55;"><i class="fa-solid fa-shield-halved"></i></div><span class="grid-lbl">–ê–¥–º–∏–Ω</span>';
                    adminBtn.onclick = () => nav('admin');
                    adminBtn.style.display = 'none';
                    adminBtn.id = 'admin-menu-btn';
                    const grid = document.querySelector('.grid');
                    if (grid) grid.appendChild(adminBtn);
                    adminBtn.style.display = 'block';
                }
            } catch(e) {
                console.error('Admin check error:', e);
            }
        }
        
        async function loadAdminPackages() {
            safe('admin-packages-list', async el => {
                el.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                try {
                    const d = await safeFetch(`${API}/api/admin/packages?telegram_id=${uid}`);
                    if (d.status !== 'ok' || !d.packages) {
                        el.innerHTML = '<div style="text-align:center;padding:20px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                        return;
                    }
                    
                    if (d.packages.length === 0) {
                        el.innerHTML = '<div style="text-align:center;padding:20px;color:#8e8e93;">–ü–æ—Å—ã–ª–æ–∫ –Ω–µ—Ç</div>';
                        return;
                    }
                    
                    let h = '';
                    d.packages.forEach(p => {
                        h += `
                            <div class="pkg-item" onclick="openAdminPackage(${p.id})" style="cursor:pointer;">
                                <div class="pkg-info">
                                    <div class="pkg-name">${p.description || '–ü–æ—Å—ã–ª–∫–∞'}</div>
                                    <div class="pkg-sub">${p.track_number} | ID: ${p.user_id}</div>
                                </div>
                                <div class="pkg-status">${p.status_text}</div>
                            </div>
                        `;
                    });
                    el.innerHTML = h;
                } catch(e) {
                    console.error('Load admin packages error:', e);
                    el.innerHTML = '<div style="text-align:center;padding:20px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            });
        }
        
        async function openAdminPackage(packageId) {
            try {
                const d = await safeFetch(`${API}/api/package/${packageId}/history`);
                if (d.status !== 'ok') {
                    tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—ã–ª–∫–∏');
                    return;
                }
                
                currentAdminPackage = d.package;
                const pkg = d.package;
                
                safe('admin-pkg-title', el => el.innerText = `–ü–æ—Å—ã–ª–∫–∞ #${pkg.id}`);
                safe('admin-pkg-info', el => {
                    el.innerHTML = `
                        <div><b>–¢—Ä–µ–∫:</b> ${pkg.track_number}</div>
                        <div><b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${pkg.user_id}</div>
                        <div><b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> ${pkg.description || '–ù–µ—Ç'}</div>
                        <div><b>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</b> ${pkg.current_status}</div>
                    `;
                });
                safe('admin-status-select', el => el.value = pkg.current_status);
                openM('m-admin-package');
            } catch(e) {
                console.error('Open admin package error:', e);
            }
        }
        
        async function searchPackageByTrack() {
            const track = gid('admin-track-input')?.value?.trim();
            if (!track) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä');
                return;
            }
            
            try {
                const d = await safeFetch(`${API}/api/admin/package/${track}?telegram_id=${uid}`);
                if (d.status !== 'ok') {
                    tg.showAlert('–ü–æ—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                await openAdminPackage(d.package.id);
            } catch(e) {
                console.error('Search package error:', e);
            }
        }
        
        function openAdminScanner() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram WebApp –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR
            if (tg.showScanQrPopup) {
                tg.showScanQrPopup({
                    text: '–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–æ–º'
                }, (qrText) => {
                    if (qrText) {
                        safe('admin-track-input', el => el.value = qrText);
                        searchPackageByTrack();
                    }
                });
            } else {
                tg.showAlert('QR-—Å–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é.');
            }
        }
        
        async function updatePackageStatus() {
            if (!currentAdminPackage) return;
            
            const newStatus = gid('admin-status-select')?.value;
            const description = gid('admin-status-desc')?.value?.trim() || null;
            
            if (!newStatus) {
                tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å');
                return;
            }
            
            try {
                const d = await safeFetch(`${API}/api/admin/package/update_status`, {
                    method: 'POST',
                    body: JSON.stringify({
                        telegram_id: uid,
                        package_id: currentAdminPackage.id,
                        new_status: newStatus,
                        description: description
                    })
                });
                
                if (d.status === 'ok') {
                    tg.showAlert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    closeM('m-admin-package');
                    loadAdminPackages();
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                }
            } catch(e) {
                console.error('Update status error:', e);
            }
        }

        function nav(id) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (—Ç–∏—Ö–æ, –±–µ–∑ –æ—à–∏–±–æ–∫)
            if (id !== 'cart') {
                updateCartBadge().catch(() => {});
            }
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            safe('screen-' + id, el => el.classList.add('active'));
            // –ë–∏—Ä–∂–∞
            if(id === 'trucks') {
                // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–∏—Ä–∂–∏ - –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º
            } else if(id === 'trucks-orders') {
                ldTr(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–¥–µ–ª–∫–∏
            } else if(id === 'trucks-trips') {
                ldTrTrips(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—à–∏–Ω—ã
            } else if(id === 'trucks-cargo') {
                ldTrCargo(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–∑—ã
            } else if(id === 'trucks-history') {
                ldTrHistory(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            }
            
            // –ú–∞—Ä–∫–µ—Ç
            if(id === 'market') {
                // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –º–∞—Ä–∫–µ—Ç–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º
            } else if(id === 'market-products') {
                ldMk(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
            } else if(id === 'market-pools') {
                loadPools(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–±–æ—Ä—ã
            } else if(id === 'market-wishlist') {
                loadWishlist(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            } else if(id === 'market-categories') {
                loadCategories(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            } else if(id === 'market-sellers') {
                loadSellers(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥–∞–≤—Ü–æ–≤
            }
            
            // –†–∞—Å—á–µ—Ç
            if(id === 'calc') {
                // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ä–∞—Å—á–µ—Ç–æ–≤ - –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º
            } else if(id === 'calc-calculator') {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                if (isOpt && (!config.routes || config.routes.length === 0)) {
                    loadRoutes();
                } else if (isOpt && config.routes) {
                    renderRoutes(config.routes);
                }
            } else if(id === 'calc-history') {
                loadCalcHistory(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—á–µ—Ç–æ–≤
            }
            
            // –û–±—â–∏–µ —ç–∫—Ä–∞–Ω—ã
            if(id === 'rewards') ldRew();
            if(id === 'addresses') renderAddr(); // –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —ç–∫—Ä–∞–Ω
            if(id === 'wallet') {
                loadWallet();
                loadWalletHistory();
            }
            if(id === 'admin') {
                loadAdminPackages();
            }
            if(id === 'packages') {
                loadPackages(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—ã–ª–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —ç–∫—Ä–∞–Ω
            }
            if(id === 'cart') {
                loadCart();
            }
            if(id === 'orders') {
                loadOrders();
            }
            window.scrollTo(0,0);
        }
        
        async function loadPackages() {
            safe('full-pkg-list', el => el.innerHTML = '<div style="text-align:center;padding:20px;color:#8e8e93;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>');
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
                const data = await cachedFetch(`${API}/api/dashboard/${uid}`, 'dashboard');
                console.log('Dashboard data:', data); // –û—Ç–ª–∞–¥–∫–∞
                if (data.status === 'ok' && data.packages) {
                    console.log('Packages found:', data.packages.length); // –û—Ç–ª–∞–¥–∫–∞
                    renderPackageList(data.packages);
                } else {
                    console.log('No packages in response or error status'); // –û—Ç–ª–∞–¥–∫–∞
                    safe('full-pkg-list', el => el.innerHTML = `<div style="text-align:center;padding:20px;color:#8e8e93;">${t('no_packages', '–ü–æ—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç')}</div>`);
                }
            } catch(e) {
                console.error('Load packages error:', e);
                safe('full-pkg-list', el => el.innerHTML = '<div style="text-align:center;padding:20px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—ã–ª–æ–∫</div>');
            }
        }

        function goHome() { nav('home'); }
        function openM(id) { safe(id, el => el.style.display = 'flex'); }
        function closeM(id) { safe(id, el => el.style.display = 'none'); }
        function copy(t) { 
            safe(t, el => { 
                navigator.clipboard.writeText(el.innerText).then(() => {
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                    tg.showAlert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
                }).catch(err => {
                    console.error('Copy error:', err);
                    tg.showAlert("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è");
                });
            }); 
        }

        async function ldTr() {
            safe('list-trucks', async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º P2P-—Å–¥–µ–ª–∫–∏ (–∞–∫—Ç–∏–≤–Ω—ã–µ)
                    let d = await safeFetch(`${API}/api/exchange/list?user_id=${uid}`);
                    c.innerHTML = '';
                    if(!d.orders || d.orders.length === 0) {
                        c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫</div>';
                        return;
                    }
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
                    const activeOrders = d.orders.filter(o => o.status !== 'COMPLETED' && o.status !== 'CANCELLED');
                    if (activeOrders.length === 0) {
                        c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –Ω–µ—Ç</div>';
                        return;
                    }
                    
                    activeOrders.forEach(o => {
                            const statusColors = {
                                'PENDING': '#FF9500',
                                'ACCEPTED': '#007AFF',
                                'HOLD': '#5856D6',
                                'COMPLETED': '#34C759',
                                'CANCELLED': '#FF3B30'
                            };
                            const statusTexts = {
                                'PENDING': '–û–∂–∏–¥–∞–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è',
                                'ACCEPTED': '–ü—Ä–∏–Ω—è—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–º',
                                'HOLD': '–î–µ–Ω—å–≥–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã',
                                'COMPLETED': '–í—ã–ø–æ–ª–Ω–µ–Ω–æ',
                                'CANCELLED': '–û—Ç–º–µ–Ω–µ–Ω–æ'
                            };
                            const statusColor = statusColors[o.status] || '#8E8E93';
                            const statusText = statusTexts[o.status] || o.status;
                            const isClient = o.client_id == uid;
                            const isDriver = o.driver_id == uid;
                            
                            let actions = '';
                            if (o.status === 'PENDING' && isClient) {
                                actions = `<button class="btn" onclick="cancelExOrder(${o.id})" style="background:#FF3B30;margin-top:8px;padding:10px;font-size:14px;">–û—Ç–º–µ–Ω–∏—Ç—å</button>`;
                            } else if (o.status === 'ACCEPTED' && isClient) {
                                actions = `<button class="btn btn-blue" onclick="holdEscrow(${o.id})" style="margin-top:8px;padding:10px;font-size:14px;">–ó–∞–º–æ—Ä–æ–∑–∏—Ç—å –¥–µ–Ω—å–≥–∏</button>`;
                            } else if (o.status === 'HOLD' && (isClient || isDriver)) {
                                actions = `<button class="btn" onclick="completeExOrder(${o.id})" style="background:#34C759;margin-top:8px;padding:10px;font-size:14px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É</button>`;
                            } else if (o.status === 'PENDING' && !isClient && !isDriver) {
                                actions = `<button class="btn btn-blue" onclick="acceptExOrder(${o.id})" style="margin-top:8px;padding:10px;font-size:14px;">–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>`;
                            }
                            
                            c.innerHTML += `
                                <div class="card">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                        <div style="flex:1;">
                                            <div style="font-weight:700;font-size:15px;">${o.route || '–ë–µ–∑ –º–∞—Ä—à—Ä—É—Ç–∞'}</div>
                                            <div style="font-size:13px;color:#8e8e93;margin-top:4px;">${o.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                                        </div>
                                        <div style="background:${statusColor};color:#fff;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700;white-space:nowrap;">
                                            ${statusText}
                                        </div>
                                    </div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;font-size:13px;">
                                        <div><b>–í–µ—Å:</b> ${o.weight} –∫–≥</div>
                                        <div><b>–¶–µ–Ω–∞:</b> ${o.price_per_kg} ${o.currency}/–∫–≥</div>
                                        <div style="grid-column:1/-1;"><b>–ò—Ç–æ–≥–æ:</b> ${o.total_price} ${o.currency}</div>
                                    </div>
                                    ${actions}
                                </div>
                            `;
                    });
                } catch(e) {
                    console.error('Load error:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—à–∏–Ω—ã –±–∏—Ä–∂–∏
        async function ldTrTrips() {
            safe('list-trucks-trips', async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–∞—à–∏–Ω/—Ä–µ–π—Å–æ–≤
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>';
                } catch(e) {
                    console.error('Load trips error:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–∑—ã –±–∏—Ä–∂–∏
        async function ldTrCargo() {
            safe('list-trucks-cargo', async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>';
                } catch(e) {
                    console.error('Load cargo error:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –±–∏—Ä–∂–∏
        async function ldTrHistory() {
            safe('list-trucks-history', async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    let d = await safeFetch(`${API}/api/exchange/list?user_id=${uid}&status=COMPLETED`);
                    c.innerHTML = '';
                    if(!d.orders || d.orders.length === 0) {
                        c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                        return;
                    }
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
                    let h = '';
                    d.orders.forEach(o => {
                        h += `<div class="card" style="padding:16px;margin-bottom:12px;">
                            <div style="font-weight:700;margin-bottom:8px;">${o.route || '–ú–∞—Ä—à—Ä—É—Ç'}</div>
                            <div style="font-size:14px;color:var(--sec);margin-bottom:4px;">–í–µ—Å: ${o.weight} –∫–≥</div>
                            <div style="font-size:14px;color:var(--sec);">–¶–µ–Ω–∞: ${o.price_per_kg} ${o.currency}/–∫–≥</div>
                        </div>`;
                    });
                    c.innerHTML = h;
                } catch(e) {
                    console.error('Load history error:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –º–∞—Ä–∫–µ—Ç–∞
        async function loadWishlist() {
            safe('list-market-wishlist', async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    const res = await safeFetch(`${API}/api/marketplace/wishlist/${uid}`);
                    if (!res || res.status !== 'ok' || !res.items || res.items.length === 0) {
                        c.innerHTML = '<div style="text-align:center;padding:60px;"><i class="fa-solid fa-heart" style="font-size:48px;color:var(--sec);opacity:0.5;margin-bottom:16px;"></i><div style="color:var(--sec);font-size:16px;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ</div></div>';
                        return;
                    }
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                    let html = '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">';
                    res.items.forEach(item => {
                        html += `<div class="card market-product-card" onclick="showProductDetails(${item.product_id})" style="padding:0;cursor:pointer;">
                            <img src="${item.product_image || 'https://ui-avatars.com/api/?name=PROD&size=200'}" style="width:100%;height:140px;object-fit:cover;border-radius:12px 12px 0 0;">
                            <div style="padding:12px;">
                                <div style="font-weight:700;font-size:14px;margin-bottom:6px;">${(item.product_title || '–¢–æ–≤–∞—Ä').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                                <div style="color:var(--blue);font-weight:800;font-size:16px;">${item.product_price} TJS</div>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                    c.innerHTML = html;
                } catch(e) {
                    console.error('Load wishlist error:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--sec);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</div>';
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–∞—Ä–∫–µ—Ç–∞
        async function loadCategories() {
            safe('list-market-categories', async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    const categories = ['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', '–û–¥–µ–∂–¥–∞', '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', '–î–æ–º –∏ —Å–∞–¥', '–°–ø–æ—Ä—Ç', '–ö—Ä–∞—Å–æ—Ç–∞', '–ò–≥—Ä—É—à–∫–∏', '–ê–≤—Ç–æ'];
                    let html = '<div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">';
                    categories.forEach((cat, idx) => {
                        const colors = ['#FF2D55', '#34C759', '#007AFF', '#FF9500', '#5856D6', '#FF3B30', '#FFD60A', '#8E8E93'];
                        html += `<div class="card" style="padding:20px;text-align:center;cursor:pointer;" onclick="nav('market-products');filterByCategory('${cat}')">
                            <div class="icon-box" style="color:${colors[idx % colors.length]};font-size:32px;margin-bottom:8px;">
                                <i class="fa-solid fa-tag"></i>
                            </div>
                            <div style="font-weight:600;">${cat}</div>
                        </div>`;
                    });
                    html += '</div>';
                    c.innerHTML = html;
                } catch(e) {
                    console.error('Load categories error:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--sec);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ –º–∞—Ä–∫–µ—Ç–∞
        async function loadSellers() {
            safe('list-market-sellers', async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>';
                } catch(e) {
                    console.error('Load sellers error:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—á–µ—Ç–æ–≤
        async function loadCalcHistory() {
            safe('list-calc-history', async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—á–µ—Ç–æ–≤ –∏–∑ localStorage –∏–ª–∏ API
                    const history = JSON.parse(localStorage.getItem('calc_history') || '[]');
                    if (history.length === 0) {
                        c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–ò—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—á–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                        return;
                    }
                    let html = '';
                    history.slice(0, 20).forEach(h => {
                        html += `<div class="card" style="padding:16px;margin-bottom:12px;">
                            <div style="font-weight:700;margin-bottom:8px;">–†–∞—Å—á–µ—Ç –æ—Ç ${new Date(h.date).toLocaleDateString('ru-RU')}</div>
                            <div style="font-size:14px;color:var(--sec);margin-bottom:4px;">–í–µ—Å: ${h.weight} –∫–≥ √ó ${h.quantity} —à—Ç.</div>
                            <div style="font-size:18px;color:var(--blue);font-weight:800;">${h.total} TJS</div>
                        </div>`;
                    });
                    c.innerHTML = html;
                } catch(e) {
                    console.error('Load calc history error:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                }
            });
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function filterByCategory(category) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω —Ç–æ–≤–∞—Ä–æ–≤ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
            setTimeout(() => {
                const searchInput = document.getElementById('market-search');
                if (searchInput) {
                    searchInput.value = category;
                    filterMarketProducts();
                }
            }, 100);
        }

        async function ldMk() {
            safe('list-market', async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    if (tabMk === 'joint') {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—É–ª—ã (–≥—Ä—É–ø–ø–æ–≤—ã–µ –ø–æ–∫—É–ø–∫–∏)
                        await loadPools();
                        return;
                    }
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞—Ä–∫–µ—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤
                    const cacheKey = `market_${tabMk}`;
                    let d = await cachedFetch(`${API}/api/market/list?type=${tabMk}`, cacheKey);
                    c.innerHTML = '';
                    if(!d.items || d.items.length === 0) { c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>'; return; }
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                    window.marketProducts = d.items;
                    
                    let h = '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;" id="market-products-grid">';
                    d.items.forEach(i => { 
                        const itemTitle = (i.title || 'Item').substring(0, 2);
                        const fallbackImg = `https://ui-avatars.com/api/?name=${encodeURIComponent(itemTitle)}&size=200&background=007AFF&color=fff`;
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        let imgUrl = i.img;
                        if (!imgUrl || !imgUrl.trim() || imgUrl === 'null' || imgUrl === 'undefined') {
                            imgUrl = fallbackImg;
                        } else if (!imgUrl.startsWith('http://') && !imgUrl.startsWith('https://') && !imgUrl.startsWith('data:')) {
                            imgUrl = fallbackImg;
                        }
                        
                        const imgId = `market-img-${i.id || Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        const priceValue = (i.price || '0 TJS').replace(' TJS', '').trim();
                        const titleEscaped = (i.title || '–¢–æ–≤–∞—Ä').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        
                        h += `<div class="card market-product-card" 
                                   data-product-id="${i.id}" 
                                   data-product-title="${titleEscaped.toLowerCase()}"
                                   style="padding:0;margin-bottom:0;overflow:hidden;cursor:pointer;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);border:1px solid var(--border);"
                                   onclick="showProductDetails(${i.id})"
                                   onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';"
                                   onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)';">
                            <div style="position:relative;width:100%;height:140px;overflow:hidden;background:linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);">
                                <img id="${imgId}" src="${imgUrl}" 
                                     style="width:100%;height:100%;object-fit:cover;display:block;transition:transform 0.3s;"
                                     onerror="const el=document.getElementById('${imgId}'); if(el && el.src!=='${fallbackImg}'){el.src='${fallbackImg}';}else{el.style.display='none';el.style.backgroundColor='#f0f0f0';}"
                                     onload="const el=document.getElementById('${imgId}'); if(el){el.style.display='block';}"
                                     onmouseover="this.style.transform='scale(1.05)';"
                                     onmouseout="this.style.transform='scale(1)';"
                                     alt="${titleEscaped.replace(/"/g, '&quot;')}">
                                <div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;">
                                    <i class="fa-solid fa-tag"></i>
                                </div>
                            </div>
                            <div style="padding:12px;">
                                <div style="font-weight:700;font-size:14px;margin-bottom:6px;line-height:1.3;color:var(--text);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
                                    ${titleEscaped}
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                                    <div style="color:var(--blue);font-weight:800;font-size:16px;">
                                        ${priceValue} <span style="font-size:12px;font-weight:600;opacity:0.7;">TJS</span>
                                    </div>
                                    <div style="display:flex;gap:6px;">
                                        <div style="background:rgba(0,122,255,0.1);color:var(--blue);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;" 
                                             onclick="event.stopPropagation();toggleWishlist(${i.id})" 
                                             title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                            <i class="fa-regular fa-heart"></i>
                                        </div>
                                        <div style="background:linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 2px 8px rgba(0,122,255,0.3);cursor:pointer;" 
                                             onclick="event.stopPropagation();addToCart(${i.id}, 1)">
                                            <i class="fa-solid fa-cart-plus"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`; 
                    });
                    c.innerHTML = h + '</div>';
                } catch { c.innerHTML = '–û—à–∏–±–∫–∞'; }
            });
        }

        async function ldRew() {
            safe('list-rewards', async c => {
                c.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                try {
                    let d = await safeFetch(`${API}/api/rewards/list/${uid}`); c.innerHTML = '';
                    if(!d.tasks) return;
                    d.tasks.forEach(t => { c.innerHTML += `<div class="card" onclick="claimRew(${t.id})"><b>${t.title}</b><br><small>${t.desc}</small><div style="color:#F57F17; font-weight:800;">+${t.reward} –∫–≥</div></div>`; });
                } catch { c.innerHTML = '–û—à–∏–±–∫–∞'; }
            });
        }

        async function saveSet() {
            const sn = gid('s-name'); const sp = gid('s-phone'); const sv = gid('s-pvz');
            let d = {user_id:uid, full_name:sn?sn.value:"", phone:sp?sp.value:"", pvz_id:parseInt(sv?sv.value:0)};
            await safeFetch(`${API}/api/update_settings`, {method:'POST', body:JSON.stringify(d)});
            // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à dashboard, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
            invalidateCache('dashboard');
            tg.showAlert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"); init(); goHome();
        }

        async function subTrack() {
            const nt = gid('n-t'); const nd = gid('n-d');
            let d = {user_id:uid, track_number:nt?nt.value:"", description:nd?nd.value:""};
            await safeFetch(`${API}/api/add_track`, {method:'POST', body:JSON.stringify(d)});
            // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à dashboard –∏ packages, —Ç–∞–∫ –∫–∞–∫ –¥–æ–±–∞–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è –ø–æ—Å—ã–ª–∫–∞
            invalidateCache('dashboard');
            invalidateCache('packages');
            closeM('m-add'); init();
        }

        function swTr(t, el) { tabTr = t; document.querySelectorAll('#screen-trucks .tab').forEach(x=>x.classList.remove('active')); el.classList.add('active'); ldTr(); }

        /* ================= EXCHANGE ORDERS ================= */
        async function createExchangeOrder() {
            const route = gid('eo-route')?.value;
            const weight = parseFloat(gid('eo-weight')?.value || 0);
            const price = parseFloat(gid('eo-price')?.value || 0);
            const currency = gid('eo-currency')?.value || 'USD';
            const desc = gid('eo-desc')?.value || '';
            
            if (!route || !weight || !price) {
                tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const r = await fetch(`${API}/api/exchange/create`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        route: route,
                        weight: weight,
                        price_per_kg: price,
                        currency: currency,
                        description: desc
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    tg.showAlert('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!');
                    closeM('m-create-order');
                    ldTr();
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                }
            } catch(e) {
                console.error('Create order error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
            }
        }

        async function acceptExOrder(orderId) {
            try {
                const r = await fetch(`${API}/api/exchange/accept`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        order_id: orderId
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    invalidateCache('exchange');
                    tg.showAlert('–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!');
                    ldTr();
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞');
                }
            } catch(e) {
                console.error('Accept error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞');
            }
        }

        async function holdEscrow(orderId) {
            try {
                const r = await fetch(`${API}/api/exchange/hold`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        order_id: orderId
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    invalidateCache('exchange');
                    invalidateCache('wallet');
                    invalidateCache('dashboard');
                    tg.showAlert('–î–µ–Ω—å–≥–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã');
                    ldTr();
                    loadWallet(); // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                } else {
                    tg.showAlert(d.detail || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                }
            } catch(e) {
                console.error('Hold error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞');
            }
        }

        async function completeExOrder(orderId) {
            try {
                const r = await fetch(`${API}/api/exchange/complete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        order_id: orderId
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    invalidateCache('exchange');
                    invalidateCache('wallet');
                    invalidateCache('dashboard');
                    tg.showAlert('–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –î–µ–Ω—å–≥–∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –≤–æ–¥–∏—Ç–µ–ª—é.');
                    ldTr();
                    loadWallet(); // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞');
                }
            } catch(e) {
                console.error('Complete error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞');
            }
        }

        async function cancelExOrder(orderId) {
            if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) return;
            try {
                const r = await fetch(`${API}/api/exchange/cancel`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        order_id: orderId
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    invalidateCache('exchange');
                    invalidateCache('wallet');
                    invalidateCache('dashboard');
                    tg.showAlert('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω');
                    ldTr();
                    loadWallet(); // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞');
                }
            } catch(e) {
                console.error('Cancel error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞');
            }
        }
        function swMk(t, el) { 
            tabMk = t; 
            document.querySelectorAll('#screen-market .tab').forEach(x=>x.classList.remove('active')); 
            el.classList.add('active'); 
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
            const searchWrap = document.getElementById('market-search-wrap');
            if (searchWrap) {
                searchWrap.style.display = t === 'item' ? 'block' : 'none';
            }
            ldMk(); 
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
        function filterMarketProducts() {
            const searchInput = document.getElementById('market-search');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const productCards = document.querySelectorAll('.market-product-card');
            
            productCards.forEach(card => {
                const title = card.getAttribute('data-product-title') || '';
                if (title.includes(searchTerm) || searchTerm === '') {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞
        async function showProductDetails(productId) {
            openM('m-product-details');
            const contentEl = document.getElementById('product-details-content');
            if (!contentEl) return;
            
            contentEl.innerHTML = '<div style="text-align:center;padding:40px;"><div class="loading-spinner"></div><div style="margin-top:16px;color:var(--sec);">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ API
                const product = window.marketProducts?.find(p => p.id === productId);
                if (!product) {
                    contentEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--sec);">–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                    return;
                }
                
                const titleEscaped = (product.title || '–¢–æ–≤–∞—Ä').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const priceValue = (product.price || '0 TJS').replace(' TJS', '').trim();
                const fallbackImg = `https://ui-avatars.com/api/?name=${encodeURIComponent((product.title || 'Item').substring(0, 2))}&size=200&background=007AFF&color=fff`;
                let imgUrl = product.img;
                if (!imgUrl || !imgUrl.trim() || imgUrl === 'null' || imgUrl === 'undefined' || (!imgUrl.startsWith('http://') && !imgUrl.startsWith('https://') && !imgUrl.startsWith('data:'))) {
                    imgUrl = fallbackImg;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—É–ª—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
                let poolsHtml = '';
                try {
                    const poolsRes = await safeFetch(`${API}/api/pools/list?status=ACTIVE`);
                    if (poolsRes.status === 'ok' && poolsRes.pools) {
                        const activePools = poolsRes.pools.filter(p => p.product_id === productId);
                        if (activePools.length > 0) {
                            poolsHtml = `<div style="margin-top:20px;padding:16px;background:linear-gradient(135deg, rgba(0,122,255,0.1) 0%, rgba(88,86,214,0.1) 100%);border-radius:12px;">
                                <div style="font-weight:700;font-size:16px;margin-bottom:12px;color:var(--blue);">
                                    <i class="fa-solid fa-users"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–±–æ—Ä—ã (${activePools.length})
                                </div>
                                ${activePools.map(pool => `
                                    <div class="card" style="padding:12px;margin-bottom:8px;cursor:pointer;" onclick="showPoolDetails(${pool.id});closeM('m-product-details');">
                                        <div style="display:flex;justify-content:space-between;align-items:center;">
                                            <div>
                                                <div style="font-weight:600;font-size:14px;">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${pool.current_participants}/${pool.target_participants}</div>
                                                <div style="font-size:12px;color:var(--sec);margin-top:4px;">–¶–µ–Ω–∞ –ø—É–ª–∞: <span style="font-weight:700;color:var(--green);">${pool.pool_price.toFixed(2)} TJS</span></div>
                                            </div>
                                            <div style="width:40px;height:40px;background:linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;">
                                                <i class="fa-solid fa-arrow-right"></i>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`;
                        }
                    }
                } catch (e) {
                    console.error('Error loading pools:', e);
                }
                
                contentEl.innerHTML = `
                    <div style="padding:20px;">
                        <div style="width:100%;height:200px;border-radius:16px;overflow:hidden;background:linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);margin-bottom:20px;">
                            <img src="${imgUrl}" 
                                 style="width:100%;height:100%;object-fit:cover;display:block;"
                                 onerror="this.src='${fallbackImg}'"
                                 alt="${titleEscaped.replace(/"/g, '&quot;')}">
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <h2 style="font-weight:800;font-size:24px;margin-bottom:12px;color:var(--text);line-height:1.2;">
                                ${titleEscaped}
                            </h2>
                            <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                                <div style="font-size:28px;font-weight:800;color:var(--blue);">
                                    ${priceValue} <span style="font-size:18px;font-weight:600;opacity:0.7;">TJS</span>
                                </div>
                            </div>
                        </div>
                        
                        ${poolsHtml}
                        
                        <div style="display:flex;gap:12px;margin-top:24px;">
                            <button class="btn btn-blue" style="flex:1;" onclick="createPoolFromProduct(${productId}, '${titleEscaped.replace(/'/g, "\\'")}', ${priceValue})">
                                <i class="fa-solid fa-users"></i> –°–æ–∑–¥–∞—Ç—å —Å–±–æ—Ä
                            </button>
                            <button class="btn" style="flex:1;background:linear-gradient(135deg, #34C759 0%, #30D158 100%);" onclick="addToCart(${productId}, 1);closeM('m-product-details');">
                                <i class="fa-solid fa-cart-plus"></i> –í –∫–æ—Ä–∑–∏–Ω—É
                            </button>
                            <button class="btn" style="flex:1;background:rgba(0,122,255,0.1);color:var(--blue);border:1px solid var(--blue);" onclick="toggleWishlist(${productId})">
                                <i class="fa-regular fa-heart"></i> –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                            </button>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error loading product details:', e);
                contentEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--sec);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }
        
        // –°–æ–∑–¥–∞—Ç—å –ø—É–ª –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
        async function createPoolFromProduct(productId, productTitle, soloPrice) {
            closeM('m-product-details');
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—É–ª–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const poolPrice = parseFloat(prompt(`–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏ (—Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${soloPrice} TJS):`, (soloPrice * 0.7).toFixed(2))) || soloPrice * 0.7;
            const targetParticipants = parseInt(prompt('–°–∫–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω—É–∂–Ω–æ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—É–ª–∞?', '5')) || 5;
            
            if (!confirm(`–°–æ–∑–¥–∞—Ç—å —Å–±–æ—Ä –¥–ª—è "${productTitle}"?\n–¶–µ–Ω–∞ —Å–æ–ª–æ: ${soloPrice} TJS\n–¶–µ–Ω–∞ –ø—É–ª–∞: ${poolPrice.toFixed(2)} TJS\n–¶–µ–ª—å: ${targetParticipants} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`)) {
                return;
            }
            
            try {
                const res = await safeFetch(`${API}/api/pools/create`, {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: productId,
                        creator_id: uid,
                        solo_price: parseFloat(soloPrice),
                        pool_price: parseFloat(poolPrice),
                        target_participants: parseInt(targetParticipants)
                    })
                });
                
                if (res.status === 'ok') {
                    tg.showAlert('‚úÖ –°–±–æ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                    invalidateCache('pools_list');
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–°–±–æ—Ä—ã"
                    const jointTab = document.querySelector('#screen-market .tab:last-child');
                    if (jointTab) {
                        swMk('joint', jointTab);
                    }
                } else {
                    tg.showAlert(res.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–±–æ—Ä–∞');
                }
            } catch (e) {
                console.error('Error creating pool:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–±–æ—Ä–∞');
            }
        }
        
        /* ================= –ü–£–õ–´ (–ì–†–£–ü–ü–û–í–´–ï –ü–û–ö–£–ü–ö–ò) ================= */
        async function loadPools() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤ –∫–∞–∫–æ–º —ç–∫—Ä–∞–Ω–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è
            const poolsContainer = document.getElementById('list-market-pools') || document.getElementById('list-market');
            if (!poolsContainer) return;
            
            safe(poolsContainer.id, async c => {
                c.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    const d = await cachedFetch(`${API}/api/pools/list?status=ACTIVE`, 'pools');
                    c.innerHTML = '';
                    
                    if(!d.pools || d.pools.length === 0) {
                        c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–±–æ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                        return;
                    }
                    
                    let html = '';
                    d.pools.forEach(pool => {
                        const progress = pool.progress || 0;
                        const remaining = Math.max(0, pool.target_participants - pool.current_participants);
                        const isFull = pool.current_participants >= pool.target_participants;
                        
                        html += `
                            <div class="card" style="padding:16px;margin-bottom:12px;cursor:pointer;" onclick="showPoolDetails(${pool.id})">
                                <div style="display:flex;gap:12px;margin-bottom:12px;">
                                    <img src="${pool.product_image || 'https://ui-avatars.com/api/?name=' + encodeURIComponent((pool.product_title || 'Product').substring(0, 2)) + '&size=100&background=007AFF&color=fff'}" 
                                         style="width:80px;height:80px;object-fit:cover;border-radius:12px;background:#f0f0f0;"
                                         onerror="this.src='https://ui-avatars.com/api/?name=POOL&size=100&background=007AFF&color=fff'">
                                    <div style="flex:1;">
                                        <div style="font-weight:700;font-size:16px;margin-bottom:4px;">${(pool.product_title || '–¢–æ–≤–∞—Ä').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                                        <div style="display:flex;gap:12px;margin-top:8px;">
                                            <div>
                                                <div style="font-size:12px;color:#8e8e93;">–û–¥–∏–Ω–æ—á–Ω–∞—è</div>
                                                <div style="font-weight:700;color:#FF3B30;font-size:14px;">${pool.solo_price.toFixed(2)} TJS</div>
                                            </div>
                                            <div>
                                                <div style="font-size:12px;color:#8e8e93;">–í —Å–±–æ—Ä–µ</div>
                                                <div style="font-weight:700;color:#34C759;font-size:14px;">${pool.pool_price.toFixed(2)} TJS</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top:12px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                                        <span style="font-size:13px;color:#8e8e93;">–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±–æ—Ä–∞</span>
                                        <span style="font-weight:700;font-size:14px;">${pool.current_participants}/${pool.target_participants}</span>
                                    </div>
                                    <div style="width:100%;height:8px;background:#f0f0f0;border-radius:4px;overflow:hidden;">
                                        <div style="width:${Math.min(100, progress)}%;height:100%;background:linear-gradient(90deg, #007AFF 0%, #5856D6 100%);transition:width 0.3s;border-radius:4px;"></div>
                                    </div>
                                    ${remaining > 0 && !isFull ? 
                                        `<div style="margin-top:8px;font-size:12px;color:#007AFF;text-align:center;">–û—Å—Ç–∞–ª–æ—Å—å ${remaining} ${remaining === 1 ? '—á–µ–ª–æ–≤–µ–∫' : remaining < 5 ? '—á–µ–ª–æ–≤–µ–∫–∞' : '—á–µ–ª–æ–≤–µ–∫'}</div>` :
                                        isFull ? 
                                        `<div style="margin-top:8px;font-size:12px;color:#34C759;text-align:center;font-weight:700;">‚úì –°–±–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω!</div>` :
                                        ''
                                    }
                                </div>
                            </div>
                        `;
                    });
                    
                    c.innerHTML = html;
                } catch(e) {
                    console.error('Load pools error:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–±–æ—Ä–æ–≤</div>';
                }
            });
        }
        
        async function showPoolDetails(poolId) {
            try {
                const d = await cachedFetch(`${API}/api/pools/${poolId}`, `pool_${poolId}`);
                if (d.status !== 'ok' || !d.pool) {
                    tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–±–æ—Ä–µ');
                    return;
                }
                
                const pool = d.pool;
                const progress = pool.progress || 0;
                const remaining = Math.max(0, pool.target_participants - pool.current_participants);
                const isFull = pool.current_participants >= pool.target_participants;
                const userParticipating = pool.participants && pool.participants.some(p => p.user_id === uid);
                
                let participantsHTML = '';
                if (pool.participants && pool.participants.length > 0) {
                    pool.participants.forEach(p => {
                        participantsHTML += `
                            <div style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #f0f0f0;">
                                <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, #007AFF 0%, #5856D6 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px;">
                                    ${(p.user_name || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div style="flex:1;">
                                    <div style="font-weight:600;font-size:14px;">${(p.user_name || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${p.user_id}`).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                                    <div style="font-size:12px;color:#8e8e93;">${p.payment_status === 'PAID' ? '‚úì –û–ø–ª–∞—á–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã'}</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    participantsHTML = '<div style="text-align:center;padding:20px;color:#8e8e93;">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                }
                
                const modalHTML = `
                    <div class="modal" style="max-width:90%;max-height:90vh;overflow-y:auto;">
                        <h3 style="margin-bottom:16px;">${(pool.product_title || '–¢–æ–≤–∞—Ä').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h3>
                        <img src="${pool.product_image || 'https://ui-avatars.com/api/?name=' + encodeURIComponent((pool.product_title || 'Product').substring(0, 2)) + '&size=200&background=007AFF&color=fff'}" 
                             style="width:100%;height:200px;object-fit:cover;border-radius:12px;margin-bottom:16px;background:#f0f0f0;"
                             onerror="this.src='https://ui-avatars.com/api/?name=POOL&size=200&background=007AFF&color=fff'">
                        
                        <div style="display:flex;gap:16px;margin-bottom:16px;">
                            <div style="flex:1;padding:12px;background:#fff3f3;border-radius:8px;text-align:center;">
                                <div style="font-size:12px;color:#8e8e93;margin-bottom:4px;">–û–¥–∏–Ω–æ—á–Ω–∞—è –ø–æ–∫—É–ø–∫–∞</div>
                                <div style="font-weight:700;color:#FF3B30;font-size:18px;">${pool.solo_price.toFixed(2)} TJS</div>
                            </div>
                            <div style="flex:1;padding:12px;background:#f0fff4;border-radius:8px;text-align:center;">
                                <div style="font-size:12px;color:#8e8e93;margin-bottom:4px;">–í —Å–±–æ—Ä–µ</div>
                                <div style="font-weight:700;color:#34C759;font-size:18px;">${pool.pool_price.toFixed(2)} TJS</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:16px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                <span style="font-weight:600;font-size:14px;">–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±–æ—Ä–∞</span>
                                <span style="font-weight:700;font-size:16px;">${pool.current_participants}/${pool.target_participants}</span>
                            </div>
                            <div style="width:100%;height:12px;background:#f0f0f0;border-radius:6px;overflow:hidden;margin-bottom:8px;">
                                <div style="width:${Math.min(100, progress)}%;height:100%;background:linear-gradient(90deg, #007AFF 0%, #5856D6 100%);transition:width 0.3s;border-radius:6px;"></div>
                            </div>
                            ${remaining > 0 && !isFull ? 
                                `<div style="text-align:center;font-size:13px;color:#007AFF;">–û—Å—Ç–∞–ª–æ—Å—å ${remaining} ${remaining === 1 ? '—á–µ–ª–æ–≤–µ–∫' : remaining < 5 ? '—á–µ–ª–æ–≤–µ–∫–∞' : '—á–µ–ª–æ–≤–µ–∫'}</div>` :
                                isFull ? 
                                `<div style="text-align:center;font-size:13px;color:#34C759;font-weight:700;">‚úì –°–±–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω! –í—ã–∫—É–ø –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>` :
                                ''
                            }
                        </div>
                        
                        <div style="margin-bottom:16px;">
                            <div style="font-weight:600;font-size:14px;margin-bottom:8px;">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (${pool.participants.length})</div>
                            <div style="background:#f9f9f9;border-radius:8px;overflow:hidden;">
                                ${participantsHTML}
                            </div>
                        </div>
                        
                        ${!isFull && !userParticipating ? 
                            `<button class="btn btn-blue" onclick="joinPool(${pool.id})" style="width:100%;margin-top:16px;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–±–æ—Ä—É</button>` :
                            userParticipating ?
                            `<div style="text-align:center;padding:12px;background:#f0fff4;border-radius:8px;color:#34C759;font-weight:600;margin-top:16px;">–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–º —Å–±–æ—Ä–µ</div>` :
                            ''
                        }
                        
                        <div style="text-align:center;padding:15px;color:#8e8e93;font-size:13px;margin-top:16px;cursor:pointer;" onclick="closeM('m-pool-details')">–ó–∞–∫—Ä—ã—Ç—å</div>
                    </div>
                `;
                
                safe('m-pool-details', el => {
                    el.innerHTML = modalHTML;
                    openM('m-pool-details');
                });
            } catch(e) {
                console.error('Show pool details error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–±–æ—Ä–µ');
            }
        }
        
        async function joinPool(poolId) {
            try {
                const d = await safeFetch(`${API}/api/pools/join`, {
                    method: 'POST',
                    body: JSON.stringify({
                        pool_id: poolId,
                        user_id: uid
                    })
                });
                
                if (d.status === 'ok') {
                    invalidateCache('pools');
                    invalidateCache(`pool_${poolId}`);
                    tg.showAlert('–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Å–±–æ—Ä—É!');
                    closeM('m-pool-details');
                    loadPools(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—É–ª–æ–≤
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —Å–±–æ—Ä—É');
                }
            } catch(e) {
                console.error('Join pool error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —Å–±–æ—Ä—É');
            }
        }
        
        /* ================= MARKETPLACE (–ö–æ—Ä–∑–∏–Ω–∞, –ó–∞–∫–∞–∑—ã, –ò–∑–±—Ä–∞–Ω–Ω–æ–µ) ================= */
        
        // –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
        async function addToCart(productId, quantity = 1) {
            try {
                const res = await safeFetch(`${API}/api/marketplace/cart/add`, {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: uid,
                        product_id: productId,
                        quantity: quantity
                    })
                });
                
                if (res.status === 'ok') {
                    tg.showAlert('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!');
                    updateCartBadge().catch(() => {}); // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–∞
                } else {
                    tg.showAlert(res.detail || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É');
                }
            } catch (e) {
                console.error('Error adding to cart:', e);
                e.handled = true; // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é
                tg.showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É');
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
        async function toggleWishlist(productId) {
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º
                const wishlistRes = await safeFetch(`${API}/api/marketplace/wishlist/${uid}`);
                const existing = wishlistRes.items?.find(item => item.product_id === productId);
                
                if (existing) {
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                    const res = await safeFetch(`${API}/api/marketplace/wishlist/${existing.id}`, {
                        method: 'DELETE'
                    });
                    if (res.status === 'ok') {
                        tg.showAlert('–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
                    }
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                    try {
                        const res = await safeFetch(`${API}/api/marketplace/wishlist/add?user_id=${uid}&product_id=${productId}`, {
                            method: 'POST'
                        });
                        if (res.status === 'ok') {
                            tg.showAlert('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!');
                        } else {
                            tg.showAlert(res.detail || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                        }
                    } catch (err) {
                        console.error('Wishlist add error:', err);
                        tg.showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                    }
                }
            } catch (e) {
                console.error('Error toggling wishlist:', e);
                tg.showAlert('–û—à–∏–±–∫–∞');
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂ –∫–æ—Ä–∑–∏–Ω—ã (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä—Å–∏—è, –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏)
        async function updateCartBadge() {
            try {
                if (!uid) return; // –ï—Å–ª–∏ uid –µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                
                const cartRes = await safeFetchSilent(`${API}/api/marketplace/cart/${uid}`);
                if (!cartRes || cartRes.status !== 'ok') return;
                
                const cartBadge = document.getElementById('cart-badge');
                if (cartBadge) {
                    if (cartRes.count > 0) {
                        cartBadge.textContent = cartRes.count;
                        cartBadge.style.display = 'flex';
                    } else {
                        cartBadge.style.display = 'none';
                    }
                }
            } catch (e) {
                // –¢–∏—Ö–∞—è –æ—à–∏–±–∫–∞ - –Ω–µ –ª–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –∫–æ–Ω—Å–æ–ª—å
                // –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ API –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤ –∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã
            }
        }
        
        // –¢–∏—Ö–∞—è –≤–µ—Ä—Å–∏—è safeFetch (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
        async function safeFetchSilent(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    return { status: 'error', detail: `HTTP ${response.status}` };
                }
                
                return await response.json();
            } catch (e) {
                return { status: 'error', detail: e.message };
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        async function loadCart() {
            safe('cart-content', async c => {
                c.innerHTML = '<div style="text-align:center;padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    if (!uid) {
                        c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--sec);">–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</div>';
                        return;
                    }
                    
                    const res = await safeFetch(`${API}/api/marketplace/cart/${uid}`);
                    if (!res || res.status !== 'ok' || !res.items || res.items.length === 0) {
                        c.innerHTML = '<div style="text-align:center;padding:60px;"><i class="fa-solid fa-cart-shopping" style="font-size:48px;color:var(--sec);opacity:0.5;margin-bottom:16px;"></i><div style="color:var(--sec);font-size:16px;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div></div>';
                        const totalEl = document.getElementById('cart-total');
                        const btnEl = document.getElementById('cart-checkout-btn');
                        if (totalEl) totalEl.textContent = '0 TJS';
                        if (btnEl) btnEl.style.display = 'none';
                        return;
                    }
                    
                    let html = '';
                    res.items.forEach(item => {
                        html += `
                            <div class="card" style="padding:16px;margin-bottom:12px;">
                                <div style="display:flex;gap:12px;">
                                    <img src="${item.product_image || 'https://ui-avatars.com/api/?name=PROD&size=100'}" 
                                         style="width:80px;height:80px;object-fit:cover;border-radius:12px;background:#f0f0f0;">
                                    <div style="flex:1;">
                                        <div style="font-weight:700;font-size:15px;margin-bottom:4px;">${(item.product_title || '–¢–æ–≤–∞—Ä').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                                        <div style="font-size:18px;font-weight:800;color:var(--blue);margin-bottom:8px;">${item.price} TJS</div>
                                        <div style="display:flex;align-items:center;gap:12px;">
                                            <button onclick="updateCartItem(${item.id}, ${item.quantity - 1})" style="width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--bg);font-size:18px;cursor:pointer;">-</button>
                                            <span style="font-weight:700;min-width:30px;text-align:center;">${item.quantity}</span>
                                            <button onclick="updateCartItem(${item.id}, ${item.quantity + 1})" style="width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--bg);font-size:18px;cursor:pointer;">+</button>
                                            <button onclick="removeFromCart(${item.id})" style="margin-left:auto;color:#FF3B30;background:none;border:none;font-size:20px;cursor:pointer;">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    c.innerHTML = html;
                    const totalEl = document.getElementById('cart-total');
                    const btnEl = document.getElementById('cart-checkout-btn');
                    if (totalEl) totalEl.textContent = `${res.total} TJS`;
                    if (btnEl) btnEl.style.display = 'block';
                } catch (e) {
                    console.error('Error loading cart:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--sec);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã</div>';
                }
            });
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        async function updateCartItem(cartItemId, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(cartItemId);
                return;
            }
            try {
                const res = await safeFetch(`${API}/api/marketplace/cart/update`, {
                    method: 'POST',
                    body: JSON.stringify({
                        cart_item_id: cartItemId,
                        quantity: newQuantity
                    })
                });
                if (res && res.status === 'ok') {
                    loadCart();
                    updateCartBadge().catch(() => {}); // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–∞
                } else {
                    tg.showAlert(res?.detail || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã');
                }
            } catch (e) {
                console.error('Error updating cart:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        }
        
        // –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        async function removeFromCart(cartItemId) {
            try {
                const res = await safeFetch(`${API}/api/marketplace/cart/${cartItemId}`, {
                    method: 'DELETE'
                });
                if (res && res.status === 'ok') {
                    loadCart();
                    updateCartBadge().catch(() => {}); // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–∞
                    tg.showAlert('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã');
                } else {
                    tg.showAlert(res?.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞');
                }
            } catch (e) {
                console.error('Error removing from cart:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        }
        
        // –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        async function checkoutCart() {
            if (!confirm('–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) return;
            try {
                if (!uid) {
                    tg.showAlert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
                    return;
                }
                
                const res = await safeFetch(`${API}/api/marketplace/orders/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: uid,
                        payment_method: 'WALLET'
                    })
                });
                if (res && res.status === 'ok') {
                    tg.showAlert(`‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω! –ù–æ–º–µ—Ä: ${res.order_number}`);
                    loadCart();
                    updateCartBadge().catch(() => {}); // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–∞
                    nav('orders');
                } else {
                    tg.showAlert(res?.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                }
            } catch (e) {
                console.error('Error checkout:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã
        async function loadOrders() {
            safe('orders-content', async c => {
                c.innerHTML = '<div style="text-align:center;padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                try {
                    const res = await safeFetch(`${API}/api/marketplace/orders/${uid}`);
                    if (res.status !== 'ok' || !res.orders || res.orders.length === 0) {
                        c.innerHTML = '<div style="text-align:center;padding:60px;"><i class="fa-solid fa-box" style="font-size:48px;color:var(--sec);opacity:0.5;margin-bottom:16px;"></i><div style="color:var(--sec);font-size:16px;">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div></div>';
                        return;
                    }
                    
                    let html = '';
                    res.orders.forEach(order => {
                        const statusColors = {
                            'PENDING': '#FF9500',
                            'PAID': '#007AFF',
                            'PROCESSING': '#5856D6',
                            'SHIPPED': '#34C759',
                            'DELIVERED': '#34C759',
                            'CANCELLED': '#FF3B30'
                        };
                        const statusText = {
                            'PENDING': '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã',
                            'PAID': '–û–ø–ª–∞—á–µ–Ω',
                            'PROCESSING': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                            'SHIPPED': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω',
                            'DELIVERED': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
                            'CANCELLED': '–û—Ç–º–µ–Ω–µ–Ω'
                        };
                        
                        html += `
                            <div class="card" style="padding:16px;margin-bottom:12px;">
                                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                                    <div>
                                        <div style="font-weight:700;font-size:16px;margin-bottom:4px;">–ó–∞–∫–∞–∑ ${order.order_number}</div>
                                        <div style="font-size:12px;color:var(--sec);">${new Date(order.created_at).toLocaleString('ru-RU')}</div>
                                    </div>
                                    <div style="background:${statusColors[order.status] || '#8E8E93'}20;color:${statusColors[order.status] || '#8E8E93'};padding:6px 12px;border-radius:12px;font-size:12px;font-weight:600;">
                                        ${statusText[order.status] || order.status}
                                    </div>
                                </div>
                                <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:12px;">
                                    ${order.items.map(item => `
                                        <div style="display:flex;gap:12px;margin-bottom:8px;">
                                            <img src="${item.product_image || 'https://ui-avatars.com/api/?name=PROD&size=60'}" 
                                                 style="width:50px;height:50px;object-fit:cover;border-radius:8px;">
                                            <div style="flex:1;">
                                                <div style="font-size:14px;font-weight:600;">${(item.product_title || '–¢–æ–≤–∞—Ä').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                                                <div style="font-size:12px;color:var(--sec);">${item.quantity} —à—Ç. √ó ${item.price} TJS</div>
                                            </div>
                                            <div style="font-weight:700;color:var(--blue);">${item.total} TJS</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
                                    <div style="font-size:12px;color:var(--sec);">–ò—Ç–æ–≥–æ</div>
                                    <div style="font-size:20px;font-weight:800;color:var(--blue);">${order.total_amount} TJS</div>
                                </div>
                            </div>
                        `;
                    });
                    c.innerHTML = html;
                } catch (e) {
                    console.error('Error loading orders:', e);
                    c.innerHTML = '<div style="text-align:center;padding:40px;color:var(--sec);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
                }
            });
        }

        /* ================= WALLET ================= */
        async function loadWallet() {
            try {
                const d = await cachedFetch(`${API}/api/wallet/${uid}`, 'wallet');
                if (d.status !== 'ok' || !d.balances) return;

                const b = d.balances;
                const tjs = Number(b.tjs || 0);
                const usd = Number(b.usd || 0);
                const bonus = Number(b.bonus_kg || 0);

                safe('u-bonus', el => el.innerText = bonus.toFixed(2));
                safe('p-bonus', el => el.innerText = bonus.toFixed(2));

                safe('u-balance-tjs', el => el.innerText = tjs.toFixed(2));
                safe('u-balance-usd', el => el.innerText = usd.toFixed(2));

                safe('w-b-tjs', el => el.innerText = tjs.toFixed(2));
                safe('w-b-usd', el => el.innerText = usd.toFixed(2));
                safe('w-b-bonus', el => el.innerText = bonus.toFixed(2));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é updateWalletUI –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ init
                updateWalletUI = (balances) => {
                    const tjs = Number(balances.tjs || 0);
                    const usd = Number(balances.usd || 0);
                    safe('u-balance-tjs', el => el.innerText = tjs.toFixed(2));
                    safe('u-balance-usd', el => el.innerText = usd.toFixed(2));
                };
            } catch (e) {
                console.error('Wallet load error:', e);
            }
        }

        async function loadWalletHistory() {
            safe('wallet-tx-list', el => el.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...');
            try {
                const d = await safeFetch(`${API}/api/wallet/${uid}/transactions?limit=20`);
                if (d.status !== 'ok' || !d.transactions || d.transactions.length === 0) {
                    safe('wallet-tx-list', el => el.innerHTML = '<div style="text-align:center; padding:10px; color:#8e8e93;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>');
                    return;
                }

                const typeIcons = {
                    'DEPOSIT': '‚ûï',
                    'WITHDRAWAL': '‚ûñ',
                    'BONUS': 'üéÅ'
                };

                const currencyNames = {
                    'TJS': 'TJS',
                    'USD': 'USD',
                    'BONUS_KG': '–∫–≥'
                };

                let h = '';
                d.transactions.forEach(t => {
                    const icon = typeIcons[t.type] || '‚Ä¢';
                    const curName = currencyNames[t.currency] || t.currency;
                    const amount = Number(t.amount || 0);
                    const amountStr = (amount > 0 ? '+' : '') + amount.toFixed(2) + ' ' + curName;
                    h += `<div style="padding:8px 0; border-bottom:1px solid #f2f2f2;">
                            <div style="display:flex; justify-content:space-between; font-size:13px;">
                                <span>${icon} ${amountStr}</span>
                                <span style="opacity:0.7;">${t.created_at}</span>
                            </div>`;
                    if (t.description) {
                        h += `<div style="font-size:12px; opacity:0.8; margin-top:2px;">${t.description}</div>`;
                    }
                    h += `</div>`;
                });

                safe('wallet-tx-list', el => el.innerHTML = h);
            } catch (e) {
                console.error('Wallet history error:', e);
                safe('wallet-tx-list', el => el.innerHTML = '<div style="text-align:center; padding:10px; color:#8e8e93;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>');
            }
        }

        /* ================= ORDER SUBMISSION ================= */
        async function submitOrder() {
            if (!lastCalc) {
                tg.showAlert('–°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å');
                return;
            }
            try {
                const d = await safeFetch(`${API}/api/create_order`, {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: uid,
                        route: lastCalc.route,
                        weight: lastCalc.weight * lastCalc.quantity,
                        price: lastCalc.price
                    })
                });
                if (d.status === 'ok') {
                    invalidateCache('dashboard');
                    tg.showAlert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
                    safe('btn-order-confirm', el => el.style.display = 'none');
                    lastCalc = null;
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                }
            } catch (e) {
                console.error('Order error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
            }
        }

        /* ================= REWARD CLAIM ================= */
        async function claimRew(taskId) {
            try {
                const d = await safeFetch(`${API}/api/rewards/claim`, {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: uid,
                        task_id: taskId
                    })
                });
                if (d.status === 'ok') {
                    tg.showAlert('–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! –ë–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª–µ–Ω.');
                    ldRew();
                    init(); // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è');
                }
            } catch (e) {
                console.error('Reward error:', e);
            }
        }

        /* ================= EXCHANGE ORDERS ================= */
        async function createExchangeOrder() {
            const route = gid('eo-route')?.value;
            const weight = parseFloat(gid('eo-weight')?.value || 0);
            const price = parseFloat(gid('eo-price')?.value || 0);
            const currency = gid('eo-currency')?.value || 'USD';
            const desc = gid('eo-desc')?.value || '';
            
            if (!route || !weight || !price) {
                tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const r = await fetch(`${API}/api/exchange/create`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        route: route,
                        weight: weight,
                        price_per_kg: price,
                        currency: currency,
                        description: desc
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    tg.showAlert('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!');
                    closeM('m-create-order');
                    ldTr();
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                }
            } catch(e) {
                console.error('Create order error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
            }
        }

        async function acceptExOrder(orderId) {
            try {
                const r = await fetch(`${API}/api/exchange/accept`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        order_id: orderId
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    invalidateCache('exchange');
                    tg.showAlert('–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!');
                    ldTr();
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞');
                }
            } catch(e) {
                console.error('Accept error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞');
            }
        }

        async function holdEscrow(orderId) {
            try {
                const r = await fetch(`${API}/api/exchange/hold`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        order_id: orderId
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    invalidateCache('exchange');
                    invalidateCache('wallet');
                    invalidateCache('dashboard');
                    tg.showAlert('–î–µ–Ω—å–≥–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã');
                    ldTr();
                    loadWallet(); // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                } else {
                    tg.showAlert(d.detail || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                }
            } catch(e) {
                console.error('Hold error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞');
            }
        }

        async function completeExOrder(orderId) {
            try {
                const r = await fetch(`${API}/api/exchange/complete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        order_id: orderId
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    invalidateCache('exchange');
                    invalidateCache('wallet');
                    invalidateCache('dashboard');
                    tg.showAlert('–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –î–µ–Ω—å–≥–∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –≤–æ–¥–∏—Ç–µ–ª—é.');
                    ldTr();
                    loadWallet(); // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞');
                }
            } catch(e) {
                console.error('Complete error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞');
            }
        }

        async function cancelExOrder(orderId) {
            if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')) return;
            try {
                const r = await fetch(`${API}/api/exchange/cancel`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        order_id: orderId
                    })
                });
                const d = await r.json();
                if (d.status === 'ok') {
                    invalidateCache('exchange');
                    invalidateCache('wallet');
                    invalidateCache('dashboard');
                    tg.showAlert('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω');
                    ldTr();
                    loadWallet(); // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                } else {
                    tg.showAlert(d.detail || '–û—à–∏–±–∫–∞');
                }
            } catch(e) {
                console.error('Cancel error:', e);
                tg.showAlert('–û—à–∏–±–∫–∞');
            }
        }

        /* ================= AVATAR EDITING ================= */
        function editAvatar() {
            const currentAva = gid('p-ava')?.src || '';
            safe('avatar-preview', el => {
                if (el) {
                    el.onerror = () => {
                        const firstName = tg.initDataUnsafe?.user?.first_name || "User";
                        el.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(firstName)}&size=120&background=007AFF&color=fff`;
                    };
                    el.src = currentAva || `https://ui-avatars.com/api/?name=${encodeURIComponent(tg.initDataUnsafe?.user?.first_name || "User")}&size=120&background=007AFF&color=fff`;
                }
            });
            openM('m-avatar');
        }
        
        async function useTelegramPhoto() {
            const telegramPhoto = tg.initDataUnsafe?.user?.photo_url || "";
            if (!telegramPhoto) {
                tg.showAlert('–§–æ—Ç–æ –∏–∑ Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
                return;
            }
            
            await updateAvatar(telegramPhoto);
        }
        
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                tg.showAlert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ data URL –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                safe('avatar-preview', el => {
                    if (el) {
                        el.onerror = () => {
                            tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                        };
                        el.src = base64Image;
                    }
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–∏—Å–ø–æ–ª—å–∑—É–µ–º base64)
                await updateAvatar(base64Image);
            };
            reader.readAsDataURL(file);
        }
        
        async function updateAvatar(avatarUrl) {
            try {
                const result = await safeFetch(`${API}/api/update_settings`, {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: uid,
                        avatar_url: avatarUrl
                    })
                });
                if (result.status === 'ok') {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                    safe('u-ava', el => el.src = avatarUrl);
                    safe('p-ava', el => el.src = avatarUrl);
                    user.avatar_url = avatarUrl;
                    closeM('m-avatar');
                    tg.showAlert('–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
                }
            } catch (error) {
                console.error('Error updating avatar:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
            }
        }

        /* ================= START ================= */
        init();
    </script>
</body>
</html>
