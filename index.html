<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Cargo365Plus</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --accent: #248bed;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #1c1c1e;
            --hint: #8e8e93;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding-bottom: 100px; /* Чтобы кнопка не закрывала список */
        }

        /* Шапка */
        .header {
            background: linear-gradient(135deg, #248bed 0%, #1572de 100%);
            padding: 30px 20px 40px;
            color: white;
            text-align: center;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .avatar {
            width: 70px;
            height: 70px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: bold;
            margin: 0 auto 10px;
        }

        .user-name { font-size: 20px; font-weight: 700; }
        .user-phone { font-size: 14px; opacity: 0.8; }

        /* Статистика */
        .stats {
            display: flex;
            gap: 12px;
            margin: -25px 16px 20px;
        }

        .stat-card {
            flex: 1;
            background: var(--card);
            padding: 16px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .stat-value { font-size: 18px; font-weight: 800; color: var(--accent); }
        .stat-label { font-size: 11px; color: var(--hint); text-transform: uppercase; margin-top: 4px; }

        /* Список посылок */
        .section-header {
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .section-title { font-size: 16px; font-weight: 700; color: var(--hint); text-transform: uppercase; }

        .package-list { padding: 0 16px; }

        .package-item {
            background: var(--card);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        .pkg-track { font-weight: 700; font-size: 15px; display: block; }
        .pkg-desc { font-size: 13px; color: var(--hint); }

        .pkg-status {
            font-size: 11px;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 8px;
            background: #e3f2fd;
            color: #1976d2;
        }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: flex-end;
        }

        .modal-content {
            background: white;
            width: 100%;
            padding: 24px;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-sizing: border-box;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        input {
            width: 100%;
            padding: 14px;
            margin: 8px 0 16px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 16px;
            background: #f9f9f9;
        }

        /* Кнопки */
        .main-btn {
            position: fixed;
            bottom: 20px; left: 16px; right: 16px;
            background: var(--accent);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(36, 139, 237, 0.3);
            cursor: pointer;
        }

        .save-btn {
            background: var(--accent);
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
        }

        #loader { text-align: center; margin-top: 100px; color: var(--hint); }
    </style>
</head>
<body>

<div id="loader">Загрузка данных...</div>

<div id="app-content" style="display: none;">
    <div class="header">
        <div class="avatar" id="avatar-letters">??</div>
        <div class="user-name" id="user-name">...</div>
        <div class="user-phone" id="user-phone">...</div>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="bonus-balance">0.0 кг</div>
            <div class="stat-label">Бонусы</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="active-orders">0</div>
            <div class="stat-label">В пути</div>
        </div>
    </div>

    <div class="section-header">
        <span class="section-title">Мои посылки</span>
        <span style="color: var(--accent); font-size: 13px;" onclick="loadPackages()">Обновить</span>
    </div>

    <div class="package-list" id="package-list"></div>
</div>

<button class="main-btn" onclick="openModal()">➕ Добавить трек-номер</button>

<div id="trackModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin-top: 0;">Новая посылка</h3>
        <label style="font-size: 14px; color: var(--hint);">Трек-номер</label>
        <input type="text" id="trackInput" placeholder="Например: 994000..." />
        
        <label style="font-size: 14px; color: var(--hint);">Описание (необязательно)</label>
        <input type="text" id="descInput" placeholder="Например: Кроссовки" />
        
        <button class="save-btn" onclick="handleSave()">Сохранить трек</button>
        <button style="background:none; border:none; color:var(--hint); width:100%; margin-top:12px;" onclick="closeModal()">Отмена</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const API_BASE = "https://unforeshortened-interartistic-judith.ngrok-free.dev"; 
    const userId = tg.initDataUnsafe?.user?.id || 317295540; 

    const headers = {
        "Content-Type": "application/json",
        "ngrok-skip-browser-warning": "true"
    };

    async function initApp() {
        try {
            const dashRes = await fetch(`${API_BASE}/api/dashboard/${userId}`, { headers });
            const dashData = await dashRes.json();

            if (dashData.status === "ok") {
                document.getElementById("user-name").innerText = dashData.user_info.full_name;
                document.getElementById("user-phone").innerText = "+" + dashData.user_info.phone;
                document.getElementById("bonus-balance").innerText = dashData.user_info.bonus_balance + " кг";
                document.getElementById("active-orders").innerText = dashData.stats.active_orders;
                
                const names = dashData.user_info.full_name.split(' ');
                document.getElementById("avatar-letters").innerText = (names[0]?.[0] || '') + (names[1]?.[0] || '');

                await loadPackages();
                document.getElementById("loader").style.display = "none";
                document.getElementById("app-content").style.display = "block";
            } else {
                document.getElementById("loader").innerText = "Пожалуйста, зарегистрируйтесь в боте.";
            }
        } catch (e) {
            document.getElementById("loader").innerText = "Ошибка API. Проверьте сервер.";
        }
    }

    async function loadPackages() {
        const pkgRes = await fetch(`${API_BASE}/api/packages/${userId}`, { headers });
        const pkgData = await pkgRes.json();
        const listCont = document.getElementById("package-list");
        listCont.innerHTML = "";

        if (pkgData.packages?.length > 0) {
            pkgData.packages.forEach(pkg => {
                listCont.innerHTML += `
                    <div class="package-item">
                        <div class="pkg-info">
                            <span class="pkg-track">${pkg.track}</span>
                            <span class="pkg-desc">${pkg.description || 'Без описания'}</span>
                        </div>
                        <span class="pkg-status">${pkg.status}</span>
                    </div>
                `;
            });
        } else {
            listCont.innerHTML = "<div style='text-align:center; padding:40px; color:var(--hint);'>Нет активных посылок</div>";
        }
    }

    // Логика модального окна
    function openModal() { document.getElementById("trackModal").style.display = "flex"; }
    function closeModal() { document.getElementById("trackModal").style.display = "none"; }

    async function handleSave() {
        const track = document.getElementById("trackInput").value;
        const desc = document.getElementById("descInput").value;

        if (!track) {
            tg.showAlert("Введите трек-номер!");
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/api/add_track`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ user_id: userId, track_number: track, description: desc })
            });
            const result = await res.json();
            
            if (result.status === "success") {
                closeModal();
                document.getElementById("trackInput").value = "";
                document.getElementById("descInput").value = "";
                tg.showAlert("Трек добавлен!");
                loadPackages();
            } else {
                tg.showAlert(result.message);
            }
        } catch (e) {
            tg.showAlert("Ошибка при сохранении.");
        }
    }

    initApp();
</script>

</body>
</html>
