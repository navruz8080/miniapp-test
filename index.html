<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>Drop SuperApp</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
--bg:#0E0E11;
--card:#17171C;
--accent:#5B8CFF;
--text:#FFFFFF;
--muted:#8B8B94;
--radius:18px;
}
*{box-sizing:border-box}
body{
margin:0;
font-family:Inter,sans-serif;
background:var(--bg);
color:var(--text);
}
.app{
max-width:480px;
margin:0 auto;
padding:16px;
padding-bottom:120px;
}
.card{
background:var(--card);
border-radius:var(--radius);
padding:18px;
margin-bottom:14px;
}
h1{font-size:22px;margin:0}
h2{font-size:16px;margin:0 0 10px}
.muted{color:var(--muted);font-size:12px}
.btn{
width:100%;
padding:16px;
border:none;
border-radius:14px;
font-weight:700;
font-size:15px;
background:var(--accent);
color:#fff;
cursor:pointer;
}
.btn-secondary{
background:#23232A;
}
.row{
display:flex;
justify-content:space-between;
align-items:center;
}
.badge{
padding:4px 8px;
border-radius:8px;
font-size:11px;
font-weight:700;
background:#23232A;
}
.list-item{
padding:12px 0;
border-bottom:1px solid #222;
}
.list-item:last-child{border:none}
</style>
</head>

<body>
<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API = "https://unforeshortened-interartistic-judith.ngrok-free.dev";
const uid = tg.initDataUnsafe?.user?.id;

let user={}, config={};
</script>

<div class="app">

<!-- HEADER -->
<div class="card">
<div class="row">
<div>
<h1 id="u-name">Загрузка…</h1>
<div class="muted">ID: <span id="u-id"></span></div>
</div>
<div class="badge" id="u-level">LVL</div>
</div>
</div>

<!-- BALANCE -->
<div class="card">
<div class="muted">Бонусный баланс</div>
<div style="font-size:32px;font-weight:800;margin-top:6px">
<span id="u-bonus">0</span> кг
</div>
</div>

<!-- PRIMARY ACTION -->
<div class="card">
<h2 id="cta-title">Действие</h2>
<button class="btn" id="cta-btn">Загрузка…</button>
</div>

<!-- ACTIVE PROCESSES -->
<div class="card">
<h2>Активные процессы</h2>
<div id="activity-list" class="muted">Загрузка…</div>
</div>

<!-- QUICK ACTIONS -->
<div class="card">
<button class="btn btn-secondary" onclick="openMarket()">Маркет</button>
<br><br>
<button class="btn btn-secondary" onclick="openTrucks()">Биржа</button>
</div>

</div>

<script>
async function init(){
const r = await fetch(`${API}/api/dashboard/${uid}`, {headers:{'ngrok-skip-browser-warning':'true'}});
const d = await r.json();

user = d.user_info;
config = d.app_config;

document.getElementById('u-name').innerText = user.name || "Client";
document.getElementById('u-id').innerText = uid;
document.getElementById('u-level').innerText = user.level;
document.getElementById('u-bonus').innerText = user.bonus_kg;

// CTA logic (Blum-style)
if(user.category === 'more_100'){
setCTA("Создать заявку на груз","createCargo");
}else{
setCTA("Добавить трек-номер","addTrack");
}

// Activity
renderActivity(d.packages);
}

function setCTA(title, action){
document.getElementById('cta-title').innerText = title;
document.getElementById('cta-btn').onclick = ()=>startFlow(action);
document.getElementById('cta-btn').innerText = title;
}

function renderActivity(items){
if(!items || !items.length){
document.getElementById('activity-list').innerHTML = "<div class='muted'>Нет активных процессов</div>";
return;
}
let html="";
items.forEach(p=>{
html+=`
<div class="list-item">
<b>${p.description || 'Посылка'}</b>
<div class="muted">${p.track_number} • ${p.status_text}</div>
</div>`;
});
document.getElementById('activity-list').innerHTML = html;
}

function startFlow(type){
tg.HapticFeedback.impactOccurred('medium');
if(type==='addTrack') tg.showAlert("Открыть flow: Добавить трек");
if(type==='createCargo') tg.showAlert("Открыть flow: Создать груз");
}

function openMarket(){ tg.showAlert("Маркет (следующий экран)"); }
function openTrucks(){ tg.showAlert("Биржа (следующий экран)"); }

init();
</script>

</body>
</html>
