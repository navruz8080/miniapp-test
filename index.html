<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop SuperApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #F2F3F5; --card: #FFFFFF; --text: #1F1F1F; --sec: #8E8E93; --blue: #007AFF; --radius: 16px; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        .container { padding: 16px; max-width: 480px; margin: 0 auto; padding-bottom: 100px; }
        .screen { display: none; width: 100%; padding-bottom: 80px; }
        .screen.active { display: block !important; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 10px; }
        .user-row { display: flex; align-items: center; gap: 10px; }
        .ava { width: 44px; height: 44px; border-radius: 50%; background: #ccc; object-fit: cover; }
        .lvl-badge { background: #FFD60A; color: #000; font-size: 10px; padding: 2px 6px; border-radius: 8px; font-weight: 800; text-transform: uppercase; }
        
        .bonus-card { background: linear-gradient(135deg, #111 0%, #333 100%); border-radius: 20px; padding: 20px; color: white; margin-bottom: 24px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .b-val { font-size: 32px; font-weight: 800; margin: 5px 0; }
        .b-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 8px 14px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; }
        
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 30px; }
        .grid-item { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; }
        .icon-box { width: 54px; height: 54px; background: var(--card); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .grid-lbl { font-size: 11px; font-weight: 600; color: var(--text); }
        
        .card { background: var(--card); padding: 16px; border-radius: var(--radius); margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .btn { width: 100%; padding: 14px; border-radius: 14px; border: none; background: var(--text); color: #fff; font-weight: 700; font-size: 15px; cursor: pointer; }
        .btn-blue { background: var(--blue); }
        input, select { width: 100%; padding: 14px; background: #F2F4F7; border: none; border-radius: 12px; margin-bottom: 10px; box-sizing: border-box; font-family: 'Inter'; font-size: 15px; }
        
        .nav-head { background: rgba(255,255,255,0.95); position: sticky; top: 0; z-index: 90; padding: 12px 16px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); margin-bottom: 10px; }
        .back-icon { font-size: 20px; cursor: pointer; padding: 5px; }
        .pg-title { font-size: 17px; font-weight: 700; }
        
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 34px; transition: .2s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%; transition: .2s; }
        input:checked + .slider { background-color: var(--blue); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .tabs { background: #E5E5EA; padding: 4px; border-radius: 12px; display: flex; margin-bottom: 15px; }
        .tab { flex: 1; padding: 8px; text-align: center; font-size: 13px; font-weight: 600; border-radius: 9px; cursor: pointer; color: #8E8E93; }
        .tab.active { background: #fff; color: #000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: flex-end; }
        .modal { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding: 24px; animation: slideUp 0.2s; }
        @keyframes slideUp { from {transform:translateY(100%)} to {transform:translateY(0)} }
        
        .empty { text-align: center; color: #999; padding: 30px; font-size: 13px; }
        
        /* üî• –ö–ù–û–ü–ö–ê –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø */
        .copy-box { 
            background: #F0F2F5; padding: 14px; border-radius: 12px; 
            position: relative; cursor: pointer; 
            padding-right: 60px; /* –ú–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
        }
        .copy-text { 
            font-family: monospace; font-size: 13px; line-height: 1.4; color: #333; 
            word-break: break-all;
        }
        .copy-btn { 
            position: absolute; top: 50%; transform: translateY(-50%); right: 10px; 
            width: 36px; height: 36px; background: #fff; border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; 
            color: var(--blue); box-shadow: 0 2px 6px rgba(0,0,0,0.08); 
        }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <div class="container">
            <div class="header">
                <div class="user-row">
                    <img id="u-ava" class="ava" src="">
                    <div>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <b id="u-name">...</b>
                            <span id="u-lvl" class="lvl-badge">...</span>
                        </div>
                        <div style="font-size:12px; color:var(--sec);">ID: <span id="u-id">...</span></div>
                    </div>
                </div>
                <div onclick="nav('settings')" style="padding:10px;"><i class="fa-solid fa-gear"></i></div>
            </div>

            <div class="bonus-card">
                <div style="opacity:0.7; font-size:12px; text-transform:uppercase;">–ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
                <div class="b-val"><span id="u-bonus">0</span> <span style="font-size:16px;">–∫–≥</span></div>
                <button class="b-btn" onclick="nav('rewards')"><i class="fa-solid fa-star"></i> –ó–∞–¥–∞–Ω–∏—è</button>
            </div>

            <div style="font-weight:700; margin-bottom:15px;">–ú–µ–Ω—é</div>
            <div class="grid">
                <div class="grid-item" onclick="nav('china')"><div class="icon-box" style="color: #FF2D55;"><i class="fa-brands fa-dhl"></i></div><span class="grid-lbl">–ö–∏—Ç–∞–π</span></div>
                <div class="grid-item" onclick="nav('trucks')"><div class="icon-box" style="color: #5856D6;"><i class="fa-solid fa-truck-fast"></i></div><span class="grid-lbl">–ë–∏—Ä–∂–∞</span></div>
                <div class="grid-item" onclick="nav('market')"><div class="icon-box" style="color: #FF9500;"><i class="fa-solid fa-bag-shopping"></i></div><span class="grid-lbl">–ú–∞—Ä–∫–µ—Ç</span></div>
                <div class="grid-item" onclick="nav('calc')"><div class="icon-box" style="color: #007AFF;"><i class="fa-solid fa-calculator"></i></div><span class="grid-lbl">–†–∞—Å—á–µ—Ç</span></div>
            </div>

            <div style="font-weight:700; margin-bottom:10px;">–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</div>
            <div id="home-pkg-list"></div>
        </div>
    </div>

    <div id="screen-china" class="screen">
        <div class="nav-head"><div class="back-icon" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ú–æ–π –ö–∏—Ç–∞–π</div></div>
        <div class="container">
            <div class="card">
                <div class="switch-row"><b>–û–ø—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (>100 –∫–≥)</b><label class="switch"><input type="checkbox" id="tg-opt" onchange="toggleMode()"><span class="slider"></span></label></div>
            </div>
            <div class="card">
                <b>–ê–¥—Ä–µ—Å –°–∫–ª–∞–¥–∞</b>
                <div id="box-city" style="display:none; margin-top:10px;"><select id="sel-city" onchange="renderAddr()"><option value="yiwu">–ò—É (Yiwu)</option><option value="urumqi">–£—Ä—É–º—á–∏</option></select></div>
                <div class="copy-box" onclick="copy('txt-addr')" style="margin-top:8px;">
                    <div id="txt-addr" class="copy-text">...</div>
                    <div class="copy-btn"><i class="fa-regular fa-copy"></i></div>
                </div>
            </div>
            <div id="box-code" class="card">
                <b>–í–∞—à –ö–æ–¥ (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)</b>
                <div class="copy-box" onclick="copy('txt-code')" style="margin-top:8px;">
                    <div id="txt-code" class="copy-text" style="font-weight:700; color:var(--blue);">...</div>
                    <div class="copy-btn"><i class="fa-regular fa-copy"></i></div>
                </div>
            </div>
            <button class="btn btn-blue" onclick="openM('m-add')">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫</button>
            <div id="full-pkg-list" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <div class="nav-head"><div class="back-icon" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div></div>
        <div class="container">
            <div class="card">
                <label style="font-size:12px;">–í–∞—à–µ –ò–º—è</label><input id="s-name">
                <label style="font-size:12px;">–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="s-phone">
                <label style="font-size:12px;">–í—ã–±–µ—Ä–∏—Ç–µ –ü–í–ó</label><select id="s-pvz"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                <button class="btn btn-blue" onclick="saveSet()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="screen-calc" class="screen">
        <div class="nav-head"><div class="back-icon" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div></div>
        <div class="container">
            <div class="card">
                <div class="switch-row"><b>–û–ø—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º</b><label class="switch"><input type="checkbox" id="tg-calc" onchange="toggleMode()"><span class="slider"></span></label></div>
                <div id="box-calc-opt" style="display:none; margin-top:10px;"><label>–ú–∞—Ä—à—Ä—É—Ç</label><select id="sel-route"><option>–ú–∞—Ä—à—Ä—É—Ç...</option></select></div>
                <div style="margin-top:10px;"><label>–í–µ—Å (–∫–≥)</label><input id="c-wg" type="number" placeholder="0.0"></div>
                <div id="c-res" style="text-align:center; font-size: 28px; font-weight: 800; margin: 20px 0; color: var(--blue);">0.00</div>
                <button class="btn" onclick="doCalc()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="screen-trucks" class="screen">
        <div class="nav-head"><div class="back-icon" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ë–∏—Ä–∂–∞</div></div>
        <div class="container">
            <div class="tabs">
                <div id="tab-tr-1" class="tab active" onclick="swTr('trips')">–î–æ—Å—Ç–∞–≤–∏—Ç—å</div>
                <div id="tab-tr-2" class="tab" onclick="swTr('cargo')">–Ø –≤–æ–¥–∏—Ç–µ–ª—å</div>
            </div>
            <div id="list-trucks"></div>
            <button id="btn-tr-act" class="btn btn-blue" style="position:fixed; bottom:20px; width:calc(100% - 32px); left:16px;" onclick="trAct()">–î–µ–π—Å—Ç–≤–∏–µ</button>
        </div>
    </div>

    <div id="screen-market" class="screen"><div class="nav-head"><div class="back-icon" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ú–∞—Ä–∫–µ—Ç</div></div><div class="container"><div class="tabs"><div id="tab-buy" class="tab active" onclick="swMark('item')">–¢–æ–≤–∞—Ä—ã</div><div id="tab-joint" class="tab" onclick="swMark('joint')">–°–∫–ª–∞–¥—á–∏–Ω–∞</div></div><div id="list-market" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div><button class="btn btn-blue" style="position:fixed; bottom:20px; width:calc(100% - 32px); left:16px;" onclick="openM('m-prod')">–ü—Ä–æ–¥–∞—Ç—å</button></div></div>
    
    <div id="screen-rewards" class="screen"><div class="nav-head"><div class="back-icon" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i></div><div class="pg-title">–ù–∞–≥—Ä–∞–¥—ã</div></div><div class="container" id="list-rewards"></div></div>

    <div id="m-add" class="modal-wrap"><div class="modal"><h3>–¢—Ä–µ–∫</h3><input id="n-t" placeholder="–ù–æ–º–µ—Ä"><input id="n-d" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"><button class="btn btn-blue" onclick="subTrack()">OK</button><div style="text-align:center;padding:15px;" onclick="closeM('m-add')">X</div></div></div>
    <div id="m-prod" class="modal-wrap"><div class="modal"><h3>–ü—Ä–æ–¥–∞—Ç—å</h3><input id="p-t" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><input id="p-d" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"><input id="p-p" placeholder="–¶–µ–Ω–∞"><button class="btn btn-blue" onclick="subProd()">OK</button><div style="text-align:center;padding:15px;" onclick="closeM('m-prod')">X</div></div></div>
    <div id="m-cargo" class="modal-wrap"><div class="modal"><h3>–ì—Ä—É–∑</h3><input id="cg-f" placeholder="–û—Ç–∫—É–¥–∞"><input id="cg-t" placeholder="–ö—É–¥–∞"><input id="cg-d" placeholder="–ß—Ç–æ"><input id="cg-w" placeholder="–í–µ—Å"><input id="cg-p" placeholder="–¶–µ–Ω–∞"><button class="btn btn-blue" onclick="subCargo()">OK</button><div style="text-align:center;padding:15px;" onclick="closeM('m-cargo')">X</div></div></div>
    <div id="m-trip" class="modal-wrap"><div class="modal"><h3>–†–µ–π—Å</h3><input id="tr-f" placeholder="–û—Ç–∫—É–¥–∞"><input id="tr-t" placeholder="–ö—É–¥–∞"><input id="tr-p" placeholder="–¶–µ–Ω–∞ –∫–≥"><button class="btn btn-blue" onclick="subTrip()">OK</button><div style="text-align:center;padding:15px;" onclick="closeM('m-trip')">X</div></div></div>
    <div id="m-driver" class="modal-wrap"><div class="modal"><h3>–í–æ–¥–∏—Ç–µ–ª—å</h3><input id="d-c" placeholder="–ê–≤—Ç–æ"><input id="d-n" placeholder="–ù–æ–º–µ—Ä"><input id="d-w" placeholder="–í–µ—Å"><button class="btn btn-blue" onclick="subDriver()">OK</button><div style="text-align:center;padding:15px;" onclick="closeM('m-driver')">X</div></div></div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const API = "https://unforeshortened-interartistic-judith.ngrok-free.dev"; 
        const uid = tg.initDataUnsafe?.user?.id || 317295540;
        
        let config = {}, user = {}, isOpt = false, tabTr = 'trips', tabMk = 'item', isDriver = false;

        async function init() {
            try {
                document.getElementById('u-ava').src = tg.initDataUnsafe?.user?.photo_url || "";
                let r = await fetch(`${API}/api/dashboard/${uid}`, {headers:{'ngrok-skip-browser-warning':'true'}});
                let d = await r.json();
                config = d.app_config; user = d.user_info;

                // UI Fill
                gid('u-name').innerText = user.name || "Client";
                gid('u-id').innerText = `ID: ${uid}`;
                gid('u-lvl').innerText = user.level;
                gid('u-bonus').innerText = user.bonus_kg;
                gid('txt-code').innerText = user.marking_code;

                // Settings: –ó–∞–ø–æ–ª–Ω—è–µ–º –ü–í–ó –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
                renderPvzOptions(config.pvz_list, user.pvz_id);
                gid('s-name').value = user.name;
                gid('s-phone').value = user.marking_code.split('/').pop().trim();

                // Packages
                let h=''; d.packages.forEach(p=>h+=`<div class="card" style="padding:12px;"><div style="font-weight:700">${p.description}</div><div style="font-size:12px;color:#888">${p.track_number} ‚Ä¢ ${p.status_text}</div></div>`);
                gid('home-pkg-list').innerHTML = h || '<div class="empty">–ù–µ—Ç –ø–æ—Å—ã–ª–æ–∫</div>';

                // Routes
                let rr = await fetch(`${API}/api/get_routes`); let rd = await rr.json();
                let s = gid('sel-route'); s.innerHTML='<option>–ú–∞—Ä—à—Ä—É—Ç...</option>';
                if(rd.routes) rd.routes.forEach(r=>{let o=document.createElement('option');o.value=r;o.innerText=r;s.appendChild(o)});

                isOpt = (user.category === 'more_100');
                updMode(); checkDriver();

            } catch(e) { console.error(e); tg.showAlert("–û—à–∏–±–∫–∞: " + e.message); }
        }

        function renderPvzOptions(list, currentId) {
            let sel = gid('s-pvz'); sel.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>';
            if (list) list.forEach(p => {
                let opt = document.createElement('option');
                opt.value = p.id; opt.innerText = p.name;
                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º ID (–æ–±–∞ –º–æ–≥—É—Ç –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏)
                if (p.id == currentId) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        // --- NAV ---
        function nav(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            gid('screen-'+id).classList.add('active');
            if(id==='trucks') ldTr(); if(id==='market') ldMk(); if(id==='rewards') ldRew();
        }
        function goHome() {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            gid('screen-home').classList.add('active');
        }

        // --- LOGIC ---
        function toggleMode() {
            if(gid('screen-calc').classList.contains('active')) isOpt=gid('tg-calc').checked;
            else isOpt=gid('tg-opt').checked;
            updMode();
            fetch(`${API}/api/update_settings`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:uid, category:isOpt?'more_100':'less_100'})});
        }
        function updMode() {
            gid('tg-opt').checked = isOpt; gid('tg-calc').checked = isOpt;
            gid('box-city').style.display = isOpt ? 'block' : 'none';
            gid('box-code').style.display = isOpt ? 'none' : 'block';
            gid('box-calc-opt').style.display = isOpt ? 'block' : 'none';
            renderAddr();
        }
        function renderAddr() {
            let t = gid('txt-addr');
            if(isOpt) {
                let c = gid('sel-city').value;
                t.innerText = config.warehouses?.wholesale?.[c]?.address || "–ù–µ—Ç –∞–¥—Ä–µ—Å–∞";
            } else {
                t.innerText = config.warehouses?.retail?.address || "–ù–µ—Ç –∞–¥—Ä–µ—Å–∞";
            }
        }

        // --- TRUCKS ---
        function swTr(t) {
            tabTr = t;
            gid('tab-tr-1').className = t==='trips'?'tab active':'tab';
            gid('tab-tr-2').className = t==='cargo'?'tab active':'tab';
            let b = gid('btn-tr-act');
            if(t==='trips') { b.innerText = "üì¶ –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–∑"; b.onclick = ()=>openM('m-cargo'); }
            else { b.innerText = isDriver ? "üöö –°–æ–∑–¥–∞—Ç—å —Ä–µ–π—Å" : "üë®‚Äç‚úàÔ∏è –°—Ç–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–º"; b.onclick = isDriver ? ()=>openM('m-trip') : ()=>openM('m-driver'); }
            ldTr();
        }
        async function ldTr() {
            let c=gid('list-trucks'); c.innerHTML='<div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                let r=await fetch(`${API}/api/trucking/list?type=${tabTr}`); let d=await r.json();
                c.innerHTML=''; if(!d.items?.length) { c.innerHTML='<div class="empty">–ü—É—Å—Ç–æ</div>'; return; }
                d.items.forEach(i => {
                    let brd = i.type==='trip'?'var(--blue)':'#FF9500';
                    c.innerHTML += `<div class="card" style="border-left:4px solid ${brd};padding:14px;"><div style="font-weight:700">${i.title}</div><div style="font-size:12px;color:#888;margin-top:2px;">${i.subtitle}</div><div style="margin-top:8px;font-weight:700;font-size:13px;display:flex;justify-content:space-between;"><span style="color:${brd}">${i.details}</span><span>${i.extra}</span></div></div>`;
                });
            } catch(e) {}
        }
        async function checkDriver() { try { let r=await fetch(`${API}/api/trucking/status/${uid}`); let d=await r.json(); isDriver=d.is_driver; } catch(e){} }
        function trAct() { /* Handled in swTr */ }

        // --- MARKET ---
        function swMark(t) {
            tabMk = t;
            gid('tab-buy').className = t==='item'?'tab active':'tab';
            gid('tab-joint').className = t==='joint'?'tab active':'tab';
            ldMk();
        }
        async function ldMk() {
            let c=gid('list-market'); c.innerHTML='<div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                let r=await fetch(`${API}/api/market/list?type=${tabMk}`); let d=await r.json();
                c.innerHTML=''; if(!d.items?.length) { c.innerHTML='<div class="empty">–ü—É—Å—Ç–æ</div>'; return; }
                d.items.forEach(i => {
                    c.innerHTML += `<div class="card" style="margin:0;padding:10px;"><img src="${i.image_url||'https://placehold.co/100'}" style="width:100%;height:100px;object-fit:cover;border-radius:10px;background:#eee;"><div style="font-weight:600;font-size:13px;margin-top:6px;">${i.title}</div><div style="font-weight:700;color:#007AFF;font-size:14px;">${i.price} TJS</div></div>`;
                });
            } catch(e) {}
        }

        // --- REWARDS ---
        async function ldRew() {
            let c=gid('list-rewards'); c.innerHTML='<div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                let r=await fetch(`${API}/api/rewards/list/${uid}`); let d=await r.json();
                c.innerHTML='';
                d.tasks.forEach(t => {
                    c.innerHTML += `<div class="card" style="display:flex;align-items:center;gap:15px;"><div style="font-size:24px;color:var(--blue);"><i class="fa-solid ${t.icon}"></i></div><div style="flex:1;"><b>${t.title}</b><div style="font-size:11px;color:#888;">${t.desc}</div></div><button class="btn btn-blue" style="width:auto;padding:8px 12px;font-size:12px;" onclick="claim(${t.id})">+${t.reward}–∫–≥</button></div>`;
                });
            } catch(e){}
        }
        async function claim(id) {
            let r=await fetch(`${API}/api/rewards/claim`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:uid,task_id:id})});
            let d=await r.json(); tg.showAlert(d.message); if(d.status==='ok') init();
        }

        // --- UTILS ---
        function gid(id){return document.getElementById(id)}
        function openM(id){gid(id).style.display='flex'}
        function closeM(id){gid(id).style.display='none'}
        function copy(id){navigator.clipboard.writeText(gid(id).innerText); tg.HapticFeedback.notificationOccurred('success'); tg.showAlert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");}
        async function post(url, data) {
            data.user_id = uid;
            let r = await fetch(`${API}/api/${url}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
            return await r.json();
        }
        async function subTrack() { await post('add_track', {track_number:gid('n-t').value, description:gid('n-d').value}); closeM('m-add'); init(); }
        async function subProd() { await post('market/create', {title:gid('p-t').value, description:gid('p-d').value, price:parseFloat(gid('p-p').value), item_type:tabMk}); closeM('m-prod'); ldMk(); }
        async function subCargo() { await post('trucking/create_cargo', {city_from:gid('cg-f').value, city_to:gid('cg-t').value, description:gid('cg-d').value, weight:parseFloat(gid('cg-w').value), price_offer:parseFloat(gid('cg-p').value)}); closeM('m-cargo'); swTr('trips'); }
        async function subTrip() { await post('trucking/create_trip', {city_from:gid('tr-f').value, city_to:gid('tr-t').value, price_per_kg:parseFloat(gid('tr-p').value), date:'–°–∫–æ—Ä–æ'}); closeM('m-trip'); ldTr(); }
        async function subDriver() { await post('trucking/register', {car_model:gid('d-c').value, car_number:gid('d-n').value, max_weight_kg:parseFloat(gid('d-w').value)}); closeM('m-driver'); checkDriver(); tg.showAlert("–ì–æ—Ç–æ–≤–æ!"); }
        async function saveSet() { await post('update_settings', {full_name:gid('s-name').value, phone:gid('s-phone').value, pvz_id:parseInt(gid('s-pvz').value)}); goHome(); init(); tg.showAlert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"); }
        async function doCalc() {
            let p={user_id:uid, category:isOpt?'more_100':'less_100', weight_per_item:parseFloat(gid('c-wg').value), quantity:1};
            if(isOpt) { p.route_from=gid('sel-route').value.split(' - ')[0]; p.route_to=gid('sel-route').value.split(' - ')[1].split(' ')[0]; p.length=parseFloat(gid('c-l').value); p.width=parseFloat(gid('c-w').value); p.height=parseFloat(gid('c-h').value); }
            let r=await fetch(`${API}/api/calculate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
            let j=await r.json(); gid('c-res').innerText = j.status==='ok' ? `${j.price} ${j.currency}` : "–û—à–∏–±–∫–∞";
        }

        init();
    </script>
</body>
</html>
