<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Drop</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
    --bg-black:#000;--card-bg:#111;--tiffany:#1ae2c7;
    --text-main:#fff;--text-gray:#888;
}
body{
    font-family:-apple-system,system-ui,sans-serif;
    background:var(--bg-black);color:var(--text-main);
    margin:0;padding:0 15px 100px;
}
.card{
    background:var(--card-bg);border-radius:16px;
    padding:16px;margin-bottom:12px;
}
.screen{display:none;}
.screen.active{display:block;}
.nav-bar{
    position:fixed;bottom:0;left:0;right:0;
    background:#111;display:flex;padding:10px 0 25px;
}
.nav-item{flex:1;text-align:center;color:var(--text-gray);}
.nav-item.active{color:var(--tiffany);}
input,select{
    width:100%;background:#1c1c1e;color:#fff;
    border:1px solid #333;border-radius:10px;
    padding:12px;margin-top:8px;
}
button{
    background:var(--tiffany);border:none;border-radius:10px;
    padding:12px;font-weight:bold;
}
code{color:var(--tiffany);}
</style>
</head>

<body>

<div id="screen-home" class="screen active">
    <h2>Drop</h2>
    <div class="card">
        <div style="color:var(--text-gray)">–ë–æ–Ω—É—Å</div>
        <div id="bonus" style="font-size:28px">0 –∫–≥</div>
    </div>
</div>

<div id="screen-pkgs" class="screen">
    <h2>–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</h2>
    <div id="orders"></div>

    <div class="card">
        <input id="track-input" placeholder="–¢—Ä–µ–∫ –Ω–æ–º–µ—Ä">
        <input id="desc-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        <button onclick="addTrack()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div id="screen-profile" class="screen">
    <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
    <div class="card">
        <div>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
        <button onclick="setCat('less_100')">–î–æ 100 –∫–≥</button>
        <button onclick="setCat('more_100')">–û—Ç 100 –∫–≥</button>
    </div>
    <div class="card">
        <select id="pvz" onchange="updatePvz()"></select>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="nav('home')">üè†</div>
    <div class="nav-item" onclick="nav('pkgs')">üì¶</div>
    <div class="nav-item" onclick="nav('profile')">‚öôÔ∏è</div>
</nav>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API_BASE = "https://unforeshortened-interartistic-judith.ngrok-free.dev"; 
const userId = tg.initDataUnsafe?.user?.id || 317295540; 

let userData = { packages: [] };

async function init(){
    const r = await fetch(`${API_BASE}/api/dashboard/${userId}`);
    const d = await r.json();
    if(d.status === 'ok'){
        userData = d;
        render();
    }
}
init();

function render(){
    document.getElementById('bonus').innerText =
        (userData.user_info?.bonus_balance || 0) + " –∫–≥";

    renderOrders();

    const pvzSel = document.getElementById('pvz');
    pvzSel.innerHTML = '';
    (userData.pvz_list || []).forEach(p=>{
        const o = document.createElement('option');
        o.value = p; o.text = p;
        pvzSel.add(o);
    });
}

function renderOrders(){
    const c = document.getElementById('orders');
    c.innerHTML = '';
    if(!userData.packages.length){
        c.innerHTML = '<div class="card">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
        return;
    }
    userData.packages.forEach(p=>{
        c.innerHTML += `
        <div class="card">
            <div><b>${p.track_number}</b></div>
            <div>${p.status_text}</div>
        </div>`;
    });
}

async function addTrack(){
    const track = document.getElementById('track-input').value.trim();
    const desc = document.getElementById('desc-input').value.trim();

    if(!track){
        tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫ –Ω–æ–º–µ—Ä");
        return;
    }

    const r = await fetch(`${API_BASE}/api/packages`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            user_id:userId,
            track_number:track,
            description:desc
        })
    });

    const d = await r.json();

    if(d.status === 'exists'){
        tg.showAlert("–≠—Ç–æ—Ç —Ç—Ä–µ–∫ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω");
        return;
    }

    if(d.status === 'ok'){
        document.getElementById('track-input').value='';
        document.getElementById('desc-input').value='';
        init();
    }
}

async function setCat(cat){
    await fetch(`${API_BASE}/api/update_settings`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({user_id:userId,category:cat})
    });
    init();
}

async function updatePvz(){
    const val = document.getElementById('pvz').value;
    await fetch(`${API_BASE}/api/update_settings`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({user_id:userId,pvz:val})
    });
    init();
}

function nav(s){
    document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
    document.getElementById('screen-'+s).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
}
</script>

</body>
</html>
