<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop Logistics</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ЖЕЛЕЗОБЕТОННЫЕ ЦВЕТА (БЕЗ ПЕРЕМЕННЫХ) --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F2F2F7; /* Светло-серый фон всегда */
            color: #000000; /* Черный текст всегда */
            margin: 0; padding: 0 0 120px 0;
            -webkit-tap-highlight-color: transparent;
        }

        .container { padding: 0 16px; max-width: 600px; margin: 0 auto; }

        /* HEADER */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
        h1 { margin: 0; font-size: 24px; font-weight: 800; color: #000; }
        
        /* КАРТОЧКИ */
        .card { 
            background: #FFFFFF; /* Белый фон карточек */
            border-radius: 20px; 
            padding: 20px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* КНОПКИ */
        .btn-main { 
            background: #1ae2c7; /* Тиффани */
            color: #000; 
            width: 100%; padding: 16px; border-radius: 16px; border: none; 
            font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; 
        }
        .btn-main:active { opacity: 0.8; transform: scale(0.98); }

        /* ИНПУТЫ */
        input, select { 
            background: #F2F2F7; 
            border: 1px solid transparent; 
            color: #000; 
            padding: 16px; border-radius: 14px; 
            width: 100%; box-sizing: border-box; 
            font-size: 15px; outline: none; margin-bottom: 10px; 
            font-family: 'Inter', sans-serif;
        }
        input::placeholder { color: #8E8E93; }

        /* ПЕРЕКЛЮЧАТЕЛЬ */
        .switcher { background: #F2F2F7; padding: 4px; border-radius: 14px; display: flex; margin-bottom: 15px; }
        .sw-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; background: transparent; color: #8E8E93; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .sw-btn.active { background: #FFFFFF; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* НИЖНИЙ БАР */
        .dock-container { position: fixed; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; z-index: 1000; }
        .dock { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 30px; 
            padding: 12px 25px; 
            display: flex; gap: 30px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dock-item { display: flex; flex-direction: column; align-items: center; color: #8E8E93; cursor: pointer; transition: 0.3s; width: 50px; }
        .dock-icon { font-size: 24px; margin-bottom: 4px; }
        .dock-label { font-size: 10px; font-weight: 600; }
        
        .dock-item.active { color: #1ae2c7; transform: translateY(-2px); }
        .dock-item.active .dock-label { color: #000; }

        /* ТЕКСТЫ */
        .text-dim { font-size: 12px; color: #8E8E93; }
        .text-val { font-size: 18px; font-weight: 700; color: #000; margin-top: 4px; }

        /* ПРОФИЛЬ */
        .avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 10px; background: #eee; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); object-fit: cover; }
        .copy-pill { display: inline-flex; align-items: center; gap: 8px; background: rgba(26, 226, 199, 0.15); color: #00AA95; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 10px; }

        /* СТАТУСЫ */
        .status-pill { font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 6px; }
        .st-green { color: #00aa00; background: rgba(0, 255, 0, 0.1); }
        .st-gray { color: #8E8E93; background: #F2F2F7; }

        /* FAB */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: #1ae2c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; font-size: 24px; box-shadow: 0 4px 15px rgba(26, 226, 199, 0.4); cursor: pointer; z-index: 900; }
        
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: flex-end; }
        .modal-overlay.active { display: flex; animation: slideUp 0.3s; }
        .modal-box { background: #fff; width: 100%; border-radius: 24px 24px 0 0; padding: 30px 20px 50px 20px; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* ЭКРАНЫ */
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="app-header">
            <h1>Drop Eco</h1>
        </div>
    </div>

    <div id="fab-add" class="fab" style="display: none;" onclick="openModal()">
        <i class="fa-solid fa-plus"></i>
    </div>

    <div id="add-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="margin-top:0; color: #000;">Новая посылка</h2>
            <input type="text" id="new-track" placeholder="Трек-номер (напр. YT12345)">
            <input type="text" id="new-desc" placeholder="Описание (напр. Часы)">
            <button class="btn-main" onclick="submitTrack()">Добавить</button>
            <div style="text-align:center; margin-top:15px; color:#8E8E93; cursor:pointer;" onclick="closeModal()">Отмена</div>
        </div>
    </div>

    <div id="screen-calc" class="screen active">
        <div class="container">
            <div class="card">
                <div class="switcher">
                    <button id="cat-less" class="sw-btn active" onclick="setCat('less_100')">Розница</button>
                    <button id="cat-more" class="sw-btn" onclick="setCat('more_100')">Опт</button>
                </div>

                <div id="calc-route-box" style="display: none;">
                    <select id="calc-route"><option>Загрузка...</option></select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="number" id="c-l" placeholder="Дл" class="opt-only" style="display:none">
                    <input type="number" id="c-w" placeholder="Шир" class="opt-only" style="display:none">
                    <input type="number" id="c-h" placeholder="Выс" class="opt-only" style="display:none">
                    <input type="number" id="c-weight" placeholder="Вес (кг)" style="grid-column: span 2;">
                    <input type="number" id="c-qty" placeholder="Кол-во" value="1" style="grid-column: span 2;">
                </div>

                <div id="retail-info" style="margin-top: 10px; font-size: 13px; color: #8E8E93; line-height: 1.5;">
                    <div>до 0.5 кг — <b>13 TJS</b></div>
                    <div>0.5 - 1 кг — <b>23 TJS</b></div>
                    <div>1 - 50 кг — <b>23 TJS/кг</b></div>
                    <div>> 50 кг — <b>20 TJS/кг</b></div>
                </div>

                <div id="calc-result-box" style="display: none; margin-top: 15px; background: #F2F2F7; padding: 15px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 12px; color: #8E8E93;">Стоимость</div>
                    <div style="font-size: 24px; font-weight: 800; color: #1ae2c7;">
                        <span id="res-price">0.00</span> <span id="res-currency" style="font-size: 16px; color: #000;">TJS</span>
                    </div>
                </div>

                <button class="btn-main" onclick="calculateServer()">Рассчитать</button>
            </div>
        </div>
    </div>

    <div id="screen-pkgs" class="screen">
        <div class="container">
            <div style="margin-bottom: 15px; font-weight: 700; font-size: 18px; color: #000;">Мои посылки</div>
            <div id="orders-container">
                <div style="text-align: center; padding: 40px; color: #8E8E93;">Загрузка посылок...</div>
            </div>
        </div>
    </div>

    <div id="screen-trucks" class="screen">
        <div class="container">
            <div class="card">
                <h2 style="margin-top:0; color: #000;">Биржа грузов</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-main" style="background: #7B61FF; color: white; margin-top:0;">Найти машину</button>
                    <button class="btn-main" style="background: transparent; border: 1px solid #ddd; color: #000; margin-top:0;">Водитель</button>
                </div>
            </div>
            <div class="card" style="border-left: 4px solid #7B61FF;">
                <div style="font-weight: 700; color: #000;">Душанбе ➝ Худжанд</div>
                <div class="text-dim">Завтра • Mercedes Sprinter</div>
                <div style="margin-top: 8px; font-weight: 700; color: #00D68F;">2.5 TJS / кг</div>
            </div>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="container">
            <div class="card" style="text-align: center;">
                <img id="user-avatar" class="avatar" src="" alt="">
                <h2 id="user-name" style="margin: 10px 0 5px; color: #000;">Загрузка...</h2>
                <div id="user-id" class="text-dim">ID: ...</div>
                <div class="copy-pill" onclick="copyMarking()">
                    <span id="marking-text" style="color: #00AA95;">C-87...</span> <i class="fa-regular fa-copy"></i>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <b style="color: #000;">Адрес склада</b>
                    <span style="color: #1ae2c7; font-size: 12px; font-weight: 600; cursor:pointer;" onclick="toggleAddressType()" id="addr-switch-label">Включить ОПТ</span>
                </div>
                
                <div id="retail-block">
                    <div onclick="copyRetailAddr()" style="cursor: pointer;">
                        <div class="text-dim">ИУ (РОЗНИЦА)</div>
                        <div id="yiwu-retail-text" style="font-family: monospace; font-size: 13px; margin-top: 5px; color: #000;">Загрузка...</div>
                    </div>
                </div>

                <div id="wholesale-block" style="display: none;">
                    <select id="origin-city-select" onchange="renderWholesaleAddress()" style="margin-bottom: 10px; padding: 10px;">
                        <option value="yiwu">Иу (Yiwu)</option>
                        <option value="urumqi">Урумчи (Urumqi)</option>
                    </select>
                    <div onclick="copyWholesaleAddr()" style="cursor: pointer;">
                        <div class="text-dim">ОПТОВЫЙ СКЛАД</div>
                        <div id="wholesale-addr-text" style="font-family: monospace; font-size: 13px; margin-top: 5px; color: #000;">--</div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div class="text-dim">Ваш ПВЗ</div>
                <div style="font-weight: 600; color: #000;" id="profile-pvz">...</div>
            </div>
        </div>
    </div>

    <div class="dock-container">
        <div class="dock">
            <div class="dock-item active" onclick="nav('calc', this)">
                <i class="dock-icon fa-solid fa-calculator"></i>
                <div class="dock-label">Расчет</div>
            </div>
            <div class="dock-item" onclick="nav('pkgs', this)">
                <i class="dock-icon fa-solid fa-box"></i>
                <div class="dock-label">Посылки</div>
            </div>
            <div class="dock-item" onclick="nav('trucks', this)">
                <i class="dock-icon fa-solid fa-truck-fast"></i>
                <div class="dock-label">Биржа</div>
            </div>
            <div class="dock-item" onclick="nav('profile', this)">
                <i class="dock-icon fa-regular fa-user"></i>
                <div class="dock-label">Профиль</div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // ⚠️⚠️⚠️ ССЫЛКА NGROK ⚠️⚠️⚠️
        const API_BASE = "https://unforeshortened-interartistic-judith.ngrok-free.dev"; 

        const userId = tg.initDataUnsafe?.user?.id || 317295540; 
        const userPhoto = tg.initDataUnsafe?.user?.photo_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

        let APP_CONFIG = { rates: {}, warehouses: { retail: {}, wholesale: {} } };
        let userData = { category: 'less_100', pvz: '...', bonus: 0, packages: [], marking: '...', name: 'User' };
        let showWholesaleAddr = false;

        async function init() {
            document.getElementById('user-avatar').src = userPhoto;
            loadRoutes();
            try {
                const response = await fetch(`${API_BASE}/api/dashboard/${userId}`, { method: 'GET', headers: { 'ngrok-skip-browser-warning': 'true' } });
                const data = await response.json();
                if (data.app_config) APP_CONFIG = data.app_config;
                if (data.user_info) {
                    userData = { ...userData, ...data.user_info, packages: data.packages || [], name: tg.initDataUnsafe?.user?.first_name || "Клиент" };
                }
                render();
            } catch (e) { console.error(e); }
        }

        async function loadRoutes() {
            try {
                const res = await fetch(`${API_BASE}/api/get_routes`, {headers: { 'ngrok-skip-browser-warning': 'true' }});
                const data = await res.json();
                if(data.status === 'ok') {
                    const select = document.getElementById('calc-route');
                    select.innerHTML = '<option>Выберите маршрут...</option>';
                    data.routes.forEach(r => {
                        const opt = document.createElement('option'); opt.value = r; opt.innerText = r; select.appendChild(opt);
                    });
                }
            } catch(e) {}
        }

        function render() {
            document.getElementById('user-name').innerText = userData.name;
            document.getElementById('user-id').innerText = `ID: ${userId}`;
            document.getElementById('marking-text').innerText = userData.marking;
            document.getElementById('profile-pvz').innerText = userData.pvz;

            renderAddressBlock();

            const isOpt = userData.category === 'more_100';
            document.getElementById('cat-less').classList.toggle('active', !isOpt);
            document.getElementById('cat-more').classList.toggle('active', isOpt);
            document.getElementById('calc-route-box').style.display = isOpt ? 'block' : 'none';
            document.getElementById('retail-info').style.display = isOpt ? 'none' : 'block';
            document.querySelectorAll('.opt-only').forEach(el => el.style.display = isOpt ? 'block' : 'none');

            renderPackagesList();
        }

        function renderPackagesList() {
            const cont = document.getElementById('orders-container');
            cont.innerHTML = '';
            if(!userData.packages || userData.packages.length === 0) {
                cont.innerHTML = '<div style="text-align:center; color:#8E8E93; padding:40px;">История пуста.<br>Нажмите +, чтобы добавить трек.</div>';
            } else {
                userData.packages.forEach(p => {
                    let stClass = 'st-gray';
                    if(p.status_text.includes('Прибыл') || p.status_text.includes('Готов')) stClass = 'st-green';
                    
                    cont.innerHTML += `
                        <div class="card" style="padding: 15px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:600; font-size:15px; color:#000;">${p.description || 'Посылка'}</div>
                                <div style="font-family:monospace; color:#8E8E93; font-size:13px; margin-top:4px;">${p.track_number}</div>
                            </div>
                            <div style="text-align:right;">
                                <div class="status-pill ${stClass}">${p.status_text}</div>
                                <div style="font-size:10px; color:#8E8E93; margin-top:4px;">${p.date}</div>
                            </div>
                        </div>`;
                });
            }
        }

        function toggleAddressType() {
            showWholesaleAddr = !showWholesaleAddr;
            document.getElementById('addr-switch-label').innerText = showWholesaleAddr ? "Вернуть РОЗНИЦУ" : "Включить ОПТ";
            renderAddressBlock();
        }

        function renderAddressBlock() {
            const retailDiv = document.getElementById('retail-block');
            const wholesaleDiv = document.getElementById('wholesale-block');
            if(showWholesaleAddr) {
                retailDiv.style.display = 'none'; wholesaleDiv.style.display = 'block'; renderWholesaleAddress();
            } else {
                retailDiv.style.display = 'block'; wholesaleDiv.style.display = 'none';
                const addr = APP_CONFIG.warehouses?.retail?.address;
                document.getElementById('yiwu-retail-text').innerText = addr ? addr : "Загрузка...";
            }
        }

        function renderWholesaleAddress() {
            const city = document.getElementById('origin-city-select').value;
            const wh = APP_CONFIG.warehouses?.wholesale?.[city];
            document.getElementById('wholesale-addr-text').innerText = wh ? wh.address : "Нет данных";
        }

        async function calculateServer() {
            const btn = document.querySelector('button[onclick="calculateServer()"]');
            const resBox = document.getElementById('calc-result-box');
            btn.innerText = "..."; btn.disabled = true;

            const payload = {
                user_id: userId, category: userData.category,
                weight_per_item: parseFloat(document.getElementById('c-weight').value) || 0,
                quantity: parseInt(document.getElementById('c-qty').value) || 1
            };

            if (userData.category === 'more_100') {
                const routeFull = document.getElementById('calc-route').value;
                const parts = routeFull.split(" - ");
                if (parts.length < 2) { tg.showAlert("Выберите маршрут!"); btn.innerText = "Рассчитать"; btn.disabled = false; return; }
                payload.route_from = parts[0]; payload.route_to = parts[1];
                payload.length = parseFloat(document.getElementById('c-l').value) || 0;
                payload.width = parseFloat(document.getElementById('c-w').value) || 0;
                payload.height = parseFloat(document.getElementById('c-h').value) || 0;
            }

            try {
                const response = await fetch(`${API_BASE}/api/calculate`, { method: 'POST', headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'}, body: JSON.stringify(payload) });
                const result = await response.json();
                if(result.status === 'ok') {
                    document.getElementById('res-price').innerText = result.price.toFixed(2);
                    resBox.style.display = 'block';
                } else { tg.showAlert(result.message); }
            } catch (e) { tg.showAlert("Ошибка сети"); } 
            finally { btn.innerText = "Рассчитать"; btn.disabled = false; }
        }

        async function setCat(cat) {
            tg.HapticFeedback.selectionChanged();
            userData.category = cat; render();
            fetch(`${API_BASE}/api/update_settings`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: userId, category: cat }) });
        }

        function nav(screenId, el) {
            document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenId).classList.add('active');
            tg.HapticFeedback.impactOccurred('light');

            const fab = document.getElementById('fab-add');
            if(screenId === 'pkgs') fab.style.display = 'flex';
            else fab.style.display = 'none';
        }

        function openModal() { document.getElementById('add-modal').classList.add('active'); tg.HapticFeedback.impactOccurred('medium'); }
        function closeModal() { document.getElementById('add-modal').classList.remove('active'); }
        
        async function submitTrack() {
            const track = document.getElementById('new-track').value;
            const desc = document.getElementById('new-desc').value;
            if(!track) return tg.showAlert("Введите трек!");
            try {
                const res = await fetch(`${API_BASE}/api/add_track`, { method: 'POST', headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'}, body: JSON.stringify({ user_id: userId, track_number: track, description: desc }) });
                const r = await res.json();
                if(r.status === 'ok') { tg.showAlert("Успешно!"); closeModal(); init(); } else tg.showAlert(r.message);
            } catch(e) {}
        }

        function copyMarking() { navigator.clipboard.writeText(document.getElementById('marking-text').innerText).then(() => tg.HapticFeedback.notificationOccurred('success')); }
        function copyRetailAddr() { navigator.clipboard.writeText(document.getElementById('yiwu-retail-text').innerText).then(() => tg.HapticFeedback.notificationOccurred('success')); }
        function copyWholesaleAddr() { navigator.clipboard.writeText(document.getElementById('wholesale-addr-text').innerText).then(() => tg.HapticFeedback.notificationOccurred('success')); }

        init();
    </script>
</body>
</html>
