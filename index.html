<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop Ecosystem</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-dark: #080a10; 
            --glass: rgba(22, 27, 38, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #23F7DD; /* Tiffany Neon */
            --primary-glow: rgba(35, 247, 221, 0.25);
            --accent-purple: #7B61FF;
            --text-main: #ffffff; 
            --text-gray: #828a9a;
            --danger: #FF4B55;
            --success: #00D68F;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark); 
            /* –§–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –∫–∞–∫ –≤ xPortal */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(35, 247, 221, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(123, 97, 255, 0.08) 0%, transparent 40%);
            color: var(--text-main); 
            margin: 0; padding: 0 0 120px 0; 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden; 
            min-height: 100vh;
        }

        /* --- UI COMPONENTS --- */
        .container { padding: 0 16px; }
        
        /* –°—Ç–µ–∫–ª–æ–º–æ—Ä—Ñ–∏–∑–º –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .glass-card { 
            background: var(--glass); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px; 
            padding: 20px; 
            margin-bottom: 12px; 
            position: relative;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        h1 { font-size: 26px; font-weight: 800; margin: 24px 0 16px 0; letter-spacing: -0.5px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .section-title { font-size: 18px; font-weight: 700; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            background: var(--primary);
            color: #080a10;
            border: none;
            border-radius: 14px;
            padding: 14px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 15px var(--primary-glow);
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-outline { background: transparent; border: 1px solid var(--glass-border); color: var(--text-gray); box-shadow: none; }
        
        /* Inputs */
        input, select {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white;
            padding: 14px; border-radius: 14px; width: 100%; box-sizing: border-box; outline: none;
            font-family: 'Inter', sans-serif; font-size: 14px; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 10px var(--primary-glow); }

        /* --- NAVIGATION DOCK (FLOATING) --- */
        .dock-container {
            position: fixed; bottom: 20px; left: 16px; right: 16px;
            z-index: 1000;
        }
        .dock {
            background: rgba(18, 22, 31, 0.85);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 28px;
            display: flex; justify-content: space-between;
            padding: 12px 6px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .dock-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #5c6375; text-decoration: none; transition: 0.3s;
            position: relative;
        }
        .dock-icon { font-size: 22px; margin-bottom: 4px; transition: 0.3s; }
        .dock-label { font-size: 10px; font-weight: 600; opacity: 0; transform: translateY(10px); transition: 0.3s; }
        
        /* –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
        .dock-item.active { color: var(--primary); }
        .dock-item.active .dock-icon { transform: translateY(-2px); text-shadow: 0 0 15px var(--primary-glow); }
        .dock-item.active .dock-label { opacity: 1; transform: translateY(0); }

        /* --- SCREENS --- */
        .screen { display: none; animation: fadeUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .screen.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MODULE: TRUCKING (–ë–ò–†–ñ–ê) --- */
        .trip-card {
            display: flex; flex-direction: column; gap: 10px;
            border-left: 3px solid var(--accent-purple);
        }
        .trip-route { display: flex; align-items: center; gap: 10px; font-size: 16px; font-weight: 700; }
        .trip-arrow { color: var(--text-gray); font-size: 12px; }
        .trip-meta { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-gray); }
        .trip-price { color: var(--success); font-weight: 700; font-size: 14px; }
        
        /* --- MODULE: MARKET --- */
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .product-card { padding: 10px; border-radius: 18px; }
        .prod-img { width: 100%; height: 100px; background: #222; border-radius: 12px; margin-bottom: 8px; object-fit: cover; }
        .prod-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .prod-price { color: var(--primary); font-weight: 800; font-size: 14px; }

        /* --- MODULE: CHINA (OLD STYLES ADAPTED) --- */
        .switcher { display: flex; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 16px; margin-bottom: 15px; }
        .sw-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-gray); border-radius: 12px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .sw-btn.active { background: rgba(35, 247, 221, 0.1); color: var(--primary); }
        .calc-res { text-align: center; margin-top: 15px; }
        .calc-res span { font-size: 28px; font-weight: 800; color: var(--primary); text-shadow: 0 0 20px var(--primary-glow); }

        /* --- PROFILE --- */
        .profile-head { text-align: center; margin-bottom: 30px; }
        .avatar { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--primary); padding: 4px; margin: 0 auto 10px; }
        .avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .stat-row { display: flex; justify-content: space-between; background: rgba(255,255,255,0.03); border-radius: 16px; padding: 15px; margin-bottom: 20px; }
        .stat-col { text-align: center; flex: 1; }
        .stat-val { font-size: 18px; font-weight: 800; color: white; }
        .stat-lbl { font-size: 10px; color: var(--text-gray); text-transform: uppercase; margin-top: 4px; }

        /* Helpers */
        .text-dim { color: var(--text-gray); font-size: 12px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div id="screen-china" class="screen active">
        <div class="container">
            <div class="section-header" style="margin-top: 20px;">
                <h1>–ú–æ–π –ö–∏—Ç–∞–π</h1>
                <div style="font-size: 24px;">üá®üá≥</div>
            </div>

            <div class="glass-card">
                <div class="switcher">
                    <button id="cat-less" class="sw-btn active" onclick="setCat('less_100')">–†–æ–∑–Ω–∏—Ü–∞</button>
                    <button id="cat-more" class="sw-btn" onclick="setCat('more_100')">–û–ø—Ç</button>
                </div>

                <div id="calc-route-box" style="margin-bottom: 10px; display: none;">
                    <select id="calc-route"><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="number" id="c-l" placeholder="–î–ª–∏–Ω–∞" class="opt-only" style="display:none">
                    <input type="number" id="c-w" placeholder="–®–∏—Ä–∏–Ω–∞" class="opt-only" style="display:none">
                    <input type="number" id="c-h" placeholder="–í—ã—Å–æ—Ç–∞" class="opt-only" style="display:none">
                    <input type="number" id="c-weight" placeholder="–í–µ—Å (–∫–≥)" style="grid-column: span 2;">
                    <input type="number" id="c-qty" placeholder="–ö–æ–ª-–≤–æ" value="1" style="grid-column: span 2;">
                </div>

                <div id="retail-info" class="text-dim" style="margin-top: 10px; line-height: 1.5;">
                    üì¶ –¢–∞—Ä–∏—Ñ—ã: –¥–æ 0.5–∫–≥ - 13—Å, –¥–æ 1–∫–≥ - 23—Å, –¥–∞–ª–µ–µ 23—Å/–∫–≥.
                </div>

                <div id="calc-result-box" class="calc-res" style="display: none;">
                    <span id="res-price">0.00</span> <span style="font-size: 16px;">TJS</span>
                </div>

                <button class="btn" style="margin-top: 15px;" onclick="calculateServer()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            </div>

            <div class="section-header">
                <div class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Å—ã–ª–∫–∏</div>
                <div class="text-dim" onclick="alert('–ò—Å—Ç–æ—Ä–∏—è')">–í—Å–µ</div>
            </div>
            <div id="orders-container">
                <div style="text-align: center; color: #555; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <div id="screen-trucks" class="screen">
        <div class="container">
            <div class="section-header" style="margin-top: 20px;">
                <h1>–ë–∏—Ä–∂–∞</h1>
                <div style="background: var(--accent-purple); width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">üöõ</div>
            </div>

            <div class="glass-card">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn" style="background: var(--accent-purple); color: white;">–ù–∞–π—Ç–∏ –º–∞—à–∏–Ω—É</button>
                    <button class="btn btn-outline">–Ø –≤–æ–¥–∏—Ç–µ–ª—å</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" placeholder="–û—Ç–∫—É–¥–∞">
                    <input type="text" placeholder="–ö—É–¥–∞">
                </div>
            </div>

            <div class="section-title" style="margin-bottom: 10px;">–ë–ª–∏–∂–∞–π—à–∏–µ —Ä–µ–π—Å—ã</div>

            <div class="glass-card trip-card">
                <div class="trip-route">–î—É—à–∞–Ω–±–µ <i class="fa-solid fa-arrow-right trip-arrow"></i> –•—É–¥–∂–∞–Ω–¥</div>
                <div class="text-dim"><i class="fa-regular fa-clock"></i> –í—ã–µ–∑–¥: –ó–∞–≤—Ç—Ä–∞, 08:00</div>
                <div class="trip-meta">
                    <span><i class="fa-solid fa-truck-pickup"></i> Mercedes Sprinter</span>
                    <span class="trip-price">2.5 TJS/–∫–≥</span>
                </div>
                <div style="margin-top: 5px;">
                    <span class="badge" style="color: var(--success);">–°–≤–æ–±–æ–¥–Ω–æ 1200 –∫–≥</span>
                </div>
            </div>

            <div class="glass-card trip-card">
                <div class="trip-route">–¢–∞—à–∫–µ–Ω—Ç <i class="fa-solid fa-arrow-right trip-arrow"></i> –ù–∞–º–∞–Ω–≥–∞–Ω</div>
                <div class="text-dim"><i class="fa-regular fa-clock"></i> –í—ã–µ–∑–¥: 25 —è–Ω–≤</div>
                <div class="trip-meta">
                    <span><i class="fa-solid fa-truck"></i> –§—É—Ä–∞ (–¢–µ–Ω—Ç)</span>
                    <span class="trip-price">–î–æ–≥–æ–≤–æ—Ä–Ω–∞—è</span>
                </div>
                <div style="margin-top: 5px;">
                    <span class="badge" style="color: #FFB02E;">–í—Å—è –º–∞—à–∏–Ω–∞</span>
                </div>
            </div>

        </div>
    </div>

    <div id="screen-market" class="screen">
        <div class="container">
            <div class="section-header" style="margin-top: 20px;">
                <h1>–ú–∞—Ä–∫–µ—Ç</h1>
                <div style="background: #FFB02E; color: black; width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">üõç</div>
            </div>

            <div style="margin-bottom: 15px;">
                <input type="text" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
            </div>

            <div class="market-grid">
                <div class="glass-card product-card">
                    <img src="https://via.placeholder.com/150" class="prod-img">
                    <div class="prod-title">–°–º–∞—Ä—Ç-—á–∞—Å—ã Series 8 (–û–ø—Ç)</div>
                    <div class="prod-price">150 TJS</div>
                    <div class="text-dim">–ú–∏–Ω: 10 —à—Ç</div>
                </div>
                <div class="glass-card product-card">
                    <img src="https://via.placeholder.com/150" class="prod-img">
                    <div class="prod-title">–ö—Ä–æ—Å—Å–æ–≤–∫–∏ Nike Air (–ö–æ–ø–∏—è)</div>
                    <div class="prod-price">220 TJS</div>
                    <div class="text-dim">–í –Ω–∞–ª–∏—á–∏–∏</div>
                </div>
                <div class="glass-card product-card">
                    <img src="https://via.placeholder.com/150" class="prod-img">
                    <div class="prod-title">–ß–µ—Ö–ª—ã iPhone 15</div>
                    <div class="prod-price">15 TJS</div>
                    <div class="text-dim">–ú–∏–Ω: 50 —à—Ç</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="container">
            <div class="profile-head" style="margin-top: 40px;">
                <div class="avatar">
                    <img id="user-avatar" src="" alt="">
                </div>
                <h2 id="user-name">User Name</h2>
                <div class="text-dim" id="user-id">ID: 000</div>
                <div style="margin-top: 10px;">
                    <span class="badge" style="background: var(--primary-glow); color: var(--primary); font-size: 12px; padding: 6px 12px;" onclick="copyMarking()">
                        <span id="marking-text">C-87...</span> <i class="fa-regular fa-copy"></i>
                    </span>
                </div>
            </div>

            <div class="stat-row">
                <div class="stat-col">
                    <div class="stat-val" id="stat-weight">0</div>
                    <div class="stat-lbl">–ë–æ–Ω—É—Å—ã</div>
                </div>
                <div class="stat-col">
                    <div class="stat-val" id="stat-orders">0</div>
                    <div class="stat-lbl">–ó–∞–∫–∞–∑–æ–≤</div>
                </div>
                <div class="stat-col">
                    <div class="stat-val" style="color: var(--primary);">PRO</div>
                    <div class="stat-lbl">–°—Ç–∞—Ç—É—Å</div>
                </div>
            </div>

            <div class="glass-card">
                <div class="section-title" style="margin-bottom: 10px; font-size: 14px;">–ú–æ–∏ –ê–¥—Ä–µ—Å–∞</div>
                
                <div id="retail-block">
                    <div style="font-size: 10px; color: var(--primary); font-weight: 800; margin-bottom: 5px;">–ò–£ (–†–û–ó–ù–ò–¶–ê)</div>
                    <div style="font-family: monospace; font-size: 12px; line-height: 1.4; color: #ccc;" id="yiwu-retail-text" onclick="copyRetailAddr()">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>

                <div id="wholesale-block" style="display: none;">
                     <div style="margin-bottom: 5px;">
                        <select id="origin-city-select" style="padding: 6px;" onchange="renderWholesaleAddress()">
                            <option value="yiwu">–ò—É</option>
                            <option value="urumqi">–£—Ä—É–º—á–∏</option>
                        </select>
                    </div>
                    <div style="font-family: monospace; font-size: 12px; line-height: 1.4; color: #ccc;" id="wholesale-addr-text" onclick="copyWholesaleAddr()">...</div>
                </div>

                <div style="text-align: center; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 5px;">
                    <span style="font-size: 10px; color: var(--text-gray); cursor: pointer;" onclick="toggleAddressType()">
                        –°–º–µ–Ω–∏—Ç—å –Ω–∞ <span id="addr-switch-text" style="color: white;">–û–ü–¢</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="dock-container">
        <div class="dock">
            <div class="dock-item active" onclick="nav('china', this)">
                <i class="dock-icon fa-solid fa-earth-asia"></i>
                <div class="dock-label">–ö–∏—Ç–∞–π</div>
            </div>
            <div class="dock-item" onclick="nav('trucks', this)">
                <i class="dock-icon fa-solid fa-truck-fast"></i>
                <div class="dock-label">–ë–∏—Ä–∂–∞</div>
            </div>
            <div class="dock-item" onclick="nav('market', this)">
                <i class="dock-icon fa-solid fa-bag-shopping"></i>
                <div class="dock-label">–ú–∞—Ä–∫–µ—Ç</div>
            </div>
            <div class="dock-item" onclick="nav('profile', this)">
                <i class="dock-icon fa-regular fa-user"></i>
                <div class="dock-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–°–´–õ–ö–£ NGROK ‚ö†Ô∏è
        const API_BASE = "https://unforeshortened-interartistic-judith.ngrok-free.dev"; 
        
        const userId = tg.initDataUnsafe?.user?.id || 317295540; 
        const userPhoto = tg.initDataUnsafe?.user?.photo_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        
        let APP_CONFIG = { rates: {}, warehouses: { retail: {}, wholesale: {} } };
        let userData = { category: 'less_100', pvz: '...', bonus: 0, packages: [], marking: '...', name: 'User' };
        let showWholesaleAddr = false;

        // --- NAVIGATION LOGIC ---
        function nav(screenId, el) {
            // UI Update
            document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');

            // Screen Switch
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenId).classList.add('active');
            
            tg.HapticFeedback.impactOccurred('light');
        }

        // --- INIT & LOGIC (COPIED FROM PREVIOUS) ---
        async function init() {
            document.getElementById('user-avatar').src = userPhoto;
            loadRoutes();
            try {
                const response = await fetch(`${API_BASE}/api/dashboard/${userId}`, { method: 'GET', headers: { 'ngrok-skip-browser-warning': 'true' } });
                const data = await response.json();
                if (data.app_config) APP_CONFIG = data.app_config;
                if (data.user_info) {
                    userData = { ...userData, ...data.user_info, packages: data.packages || [] };
                    userData.name = tg.initDataUnsafe?.user?.first_name || "–ö–ª–∏–µ–Ω—Ç";
                }
                render();
            } catch (e) { console.error(e); }
        }

        async function loadRoutes() {
            try {
                const res = await fetch(`${API_BASE}/api/get_routes`, {headers: { 'ngrok-skip-browser-warning': 'true' }});
                const data = await res.json();
                if(data.status === 'ok') {
                    const select = document.getElementById('calc-route');
                    select.innerHTML = '<option>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...</option>';
                    data.routes.forEach(r => {
                        const opt = document.createElement('option'); opt.value = r; opt.innerText = r; select.appendChild(opt);
                    });
                }
            } catch(e) {}
        }

        function render() {
            // Profile
            document.getElementById('user-name').innerText = userData.name;
            document.getElementById('user-id').innerText = `ID: ${userId}`;
            document.getElementById('marking-text').innerText = userData.marking;
            document.getElementById('stat-weight').innerText = userData.bonus;
            document.getElementById('stat-orders').innerText = userData.packages.length;
            renderAddressBlock();

            // Calc
            const isOpt = userData.category === 'more_100';
            document.getElementById('cat-less').classList.toggle('active', !isOpt);
            document.getElementById('cat-more').classList.toggle('active', isOpt);
            document.getElementById('calc-route-box').style.display = isOpt ? 'block' : 'none';
            document.getElementById('retail-info').style.display = isOpt ? 'none' : 'block';
            document.querySelectorAll('.opt-only').forEach(el => el.style.display = isOpt ? 'block' : 'none');

            // Orders (In China Tab)
            const cont = document.getElementById('orders-container');
            cont.innerHTML = '';
            if(!userData.packages.length) {
                cont.innerHTML = '<div style="text-align:center;color:#555;padding:20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å—ã–ª–æ–∫</div>';
            } else {
                userData.packages.forEach(p => {
                    let stClass = 'color: #888';
                    if(p.status_text.includes('–ü—Ä–∏–±—ã–ª') || p.status_text.includes('–ì–æ—Ç–æ–≤')) stClass = 'color: var(--primary)';
                    
                    cont.innerHTML += `
                        <div class="glass-card" style="padding: 12px; margin-bottom: 8px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <div style="font-weight:700;">${p.description || '–ü–æ—Å—ã–ª–∫–∞'}</div>
                                <div style="font-size:10px; ${stClass}">${p.status_text}</div>
                            </div>
                            <div style="font-family:monospace; font-size:12px; color:var(--text-gray);">${p.track_number}</div>
                        </div>`;
                });
            }
        }

        // Logic Helpers
        function toggleAddressType() {
            showWholesaleAddr = !showWholesaleAddr;
            document.getElementById('addr-switch-text').innerText = showWholesaleAddr ? "–†–û–ó–ù–ò–¶–£" : "–û–ü–¢";
            renderAddressBlock();
        }
        function renderAddressBlock() {
            const retailDiv = document.getElementById('retail-block');
            const wholesaleDiv = document.getElementById('wholesale-block');
            if(showWholesaleAddr) {
                retailDiv.style.display = 'none'; wholesaleDiv.style.display = 'block'; renderWholesaleAddress();
            } else {
                retailDiv.style.display = 'block'; wholesaleDiv.style.display = 'none';
                document.getElementById('yiwu-retail-text').innerText = APP_CONFIG.warehouses.retail?.address || "...";
            }
        }
        function renderWholesaleAddress() {
            const city = document.getElementById('origin-city-select').value;
            const wh = APP_CONFIG.warehouses.wholesale?.[city];
            document.getElementById('wholesale-addr-text').innerText = wh ? wh.address : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
        }
        async function calculateServer() {
            const btn = document.querySelector('button[onclick="calculateServer()"]');
            const resBox = document.getElementById('calc-result-box');
            btn.innerText = "..."; btn.disabled = true;
            const payload = {
                user_id: userId, category: userData.category,
                weight_per_item: parseFloat(document.getElementById('c-weight').value) || 0,
                quantity: parseInt(document.getElementById('c-qty').value) || 1
            };
            if (userData.category === 'more_100') {
                const routeFull = document.getElementById('calc-route').value;
                const parts = routeFull.split(" - ");
                if (parts.length < 2) { tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç!"); btn.innerText = "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"; btn.disabled = false; return; }
                payload.route_from = parts[0]; payload.route_to = parts[1];
                payload.length = parseFloat(document.getElementById('c-l').value) || 0;
                payload.width = parseFloat(document.getElementById('c-w').value) || 0;
                payload.height = parseFloat(document.getElementById('c-h').value) || 0;
            }
            try {
                const response = await fetch(`${API_BASE}/api/calculate`, { method: 'POST', headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'}, body: JSON.stringify(payload) });
                const result = await response.json();
                if(result.status === 'ok') {
                    document.getElementById('res-price').innerText = result.price.toFixed(2);
                    // document.getElementById('res-currency').innerText = result.currency;
                    resBox.style.display = 'block';
                } else { tg.showAlert(result.message); }
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); } 
            finally { btn.innerText = "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"; btn.disabled = false; }
        }
        async function setCat(cat) {
            tg.HapticFeedback.selectionChanged();
            userData.category = cat; render();
            fetch(`${API_BASE}/api/update_settings`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: userId, category: cat }) });
        }
        function copyMarking() { navigator.clipboard.writeText(document.getElementById('marking-text').innerText).then(() => tg.HapticFeedback.notificationOccurred('success')); }
        function copyRetailAddr() { navigator.clipboard.writeText(document.getElementById('yiwu-retail-text').innerText).then(() => tg.HapticFeedback.notificationOccurred('success')); }
        function copyWholesaleAddr() { navigator.clipboard.writeText(document.getElementById('wholesale-addr-text').innerText).then(() => tg.HapticFeedback.notificationOccurred('success')); }

        init();
    </script>
</body>
</html>
